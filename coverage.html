
<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>repository: Go Coverage Report</title>
		<style>
			body {
				background: black;
				color: rgb(80, 80, 80);
			}
			body, pre, #legend span {
				font-family: Menlo, monospace;
				font-weight: bold;
			}
			#topbar {
				background: black;
				position: fixed;
				top: 0; left: 0; right: 0;
				height: 42px;
				border-bottom: 1px solid rgb(80, 80, 80);
			}
			#content {
				margin-top: 50px;
			}
			#nav, #legend {
				float: left;
				margin-left: 10px;
			}
			#legend {
				margin-top: 12px;
			}
			#nav {
				margin-top: 10px;
			}
			#legend span {
				margin: 0 5px;
			}
			.cov0 { color: rgb(192, 0, 0) }
.cov1 { color: rgb(128, 128, 128) }
.cov2 { color: rgb(116, 140, 131) }
.cov3 { color: rgb(104, 152, 134) }
.cov4 { color: rgb(92, 164, 137) }
.cov5 { color: rgb(80, 176, 140) }
.cov6 { color: rgb(68, 188, 143) }
.cov7 { color: rgb(56, 200, 146) }
.cov8 { color: rgb(44, 212, 149) }
.cov9 { color: rgb(32, 224, 152) }
.cov10 { color: rgb(20, 236, 155) }

		</style>
	</head>
	<body>
		<div id="topbar">
			<div id="nav">
				<select id="files">
				
				<option value="file0">Pulse/internal/repository/alert_repository.go (0.0%)</option>
				
				<option value="file1">Pulse/internal/repository/auth_repository.go (58.9%)</option>
				
				<option value="file2">Pulse/internal/repository/datasource_repository.go (0.0%)</option>
				
				<option value="file3">Pulse/internal/repository/knowledge_repository.go (0.0%)</option>
				
				<option value="file4">Pulse/internal/repository/manager.go (0.0%)</option>
				
				<option value="file5">Pulse/internal/repository/permission_repository.go (60.1%)</option>
				
				<option value="file6">Pulse/internal/repository/rule_repository.go (0.0%)</option>
				
				<option value="file7">Pulse/internal/repository/ticket_repository.go (0.0%)</option>
				
				<option value="file8">Pulse/internal/repository/user_repository.go (46.3%)</option>
				
				</select>
			</div>
			<div id="legend">
				<span>not tracked</span>
			
				<span class="cov0">not covered</span>
				<span class="cov8">covered</span>
			
			</div>
		</div>
		<div id="content">
		
		<pre class="file" id="file0" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"

        "Pulse/internal/models"
)

// alertRepository 告警仓储实现
type alertRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewAlertRepository 创建告警仓储实例
func NewAlertRepository(db *sqlx.DB) AlertRepository <span class="cov0" title="0">{
        return &amp;alertRepository{
                db: db,
        }
}</span>

// NewAlertRepositoryWithTx 创建带事务的告警仓储实例
func NewAlertRepositoryWithTx(tx *sqlx.Tx) AlertRepository <span class="cov0" title="0">{
        return &amp;alertRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *alertRepository) getExecutor() sqlx.ExtContext <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov0" title="0">return r.db</span>
}

// Create 创建告警
func (r *alertRepository) Create(ctx context.Context, alert *models.Alert) error <span class="cov0" title="0">{
        // 生成告警ID
        if alert.ID == "" </span><span class="cov0" title="0">{
                alert.ID = uuid.New().String()
        }</span>

        // 设置创建时间
        <span class="cov0" title="0">now := time.Now()
        alert.CreatedAt = now
        alert.UpdatedAt = now

        // 设置默认状态
        if alert.Status == "" </span><span class="cov0" title="0">{
                alert.Status = models.AlertStatusFiring
        }</span>

        // 序列化标签和注解
        <span class="cov0" title="0">labelsJSON, err := json.Marshal(alert.Labels)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">annotationsJSON, err := json.Marshal(alert.Annotations)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化注解失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO alerts (
                        id, rule_id, data_source_id, name, description, severity, status, source,
                        labels, annotations, value, threshold, expression, starts_at, ends_at,
                        last_evaluated_at, evaluation_count, fingerprint, generator_url,
                        silence_id, acked_by, acked_at, resolved_by, resolved_at,
                        created_at, updated_at
                ) VALUES (
                        :id, :rule_id, :data_source_id, :name, :description, :severity, :status, :source,
                        :labels, :annotations, :value, :threshold, :expression, :starts_at, :ends_at,
                        :last_evaluated_at, :evaluation_count, :fingerprint, :generator_url,
                        :silence_id, :acked_by, :acked_at, :resolved_by, :resolved_at,
                        :created_at, :updated_at
                )`

        // 创建用于数据库插入的结构体
        type alertDB struct {
                *models.Alert
                Labels      string `db:"labels"`
                Annotations string `db:"annotations"`
        }

        alertData := &amp;alertDB{
                Alert:       alert,
                Labels:      string(labelsJSON),
                Annotations: string(annotationsJSON),
        }

        _, err = r.db.NamedExecContext(ctx, query, alertData)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// CleanupResolved 清理已解决的告警
func (r *alertRepository) CleanupResolved(ctx context.Context, before time.Time) (int64, error) <span class="cov0" title="0">{
        query := `
                DELETE FROM alerts 
                WHERE status = $1 AND resolved_at &lt; $2`

        result, err := r.getExecutor().ExecContext(ctx, query, models.AlertStatusResolved, before)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理已解决告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理行数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return rowsAffected, nil</span>
}

// CleanupExpired 清理过期告警
func (r *alertRepository) CleanupExpired(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        query := `
                DELETE FROM alerts 
                WHERE ends_at IS NOT NULL AND ends_at &lt; NOW() - INTERVAL '7 days'`

        result, err := r.getExecutor().ExecContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理过期告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理行数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return rowsAffected, nil</span>
}

// GetActiveCount 获取活跃告警数量
func (r *alertRepository) GetActiveCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        query := `SELECT COUNT(*) FROM alerts WHERE status IN ('firing', 'pending') AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取活跃告警数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// GetCriticalCount 获取严重告警数量
func (r *alertRepository) GetCriticalCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        query := `SELECT COUNT(*) FROM alerts WHERE severity = 'critical' AND status IN ('firing', 'pending') AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取严重告警数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// GetByID 根据ID获取告警
func (r *alertRepository) GetByID(ctx context.Context, id string) (*models.Alert, error) <span class="cov0" title="0">{
        var alert models.Alert
        var labelsJSON, annotationsJSON string

        query := `
                SELECT id, rule_id, data_source_id, name, description, severity, status, source,
                       labels, annotations, value, threshold, expression, starts_at, ends_at,
                       last_eval_at, eval_count, fingerprint, generator_url,
                       silence_id, acked_by, acked_at, resolved_by, resolved_at,
                       created_at, updated_at, deleted_at
                FROM alerts 
                WHERE id = $1 AND deleted_at IS NULL`

        row := r.getExecutor().QueryRowxContext(ctx, query, id)
        err := row.Scan(
                &amp;alert.ID, &amp;alert.RuleID, &amp;alert.DataSourceID, &amp;alert.Name, &amp;alert.Description,
                &amp;alert.Severity, &amp;alert.Status, &amp;alert.Source, &amp;labelsJSON, &amp;annotationsJSON,
                &amp;alert.Value, &amp;alert.Threshold, &amp;alert.Expression, &amp;alert.StartsAt, &amp;alert.EndsAt,
                &amp;alert.LastEvalAt, &amp;alert.EvalCount, &amp;alert.Fingerprint, &amp;alert.GeneratorURL,
                &amp;alert.SilenceID, &amp;alert.AckedBy, &amp;alert.AckedAt, &amp;alert.ResolvedBy, &amp;alert.ResolvedAt,
                &amp;alert.CreatedAt, &amp;alert.UpdatedAt, &amp;alert.DeletedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("告警不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取告警失败: %w", err)</span>
        }

        // 反序列化标签和注解
        <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(labelsJSON), &amp;alert.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(annotationsJSON), &amp;alert.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化注解失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;alert, nil</span>
}

// Update 更新告警
func (r *alertRepository) Update(ctx context.Context, alert *models.Alert) error <span class="cov0" title="0">{
        alert.UpdatedAt = time.Now()

        // 序列化标签和注解
        labelsJSON, err := json.Marshal(alert.Labels)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">annotationsJSON, err := json.Marshal(alert.Annotations)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化注解失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE alerts SET 
                        rule_id = $1,
                        data_source_id = $2,
                        name = $3,
                        description = $4,
                        severity = $5,
                        status = $6,
                        source = $7,
                        labels = $8,
                        annotations = $9,
                        value = $10,
                        threshold = $11,
                        expression = $12,
                        starts_at = $13,
                        ends_at = $14,
                        last_eval_at = $15,
                        eval_count = $16,
                        fingerprint = $17,
                        generator_url = $18,
                        silence_id = $19,
                        acked_by = $20,
                        acked_at = $21,
                        resolved_by = $22,
                        resolved_at = $23,
                        updated_at = $24
                WHERE id = $25 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query,
                alert.RuleID, alert.DataSourceID, alert.Name, alert.Description,
                alert.Severity, alert.Status, alert.Source, string(labelsJSON), string(annotationsJSON),
                alert.Value, alert.Threshold, alert.Expression, alert.StartsAt, alert.EndsAt,
                alert.LastEvalAt, alert.EvalCount, alert.Fingerprint, alert.GeneratorURL,
                alert.SilenceID, alert.AckedBy, alert.AckedAt, alert.ResolvedBy, alert.ResolvedAt,
                alert.UpdatedAt, alert.ID,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Delete 硬删除告警
func (r *alertRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `DELETE FROM alerts WHERE id = $1`

        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// SoftDelete 软删除告警
func (r *alertRepository) SoftDelete(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE alerts SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// List 获取告警列表
func (r *alertRepository) List(ctx context.Context, filter *models.AlertFilter) (*models.AlertList, error) <span class="cov0" title="0">{
        if filter == nil </span><span class="cov0" title="0">{
                filter = &amp;models.AlertFilter{Page: 1, PageSize: 20}
        }</span>

        // 设置默认值
        <span class="cov0" title="0">if filter.Page &lt;= 0 </span><span class="cov0" title="0">{
                filter.Page = 1
        }</span>
        <span class="cov0" title="0">if filter.PageSize &lt;= 0 </span><span class="cov0" title="0">{
                filter.PageSize = 20
        }</span>
        <span class="cov0" title="0">if filter.PageSize &gt; 100 </span><span class="cov0" title="0">{
                filter.PageSize = 100
        }</span>

        // 构建查询条件
        <span class="cov0" title="0">var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter.RuleID != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("rule_id = $%d", argIndex))
                args = append(args, *filter.RuleID)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.DataSourceID != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("data_source_id = $%d", argIndex))
                args = append(args, *filter.DataSourceID)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Severity != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("severity = $%d", argIndex))
                args = append(args, *filter.Severity)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                args = append(args, *filter.Status)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Source != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("source = $%d", argIndex))
                args = append(args, *filter.Source)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                keyword := "%" + *filter.Keyword + "%"
                conditions = append(conditions, fmt.Sprintf("(name ILIKE $%d OR description ILIKE $%d)", argIndex, argIndex))
                args = append(args, keyword)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.StartTime != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("starts_at &gt;= $%d", argIndex))
                args = append(args, *filter.StartTime)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.EndTime != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("starts_at &lt;= $%d", argIndex))
                args = append(args, *filter.EndTime)
                argIndex++
        }</span>

        // 处理标签过滤
        <span class="cov0" title="0">if len(filter.Labels) &gt; 0 </span><span class="cov0" title="0">{
                for key, value := range filter.Labels </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("labels -&gt;&gt; $%d = $%d", argIndex, argIndex+1))
                        args = append(args, key, value)
                        argIndex += 2
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM alerts %s", whereClause)
        var total int64
        err := r.db.GetContext(ctx, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取告警总数失败: %w", err)
        }</span>

        // 获取告警列表
        <span class="cov0" title="0">offset := (filter.Page - 1) * filter.PageSize
        listQuery := fmt.Sprintf(`
                SELECT id, rule_id, data_source_id, name, description, severity, status, source,
                       labels, annotations, value, threshold, expression, starts_at, ends_at,
                       last_eval_at, eval_count, fingerprint, generator_url,
                       silence_id, acked_by, acked_at, resolved_by, resolved_at,
                       created_at, updated_at
                FROM alerts %s
                ORDER BY starts_at DESC
                LIMIT $%d OFFSET $%d`, whereClause, argIndex, argIndex+1)

        args = append(args, filter.PageSize, offset)

        rows, err := r.db.QueryContext(ctx, listQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取告警列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var alerts []*models.Alert
        for rows.Next() </span><span class="cov0" title="0">{
                var alert models.Alert
                var labelsJSON, annotationsJSON string

                err := rows.Scan(
                        &amp;alert.ID, &amp;alert.RuleID, &amp;alert.DataSourceID, &amp;alert.Name, &amp;alert.Description,
                        &amp;alert.Severity, &amp;alert.Status, &amp;alert.Source, &amp;labelsJSON, &amp;annotationsJSON,
                        &amp;alert.Value, &amp;alert.Threshold, &amp;alert.Expression, &amp;alert.StartsAt, &amp;alert.EndsAt,
                        &amp;alert.LastEvalAt, &amp;alert.EvalCount, &amp;alert.Fingerprint, &amp;alert.GeneratorURL,
                        &amp;alert.SilenceID, &amp;alert.AckedBy, &amp;alert.AckedAt, &amp;alert.ResolvedBy, &amp;alert.ResolvedAt,
                        &amp;alert.CreatedAt, &amp;alert.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描告警数据失败: %w", err)
                }</span>

                // 反序列化标签和注解
                <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(labelsJSON), &amp;alert.Labels)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(annotationsJSON), &amp;alert.Annotations)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化注解失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">alerts = append(alerts, &amp;alert)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历告警数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">totalPages := int((total + int64(filter.PageSize) - 1) / int64(filter.PageSize))

        return &amp;models.AlertList{
                Alerts:     alerts,
                Total:      total,
                Page:       filter.Page,
                PageSize:   filter.PageSize,
                TotalPages: totalPages,
        }, nil</span>
}

// Count 获取告警总数
func (r *alertRepository) Count(ctx context.Context, filter *models.AlertFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.RuleID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("rule_id = $%d", argIndex))
                        args = append(args, *filter.RuleID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.DataSourceID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("data_source_id = $%d", argIndex))
                        args = append(args, *filter.DataSourceID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Severity != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("severity = $%d", argIndex))
                        args = append(args, *filter.Severity)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Source != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("source = $%d", argIndex))
                        args = append(args, *filter.Source)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.StartTime != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("starts_at &gt;= $%d", argIndex))
                        args = append(args, *filter.StartTime)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.EndTime != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("starts_at &lt;= $%d", argIndex))
                        args = append(args, *filter.EndTime)
                        argIndex++
                }</span>

                // 处理标签过滤
                <span class="cov0" title="0">if len(filter.Labels) &gt; 0 </span><span class="cov0" title="0">{
                        for key, value := range filter.Labels </span><span class="cov0" title="0">{
                                conditions = append(conditions, fmt.Sprintf("labels -&gt;&gt; $%d = $%d", argIndex, argIndex+1))
                                args = append(args, key, value)
                                argIndex += 2
                        }</span>
                }
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM alerts %s", whereClause)
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取告警总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查告警是否存在
func (r *alertRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM alerts WHERE id = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查告警存在性失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// GetByFingerprint 根据指纹获取告警
func (r *alertRepository) GetByFingerprint(ctx context.Context, fingerprint string) (*models.Alert, error) <span class="cov0" title="0">{
        var alert models.Alert
        var labelsJSON, annotationsJSON string

        query := `
                SELECT id, rule_id, data_source_id, name, description, severity, status, source,
                       labels, annotations, value, threshold, expression, starts_at, ends_at,
                       last_eval_at, eval_count, fingerprint, generator_url,
                       silence_id, acked_by, acked_at, resolved_by, resolved_at,
                       created_at, updated_at, deleted_at
                FROM alerts 
                WHERE fingerprint = $1 AND deleted_at IS NULL`

        row := r.getExecutor().QueryRowxContext(ctx, query, fingerprint)
        err := row.Scan(
                &amp;alert.ID, &amp;alert.RuleID, &amp;alert.DataSourceID, &amp;alert.Name, &amp;alert.Description,
                &amp;alert.Severity, &amp;alert.Status, &amp;alert.Source, &amp;labelsJSON, &amp;annotationsJSON,
                &amp;alert.Value, &amp;alert.Threshold, &amp;alert.Expression, &amp;alert.StartsAt, &amp;alert.EndsAt,
                &amp;alert.LastEvalAt, &amp;alert.EvalCount, &amp;alert.Fingerprint, &amp;alert.GeneratorURL,
                &amp;alert.SilenceID, &amp;alert.AckedBy, &amp;alert.AckedAt, &amp;alert.ResolvedBy, &amp;alert.ResolvedAt,
                &amp;alert.CreatedAt, &amp;alert.UpdatedAt, &amp;alert.DeletedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("告警不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取告警失败: %w", err)</span>
        }

        // 反序列化标签和注解
        <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(labelsJSON), &amp;alert.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(annotationsJSON), &amp;alert.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化注解失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;alert, nil</span>
}

// Acknowledge 确认告警
func (r *alertRepository) Acknowledge(ctx context.Context, id, userID string, comment *string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE alerts SET 
                        status = $1,
                        acked_by = $2,
                        acked_at = $3,
                        updated_at = $3
                WHERE id = $4 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.AlertStatusAcked, userID, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("确认告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取确认结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        // 如果有评论，记录到历史中
        <span class="cov0" title="0">if comment != nil &amp;&amp; *comment != "" </span>{<span class="cov0" title="0">
                // 这里可以添加历史记录逻辑
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Resolve 解决告警
func (r *alertRepository) Resolve(ctx context.Context, id, userID string, comment *string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE alerts SET 
                        status = $1,
                        resolved_by = $2,
                        resolved_at = $3,
                        ends_at = $3,
                        updated_at = $3
                WHERE id = $4 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.AlertStatusResolved, userID, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("解决告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取解决结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        // 如果有评论，记录到历史中
        <span class="cov0" title="0">if comment != nil &amp;&amp; *comment != "" </span>{<span class="cov0" title="0">
                // 这里可以添加历史记录逻辑
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Silence 静默告警
func (r *alertRepository) Silence(ctx context.Context, id, silenceID string, duration time.Duration) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE alerts SET 
                        status = $1,
                        silence_id = $2,
                        updated_at = $3
                WHERE id = $4 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.AlertStatusSilenced, silenceID, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("静默告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取静默结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Unsilence 取消静默告警
func (r *alertRepository) Unsilence(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE alerts SET 
                        status = $1,
                        silence_id = NULL,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.AlertStatusFiring, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("取消静默告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取取消静默结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("告警不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetStats 获取告警统计信息
func (r *alertRepository) GetStats(ctx context.Context, filter *models.AlertFilter) (*models.AlertStats, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.RuleID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("rule_id = $%d", argIndex))
                        args = append(args, *filter.RuleID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.DataSourceID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("data_source_id = $%d", argIndex))
                        args = append(args, *filter.DataSourceID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.StartTime != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("starts_at &gt;= $%d", argIndex))
                        args = append(args, *filter.StartTime)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.EndTime != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("starts_at &lt;= $%d", argIndex))
                        args = append(args, *filter.EndTime)
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">totalQuery := fmt.Sprintf("SELECT COUNT(*) FROM alerts %s", whereClause)
        var total int64
        err := r.db.GetContext(ctx, &amp;total, totalQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取告警总数失败: %w", err)
        }</span>

        // 按严重级别统计
        <span class="cov0" title="0">bySeverityQuery := fmt.Sprintf(`
                SELECT severity, COUNT(*) 
                FROM alerts %s 
                GROUP BY severity`, whereClause)

        bySeverityRows, err := r.db.QueryContext(ctx, bySeverityQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按严重级别统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer bySeverityRows.Close()

        bySeverity := make(map[models.AlertSeverity]int64)
        for bySeverityRows.Next() </span><span class="cov0" title="0">{
                var severity models.AlertSeverity
                var count int64
                err := bySeverityRows.Scan(&amp;severity, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描严重级别统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">bySeverity[severity] = count</span>
        }

        // 按状态统计
        <span class="cov0" title="0">byStatusQuery := fmt.Sprintf(`
                SELECT status, COUNT(*) 
                FROM alerts %s 
                GROUP BY status`, whereClause)

        byStatusRows, err := r.db.QueryContext(ctx, byStatusQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按状态统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer byStatusRows.Close()

        byStatus := make(map[models.AlertStatus]int64)
        for byStatusRows.Next() </span><span class="cov0" title="0">{
                var status models.AlertStatus
                var count int64
                err := byStatusRows.Scan(&amp;status, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描状态统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">byStatus[status] = count</span>
        }

        // 按来源统计
        <span class="cov0" title="0">bySourceQuery := fmt.Sprintf(`
                SELECT source, COUNT(*) 
                FROM alerts %s 
                GROUP BY source`, whereClause)

        bySourceRows, err := r.db.QueryContext(ctx, bySourceQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按来源统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer bySourceRows.Close()

        bySource := make(map[models.AlertSource]int64)
        for bySourceRows.Next() </span><span class="cov0" title="0">{
                var source models.AlertSource
                var count int64
                err := bySourceRows.Scan(&amp;source, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描来源统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">bySource[source] = count</span>
        }

        <span class="cov0" title="0">return &amp;models.AlertStats{
                Total:      total,
                BySeverity: bySeverity,
                ByStatus:   byStatus,
                BySource:   bySource,
                Trend:      []*models.AlertTrendPoint{}, // 趋势数据需要单独实现
        }, nil</span>
}

// GetTrend 获取告警趋势数据
func (r *alertRepository) GetTrend(ctx context.Context, start, end time.Time, interval string) ([]*models.AlertTrendPoint, error) <span class="cov0" title="0">{
        conditions := []string{"deleted_at IS NULL", "starts_at &gt;= $1", "starts_at &lt;= $2"}
        args := []interface{}{start, end}

        whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 根据间隔类型构建时间分组
        <span class="cov0" title="0">var timeGroup string
        switch interval </span>{
        case "hour":<span class="cov0" title="0">
                timeGroup = "date_trunc('hour', starts_at)"</span>
        case "day":<span class="cov0" title="0">
                timeGroup = "date_trunc('day', starts_at)"</span>
        case "week":<span class="cov0" title="0">
                timeGroup = "date_trunc('week', starts_at)"</span>
        case "month":<span class="cov0" title="0">
                timeGroup = "date_trunc('month', starts_at)"</span>
        default:<span class="cov0" title="0">
                timeGroup = "date_trunc('hour', starts_at)"</span>
        }

        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT %s as timestamp, COUNT(*) as count
                FROM alerts %s
                GROUP BY %s
                ORDER BY timestamp`, timeGroup, whereClause, timeGroup)

        rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取告警趋势失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var trend []*models.AlertTrendPoint
        for rows.Next() </span><span class="cov0" title="0">{
                var point models.AlertTrendPoint
                err := rows.Scan(&amp;point.Timestamp, &amp;point.Count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描趋势数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">trend = append(trend, &amp;point)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历趋势数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return trend, nil</span>
}

// BatchCreate 批量创建告警
func (r *alertRepository) BatchCreate(ctx context.Context, alerts []*models.Alert) error <span class="cov0" title="0">{
        if len(alerts) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, alert := range alerts </span><span class="cov0" title="0">{
                if alert.ID == "" </span><span class="cov0" title="0">{
                        alert.ID = uuid.New().String()
                }</span>

                <span class="cov0" title="0">now := time.Now()
                alert.CreatedAt = now
                alert.UpdatedAt = now

                if alert.Status == "" </span><span class="cov0" title="0">{
                        alert.Status = models.AlertStatusFiring
                }</span>

                // 序列化标签和注解
                <span class="cov0" title="0">labelsJSON, err := json.Marshal(alert.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">annotationsJSON, err := json.Marshal(alert.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化注解失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        INSERT INTO alerts (
                                id, rule_id, data_source_id, name, description, severity, status, source,
                                labels, annotations, value, threshold, expression, starts_at, ends_at,
                                last_eval_at, eval_count, fingerprint, generator_url,
                                silence_id, acked_by, acked_at, resolved_by, resolved_at,
                                created_at, updated_at
                        ) VALUES (
                                $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15,
                                $16, $17, $18, $19, $20, $21, $22, $23, $24, $25, $26
                        )`

                _, err = tx.ExecContext(ctx, query,
                        alert.ID, alert.RuleID, alert.DataSourceID, alert.Name, alert.Description,
                        alert.Severity, alert.Status, alert.Source, string(labelsJSON), string(annotationsJSON),
                        alert.Value, alert.Threshold, alert.Expression, alert.StartsAt, alert.EndsAt,
                        alert.LastEvalAt, alert.EvalCount, alert.Fingerprint, alert.GeneratorURL,
                        alert.SilenceID, alert.AckedBy, alert.AckedAt, alert.ResolvedBy, alert.ResolvedAt,
                        alert.CreatedAt, alert.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建告警失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchUpdate 批量更新告警
func (r *alertRepository) BatchUpdate(ctx context.Context, alerts []*models.Alert) error <span class="cov0" title="0">{
        if len(alerts) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, alert := range alerts </span><span class="cov0" title="0">{
                alert.UpdatedAt = time.Now()

                // 序列化标签和注解
                labelsJSON, err := json.Marshal(alert.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">annotationsJSON, err := json.Marshal(alert.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化注解失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        UPDATE alerts SET 
                                rule_id = $1,
                                data_source_id = $2,
                                name = $3,
                                description = $4,
                                severity = $5,
                                status = $6,
                                source = $7,
                                labels = $8,
                                annotations = $9,
                                value = $10,
                                threshold = $11,
                                expression = $12,
                                starts_at = $13,
                                ends_at = $14,
                                last_eval_at = $15,
                                eval_count = $16,
                                fingerprint = $17,
                                generator_url = $18,
                                silence_id = $19,
                                acked_by = $20,
                                acked_at = $21,
                                resolved_by = $22,
                                resolved_at = $23,
                                updated_at = $24
                        WHERE id = $25 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query,
                        alert.RuleID, alert.DataSourceID, alert.Name, alert.Description,
                        alert.Severity, alert.Status, alert.Source, string(labelsJSON), string(annotationsJSON),
                        alert.Value, alert.Threshold, alert.Expression, alert.StartsAt, alert.EndsAt,
                        alert.LastEvalAt, alert.EvalCount, alert.Fingerprint, alert.GeneratorURL,
                        alert.SilenceID, alert.AckedBy, alert.AckedAt, alert.ResolvedBy, alert.ResolvedAt,
                        alert.UpdatedAt, alert.ID,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新告警失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除告警
func (r *alertRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 构建占位符
        <span class="cov0" title="0">placeholders := make([]string, len(ids))
        args := make([]interface{}, len(ids))
        for i, id := range ids </span><span class="cov0" title="0">{
                placeholders[i] = fmt.Sprintf("$%d", i+1)
                args[i] = id
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf(`
                UPDATE alerts SET 
                        deleted_at = NOW(),
                        updated_at = NOW()
                WHERE id IN (%s) AND deleted_at IS NULL`,
                strings.Join(placeholders, ", "))

        result, err := r.getExecutor().ExecContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量删除告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除行数失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("没有找到要删除的告警")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetHistory 获取告警历史记录
func (r *alertRepository) GetHistory(ctx context.Context, alertID string) ([]*models.AlertHistory, error) <span class="cov0" title="0">{
        var histories []*models.AlertHistory
        query := `
                SELECT id, alert_id, action, old_value, new_value, user_id, comment, created_at
                FROM alert_histories 
                WHERE alert_id = $1 
                ORDER BY created_at DESC`

        err := r.db.SelectContext(ctx, &amp;histories, query, alertID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取告警历史记录失败: %w", err)
        }</span>

        <span class="cov0" title="0">return histories, nil</span>
}

// AddHistory 添加告警历史记录
func (r *alertRepository) AddHistory(ctx context.Context, history *models.AlertHistory) error <span class="cov0" title="0">{
        // 生成历史记录ID
        if history.ID == "" </span><span class="cov0" title="0">{
                history.ID = uuid.New().String()
        }</span>

        // 设置创建时间
        <span class="cov0" title="0">history.CreatedAt = time.Now()

        // 序列化JSON字段
        oldValueJSON, err := json.Marshal(history.OldValue)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化旧值失败: %w", err)
        }</span>

        <span class="cov0" title="0">newValueJSON, err := json.Marshal(history.NewValue)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化新值失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO alert_histories (
                        id, alert_id, action, old_value, new_value, user_id, comment, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8
                )`

        _, err = r.getExecutor().ExecContext(ctx, query,
                history.ID,
                history.AlertID,
                history.Action,
                string(oldValueJSON),
                string(newValueJSON),
                history.UserID,
                history.Comment,
                history.CreatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("添加告警历史记录失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// BatchAcknowledge 批量确认告警
func (r *alertRepository) BatchAcknowledge(ctx context.Context, ids []string, userID string, comment *string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 构建占位符
        <span class="cov0" title="0">placeholders := make([]string, len(ids))
        args := make([]interface{}, len(ids)+3)
        now := time.Now()

        args[0] = models.AlertStatusAcked
        args[1] = userID
        args[2] = now

        for i, id := range ids </span><span class="cov0" title="0">{
                placeholders[i] = fmt.Sprintf("$%d", i+4)
                args[i+3] = id
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf(`
                UPDATE alerts SET 
                        status = $1,
                        acked_by = $2,
                        acked_at = $3,
                        updated_at = $3
                WHERE id IN (%s) AND deleted_at IS NULL`,
                strings.Join(placeholders, ", "))

        result, err := r.getExecutor().ExecContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量确认告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取确认行数失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("没有找到要确认的告警")
        }</span>

        // 为每个告警添加历史记录
        <span class="cov0" title="0">for _, id := range ids </span><span class="cov0" title="0">{
                history := &amp;models.AlertHistory{
                        AlertID: id,
                        Action:  "acknowledged",
                        UserID:  &amp;userID,
                        Comment: comment,
                }
                if err := r.AddHistory(ctx, history); err != nil </span><span class="cov0" title="0">{
                        // 记录历史失败不影响主操作
                        continue</span>
                }
        }

        <span class="cov0" title="0">return nil</span>
}

// BatchResolve 批量解决告警
func (r *alertRepository) BatchResolve(ctx context.Context, ids []string, userID string, comment *string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 构建占位符
        <span class="cov0" title="0">placeholders := make([]string, len(ids))
        args := make([]interface{}, len(ids)+3)
        now := time.Now()

        args[0] = models.AlertStatusResolved
        args[1] = userID
        args[2] = now

        for i, id := range ids </span><span class="cov0" title="0">{
                placeholders[i] = fmt.Sprintf("$%d", i+4)
                args[i+3] = id
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf(`
                UPDATE alerts SET 
                        status = $1,
                        resolved_by = $2,
                        resolved_at = $3,
                        ends_at = $3,
                        updated_at = $3
                WHERE id IN (%s) AND deleted_at IS NULL`,
                strings.Join(placeholders, ", "))

        result, err := r.getExecutor().ExecContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量解决告警失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取解决行数失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("没有找到要解决的告警")
        }</span>

        // 为每个告警添加历史记录
        <span class="cov0" title="0">for _, id := range ids </span><span class="cov0" title="0">{
                history := &amp;models.AlertHistory{
                        AlertID: id,
                        Action:  "resolved",
                        UserID:  &amp;userID,
                        Comment: comment,
                }
                if err := r.AddHistory(ctx, history); err != nil </span><span class="cov0" title="0">{
                        // 记录历史失败不影响主操作
                        continue</span>
                }
        }

        <span class="cov0" title="0">return nil</span>
}</pre>
		
		<pre class="file" id="file1" style="display: none">package repository

import (
        "context"
        "database/sql"
        "fmt"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"

        "Pulse/internal/models"
)

// AuthRepository 认证仓储接口
type AuthRepository interface {
        // 会话管理
        CreateSession(ctx context.Context, session *models.UserSession) error
        GetSession(ctx context.Context, sessionID string) (*models.UserSession, error)
        GetSessionByToken(ctx context.Context, sessionToken string) (*models.UserSession, error)
        GetUserSessions(ctx context.Context, userID string) ([]*models.UserSession, error)
        UpdateSessionLastActivity(ctx context.Context, sessionID string, lastActivity time.Time) error
        DeleteSession(ctx context.Context, sessionID string) error
        DeleteUserSessions(ctx context.Context, userID string) error
        CleanupExpiredSessions(ctx context.Context) (int64, error)

        // 刷新令牌管理
        CreateRefreshToken(ctx context.Context, token *models.RefreshToken) error
        GetRefreshToken(ctx context.Context, token string) (*models.RefreshToken, error)
        GetRefreshTokenByID(ctx context.Context, tokenID string) (*models.RefreshToken, error)
        GetUserRefreshTokens(ctx context.Context, userID string) ([]*models.RefreshToken, error)
        RevokeRefreshToken(ctx context.Context, token string) error
        RevokeUserRefreshTokens(ctx context.Context, userID string) error
        CleanupExpiredRefreshTokens(ctx context.Context) (int64, error)

        // 登录尝试记录
        CreateLoginAttempt(ctx context.Context, attempt *models.LoginAttempt) error
        GetLoginAttempts(ctx context.Context, identifier string, since time.Time) ([]*models.LoginAttempt, error)
        GetFailedLoginAttempts(ctx context.Context, identifier string, since time.Time) (int, error)
        CleanupOldLoginAttempts(ctx context.Context, before time.Time) (int64, error)
}



// authRepository 认证仓储实现
type authRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewAuthRepository 创建认证仓储实例
func NewAuthRepository(db *sqlx.DB) AuthRepository <span class="cov8" title="1">{
        return &amp;authRepository{
                db: db,
        }
}</span>

// NewAuthRepositoryWithTx 创建带事务的认证仓储实例
func NewAuthRepositoryWithTx(tx *sqlx.Tx) AuthRepository <span class="cov0" title="0">{
        return &amp;authRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *authRepository) getExecutor() sqlx.ExtContext <span class="cov8" title="1">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov8" title="1">return r.db</span>
}

// CreateSession 创建用户会话
func (r *authRepository) CreateSession(ctx context.Context, session *models.UserSession) error <span class="cov8" title="1">{
        if session.ID == "" </span><span class="cov0" title="0">{
                session.ID = uuid.New().String()
        }</span>

        <span class="cov8" title="1">now := time.Now()
        session.CreatedAt = now
        session.UpdatedAt = now
        session.LastActivity = now

        query := `
                INSERT INTO user_sessions (
                        id, user_id, session_token, user_agent, ip_address, 
                        last_activity, expires_at, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                session.ID, session.UserID, session.SessionToken, session.UserAgent,
                session.IPAddress, session.LastActivity, session.ExpiresAt,
                session.CreatedAt, session.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建用户会话失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetSession 获取用户会话
func (r *authRepository) GetSession(ctx context.Context, sessionID string) (*models.UserSession, error) <span class="cov8" title="1">{
        var session models.UserSession
        query := `
                SELECT id, user_id, session_token, ip_address, user_agent,
                       last_activity, expires_at, created_at, updated_at
                FROM user_sessions 
                WHERE id = $1`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;session, query, sessionID)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("会话不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户会话失败: %w", err)</span>
        }

        <span class="cov8" title="1">return &amp;session, nil</span>
}

// GetSessionByToken 通过会话令牌获取用户会话
func (r *authRepository) GetSessionByToken(ctx context.Context, sessionToken string) (*models.UserSession, error) <span class="cov8" title="1">{
        var session models.UserSession
        query := `
                SELECT id, user_id, session_token, ip_address, user_agent,
                       last_activity, expires_at, created_at, updated_at
                FROM user_sessions 
                WHERE session_token = $1`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;session, query, sessionToken)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("会话不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户会话失败: %w", err)</span>
        }

        <span class="cov8" title="1">return &amp;session, nil</span>
}

// GetUserSessions 获取用户的所有会话
func (r *authRepository) GetUserSessions(ctx context.Context, userID string) ([]*models.UserSession, error) <span class="cov0" title="0">{
        query := `
                SELECT id, user_id, session_token, ip_address, user_agent,
                       last_activity, expires_at, created_at, updated_at
                FROM user_sessions 
                WHERE user_id = $1
                ORDER BY last_activity DESC`

        rows, err := r.getExecutor().QueryContext(ctx, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取用户会话列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var sessions []*models.UserSession
        for rows.Next() </span><span class="cov0" title="0">{
                var session models.UserSession
                err := rows.Scan(
                        &amp;session.ID, &amp;session.UserID, &amp;session.SessionToken,
                        &amp;session.IPAddress, &amp;session.UserAgent, &amp;session.LastActivity,
                        &amp;session.ExpiresAt, &amp;session.CreatedAt, &amp;session.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描会话数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">sessions = append(sessions, &amp;session)</span>
        }

        <span class="cov0" title="0">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历会话数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return sessions, nil</span>
}

// UpdateSessionLastActivity 更新会话最后活动时间
func (r *authRepository) UpdateSessionLastActivity(ctx context.Context, sessionID string, lastActivity time.Time) error <span class="cov8" title="1">{
        query := `
                UPDATE user_sessions SET 
                        last_activity = $1,
                        updated_at = $2
                WHERE id = $3`

        result, err := r.getExecutor().ExecContext(ctx, query, lastActivity, time.Now(), sessionID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新会话活动时间失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("会话不存在")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// DeleteSession 删除用户会话
func (r *authRepository) DeleteSession(ctx context.Context, sessionID string) error <span class="cov8" title="1">{
        query := `DELETE FROM user_sessions WHERE id = $1`

        result, err := r.getExecutor().ExecContext(ctx, query, sessionID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除用户会话失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("会话不存在")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// DeleteUserSessions 删除用户的所有会话
func (r *authRepository) DeleteUserSessions(ctx context.Context, userID string) error <span class="cov8" title="1">{
        query := `DELETE FROM user_sessions WHERE user_id = $1`

        _, err := r.getExecutor().ExecContext(ctx, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除用户会话失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// CleanupExpiredSessions 清理过期会话
func (r *authRepository) CleanupExpiredSessions(ctx context.Context) (int64, error) <span class="cov8" title="1">{
        now := time.Now()
        query := `DELETE FROM user_sessions WHERE expires_at &lt; $1`

        result, err := r.getExecutor().ExecContext(ctx, query, now)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理过期会话失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">return rowsAffected, nil</span>
}

// CreateRefreshToken 创建刷新令牌
func (r *authRepository) CreateRefreshToken(ctx context.Context, token *models.RefreshToken) error <span class="cov8" title="1">{
        if token.ID == "" </span><span class="cov0" title="0">{
                token.ID = uuid.New().String()
        }</span>

        <span class="cov8" title="1">now := time.Now()
        token.CreatedAt = now
        token.UpdatedAt = now

        query := `
                INSERT INTO refresh_tokens (
                        id, user_id, token, expires_at, revoked_at, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                token.ID, token.UserID, token.Token, token.ExpiresAt,
                token.RevokedAt, token.CreatedAt, token.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建刷新令牌失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetRefreshToken 通过token字符串获取刷新令牌
func (r *authRepository) GetRefreshToken(ctx context.Context, tokenStr string) (*models.RefreshToken, error) <span class="cov8" title="1">{
        var token models.RefreshToken
        query := `
                SELECT id, user_id, token, expires_at, revoked_at, created_at, updated_at
                FROM refresh_tokens 
                WHERE token = $1`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;token, query, tokenStr)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("刷新令牌不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取刷新令牌失败: %w", err)</span>
        }

        <span class="cov8" title="1">return &amp;token, nil</span>
}

// GetRefreshTokenByID 通过ID获取刷新令牌
func (r *authRepository) GetRefreshTokenByID(ctx context.Context, tokenID string) (*models.RefreshToken, error) <span class="cov0" title="0">{
        var token models.RefreshToken
        query := `
                SELECT id, user_id, token, expires_at, revoked_at, created_at, updated_at
                FROM refresh_tokens 
                WHERE id = $1`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;token, query, tokenID)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("刷新令牌不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取刷新令牌失败: %w", err)</span>
        }

        <span class="cov0" title="0">return &amp;token, nil</span>
}

// GetUserRefreshTokens 获取用户的刷新令牌列表
func (r *authRepository) GetUserRefreshTokens(ctx context.Context, userID string) ([]*models.RefreshToken, error) <span class="cov0" title="0">{
        query := `
                SELECT id, user_id, token, expires_at, revoked_at, created_at, updated_at
                FROM refresh_tokens 
                WHERE user_id = $1
                ORDER BY created_at DESC`

        rows, err := r.getExecutor().QueryContext(ctx, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取用户刷新令牌失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var tokens []*models.RefreshToken
        for rows.Next() </span><span class="cov0" title="0">{
                var token models.RefreshToken
                err := rows.Scan(
                        &amp;token.ID, &amp;token.UserID, &amp;token.Token, &amp;token.ExpiresAt,
                        &amp;token.RevokedAt, &amp;token.CreatedAt, &amp;token.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描刷新令牌数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">tokens = append(tokens, &amp;token)</span>
        }

        <span class="cov0" title="0">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历刷新令牌数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return tokens, nil</span>
}

// RevokeRefreshToken 通过token字符串撤销刷新令牌
func (r *authRepository) RevokeRefreshToken(ctx context.Context, tokenStr string) error <span class="cov8" title="1">{
        now := time.Now()
        query := `
                UPDATE refresh_tokens SET 
                        revoked_at = $1,
                        updated_at = $2
                WHERE token = $3 AND revoked_at IS NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, now, now, tokenStr)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("撤销刷新令牌失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取撤销结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("刷新令牌不存在或已被撤销")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// RevokeUserRefreshTokens 撤销用户的所有刷新令牌
func (r *authRepository) RevokeUserRefreshTokens(ctx context.Context, userID string) error <span class="cov8" title="1">{
        now := time.Now()
        query := `
                UPDATE refresh_tokens SET 
                        revoked_at = $1,
                        updated_at = $2
                WHERE user_id = $3 AND revoked_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, now, now, userID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("撤销用户刷新令牌失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// CleanupExpiredRefreshTokens 清理过期的刷新令牌
func (r *authRepository) CleanupExpiredRefreshTokens(ctx context.Context) (int64, error) <span class="cov8" title="1">{
        now := time.Now()
        query := `DELETE FROM refresh_tokens WHERE expires_at &lt; $1 OR revoked_at IS NOT NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, now)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理过期刷新令牌失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">return rowsAffected, nil</span>
}

// CreateLoginAttempt 创建登录尝试记录
func (r *authRepository) CreateLoginAttempt(ctx context.Context, attempt *models.LoginAttempt) error <span class="cov8" title="1">{
        if attempt.ID == "" </span><span class="cov0" title="0">{
                attempt.ID = uuid.New().String()
        }</span>

        <span class="cov8" title="1">attempt.CreatedAt = time.Now()

        query := `
                INSERT INTO login_attempts (
                        id, identifier, ip_address, user_agent, success, fail_reason, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                attempt.ID, attempt.Identifier, attempt.IPAddress, attempt.UserAgent,
                attempt.Success, attempt.FailReason, attempt.CreatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建登录尝试记录失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetLoginAttempts 获取登录尝试记录
func (r *authRepository) GetLoginAttempts(ctx context.Context, identifier string, since time.Time) ([]*models.LoginAttempt, error) <span class="cov8" title="1">{
        query := `
                SELECT id, identifier, ip_address, user_agent, success, fail_reason, created_at
                FROM login_attempts 
                WHERE identifier = $1 AND created_at &gt;= $2
                ORDER BY created_at DESC`

        rows, err := r.getExecutor().QueryContext(ctx, query, identifier, since)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取登录尝试记录失败: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var attempts []*models.LoginAttempt
        for rows.Next() </span><span class="cov8" title="1">{
                var attempt models.LoginAttempt
                err := rows.Scan(
                        &amp;attempt.ID, &amp;attempt.Identifier, &amp;attempt.IPAddress,
                        &amp;attempt.UserAgent, &amp;attempt.Success, &amp;attempt.FailReason,
                        &amp;attempt.CreatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描登录尝试数据失败: %w", err)
                }</span>
                <span class="cov8" title="1">attempts = append(attempts, &amp;attempt)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历登录尝试数据失败: %w", err)
        }</span>

        <span class="cov8" title="1">return attempts, nil</span>
}

// GetFailedLoginAttempts 获取失败的登录尝试次数
func (r *authRepository) GetFailedLoginAttempts(ctx context.Context, identifier string, since time.Time) (int, error) <span class="cov8" title="1">{
        var count int
        query := `
                SELECT COUNT(*) 
                FROM login_attempts 
                WHERE identifier = $1 AND created_at &gt;= $2 AND success = false`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;count, query, identifier, since)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取失败登录尝试次数失败: %w", err)
        }</span>

        <span class="cov8" title="1">return count, nil</span>
}

// CleanupOldLoginAttempts 清理旧的登录尝试记录
func (r *authRepository) CleanupOldLoginAttempts(ctx context.Context, before time.Time) (int64, error) <span class="cov8" title="1">{
        query := `DELETE FROM login_attempts WHERE created_at &lt; $1`

        result, err := r.getExecutor().ExecContext(ctx, query, before)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理旧登录尝试记录失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">return rowsAffected, nil</span>
}</pre>
		
		<pre class="file" id="file2" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "errors"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"

        "Pulse/internal/models"
)

type dataSourceRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewDataSourceRepository 创建数据源仓储实例
func NewDataSourceRepository(db *sqlx.DB) DataSourceRepository <span class="cov0" title="0">{
        return &amp;dataSourceRepository{
                db: db,
        }
}</span>

// NewDataSourceRepositoryWithTx 创建带事务的数据源仓储实例
func NewDataSourceRepositoryWithTx(tx *sqlx.Tx) DataSourceRepository <span class="cov0" title="0">{
        return &amp;dataSourceRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *dataSourceRepository) getExecutor() sqlx.ExtContext <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov0" title="0">return r.db</span>
}

// Create 创建数据源
func (r *dataSourceRepository) Create(ctx context.Context, ds *models.DataSource) error <span class="cov0" title="0">{
        if ds.ID == "" </span><span class="cov0" title="0">{
                ds.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        ds.CreatedAt = now
        ds.UpdatedAt = now

        if ds.Status == "" </span><span class="cov0" title="0">{
                ds.Status = models.DataSourceStatusActive
        }</span>

        // 序列化配置
        <span class="cov0" title="0">configJSON, err := json.Marshal(ds.Config)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化配置失败: %w", err)
        }</span>

        // 序列化标签
        <span class="cov0" title="0">tagsJSON, err := json.Marshal(ds.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO data_sources (
                        id, name, description, type, url, config, labels, status, enabled,
                        timeout, retry_count, health_check_interval, last_health_check,
                        health_status, created_by, created_at, updated_at
                ) VALUES (
                        :id, :name, :description, :type, :url, :config, :labels, :status, :enabled,
                        :timeout, :retry_count, :health_check_interval, :last_health_check,
                        :health_status, :created_by, :created_at, :updated_at
                )`

        _, err = sqlx.NamedExecContext(ctx, r.getExecutor(), query, map[string]interface{}{
                "id":                    ds.ID,
                "name":                  ds.Name,
                "description":           ds.Description,
                "type":                  ds.Type,
                "url":                   ds.Config.URL,
                "config":                string(configJSON),
                "tags":                  string(tagsJSON),
                "status":                ds.Status,
                "health_check_url":      ds.HealthCheckURL,
                "last_health_check":     ds.LastHealthCheck,
                "health_status":         ds.HealthStatus,
                "created_by":            ds.CreatedBy,
                "created_at":            ds.CreatedAt,
                "updated_at":            ds.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建数据源失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Activate 激活数据源
func (r *dataSourceRepository) Activate(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE data_sources 
                SET status = $1, updated_at = NOW() 
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, models.DataSourceStatusActive, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("激活数据源失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Deactivate 停用数据源
func (r *dataSourceRepository) Deactivate(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE data_sources 
                SET status = $1, updated_at = NOW() 
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, models.DataSourceStatusInactive, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("停用数据源失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// BatchHealthCheck 批量健康检查
func (r *dataSourceRepository) BatchHealthCheck(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        // 构建占位符
        <span class="cov0" title="0">placeholders := make([]string, len(ids))
        args := make([]interface{}, len(ids))
        for i, id := range ids </span><span class="cov0" title="0">{
                placeholders[i] = fmt.Sprintf("$%d", i+1)
                args[i] = id
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf(`
                UPDATE data_sources 
                SET health_status = 'checking', last_health_check = NOW(), updated_at = NOW()
                WHERE id IN (%s) AND deleted_at IS NULL
        `, strings.Join(placeholders, ", "))

        _, err := r.db.ExecContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量健康检查失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetActiveCount 获取活跃数据源数量
func (r *dataSourceRepository) GetActiveCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        query := `SELECT COUNT(*) FROM data_sources WHERE status = 'active' AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取活跃数据源数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// GetHealthyCount 获取健康数据源数量
func (r *dataSourceRepository) GetHealthyCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        query := `SELECT COUNT(*) FROM data_sources WHERE health_status = 'healthy' AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取健康数据源数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// GetUnhealthyCount 获取不健康数据源数量
func (r *dataSourceRepository) GetUnhealthyCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        query := `SELECT COUNT(*) FROM data_sources WHERE health_status != 'healthy' AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取不健康数据源数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// Query 执行数据源查询
func (r *dataSourceRepository) Query(ctx context.Context, id string, query *models.DataSourceQuery) (*models.DataSourceQueryResult, error) <span class="cov0" title="0">{
        // 获取数据源信息
        dataSource, err := r.GetByID(ctx, id)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取数据源失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if !dataSource.IsActive() </span><span class="cov0" title="0">{
                return nil, errors.New("数据源未激活")
        }</span>
        
        <span class="cov0" title="0">if !dataSource.IsHealthy() </span><span class="cov0" title="0">{
                return nil, errors.New("数据源不健康")
        }</span>
        
        // 验证查询请求
        <span class="cov0" title="0">if err := query.Validate(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询请求验证失败: %w", err)
        }</span>
        
        // 这里应该根据数据源类型执行实际的查询
        // 目前返回模拟结果
        <span class="cov0" title="0">result := &amp;models.DataSourceQueryResult{
                Success:   true,
                Data:      []map[string]interface{}{},
                Columns:   []string{},
                RowCount:  0,
                QueryTime: 100 * time.Millisecond,
                Metadata:  map[string]interface{}{"executed_at": time.Now()},
        }
        
        return result, nil</span>
}

// GetMetrics 获取数据源指标
func (r *dataSourceRepository) GetMetrics(ctx context.Context, id string) (*models.DataSourceMetrics, error) <span class="cov0" title="0">{
        // 模拟返回数据源指标
        now := time.Now()
        return &amp;models.DataSourceMetrics{
                ConnectionCount:  10,
                QueryCount:      1000,
                ErrorCount:      5,
                AvgResponseTime: 150.5,
                LastQueryAt:     &amp;now,
        }, nil
}</span>

// GetStats 获取数据源统计信息
func (r *dataSourceRepository) GetStats(ctx context.Context, filter *models.DataSourceFilter) (*models.DataSourceStats, error) <span class="cov0" title="0">{
        // 获取总数
        totalQuery := `SELECT COUNT(*) FROM data_sources WHERE deleted_at IS NULL`
        var total int64
        err := r.db.GetContext(ctx, &amp;total, totalQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取数据源总数失败: %w", err)
        }</span>

        // 获取活跃数量
        <span class="cov0" title="0">activeQuery := `SELECT COUNT(*) FROM data_sources WHERE status = $1 AND deleted_at IS NULL`
        var active int64
        err = r.db.GetContext(ctx, &amp;active, activeQuery, models.DataSourceStatusActive)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取活跃数据源数量失败: %w", err)
        }</span>

        // 获取健康数量
        <span class="cov0" title="0">healthyQuery := `SELECT COUNT(*) FROM data_sources WHERE health_status = $1 AND deleted_at IS NULL`
        var healthy int64
        err = r.db.GetContext(ctx, &amp;healthy, healthyQuery, models.DataSourceHealthStatusHealthy)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取健康数据源数量失败: %w", err)
        }</span>

        <span class="cov0" title="0">stats := &amp;models.DataSourceStats{
                Total:        total,
                HealthyCount: healthy,
                ByStatus: map[models.DataSourceStatus]int64{
                        models.DataSourceStatusActive: active,
                },
                ByType: make(map[models.DataSourceType]int64),
        }

        return stats, nil</span>
}

// GetByID 根据ID获取数据源
func (r *dataSourceRepository) GetByID(ctx context.Context, id string) (*models.DataSource, error) <span class="cov0" title="0">{
        var ds models.DataSource
        var configJSON, tagsJSON string

        query := `
                SELECT id, name, description, type, config, tags, status,
                       health_check_url, last_health_check, health_status, 
                       created_by, created_at, updated_at
                FROM data_sources 
                WHERE id = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;ds.ID, &amp;ds.Name, &amp;ds.Description, &amp;ds.Type, &amp;configJSON, &amp;tagsJSON,
                &amp;ds.Status, &amp;ds.HealthCheckURL, &amp;ds.LastHealthCheck, &amp;ds.HealthStatus, 
                &amp;ds.CreatedBy, &amp;ds.CreatedAt, &amp;ds.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("数据源不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取数据源失败: %w", err)</span>
        }

        // 反序列化配置
        <span class="cov0" title="0">if configJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(configJSON), &amp;ds.Config)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化配置失败: %w", err)
                }</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(tagsJSON), &amp;ds.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;ds, nil</span>
}

// GetByName 根据名称获取数据源
func (r *dataSourceRepository) GetByName(ctx context.Context, name string) (*models.DataSource, error) <span class="cov0" title="0">{
        var ds models.DataSource
        var configJSON, tagsJSON string

        query := `
                SELECT id, name, description, type, config, tags, status,
                       health_check_url, last_health_check, health_status, 
                       created_by, created_at, updated_at
                FROM data_sources 
                WHERE name = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, name).Scan(
                &amp;ds.ID, &amp;ds.Name, &amp;ds.Description, &amp;ds.Type, &amp;configJSON, &amp;tagsJSON,
                &amp;ds.Status, &amp;ds.HealthCheckURL, &amp;ds.LastHealthCheck, &amp;ds.HealthStatus, 
                &amp;ds.CreatedBy, &amp;ds.CreatedAt, &amp;ds.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("数据源不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取数据源失败: %w", err)</span>
        }

        // 反序列化配置
        <span class="cov0" title="0">if configJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(configJSON), &amp;ds.Config)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化配置失败: %w", err)
                }</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(tagsJSON), &amp;ds.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;ds, nil</span>
}

// Update 更新数据源
func (r *dataSourceRepository) Update(ctx context.Context, ds *models.DataSource) error <span class="cov0" title="0">{
        ds.UpdatedAt = time.Now()

        // 序列化配置
        configJSON, err := json.Marshal(ds.Config)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化配置失败: %w", err)
        }</span>

        // 序列化标签
        <span class="cov0" title="0">tagsJSON, err := json.Marshal(ds.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE data_sources SET 
                        name = :name,
                        description = :description,
                        type = :type,
                        config = :config,
                        tags = :tags,
                        status = :status,
                        health_check_url = :health_check_url,
                        updated_at = :updated_at
                WHERE id = :id AND deleted_at IS NULL`

        _, err = r.db.NamedExecContext(ctx, query, map[string]interface{}{
                "id":                ds.ID,
                "name":              ds.Name,
                "description":       ds.Description,
                "type":              ds.Type,
                "config":            string(configJSON),
                "tags":              string(tagsJSON),
                "status":            ds.Status,
                "health_check_url":  ds.HealthCheckURL,
                "updated_at":        ds.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新数据源失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Delete 硬删除数据源
func (r *dataSourceRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `DELETE FROM data_sources WHERE id = $1`
        _, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// SoftDelete 软删除数据源
func (r *dataSourceRepository) SoftDelete(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE data_sources SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// List 获取数据源列表
func (r *dataSourceRepository) List(ctx context.Context, filter *models.DataSourceFilter) (*models.DataSourceList, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Type != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("type = $%d", argIndex))
                        args = append(args, *filter.Type)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                // Enabled字段已移除，跳过此过滤条件

                <span class="cov0" title="0">if filter.HealthStatus != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("health_status = $%d", argIndex))
                        args = append(args, *filter.HealthStatus)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("(name ILIKE $%d OR description ILIKE $%d)", argIndex, argIndex))
                        args = append(args, "%"+*filter.Keyword+"%")
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM data_sources %s", whereClause)
        var total int64
        err := r.db.GetContext(ctx, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取数据源总数失败: %w", err)
        }</span>

        // 构建查询
        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT id, name, description, type, config, tags, status,
                       health_check_url, last_health_check, health_status, 
                       created_by, created_at, updated_at
                FROM data_sources %s
                ORDER BY created_at DESC`, whereClause)

        // 添加分页
        if filter != nil &amp;&amp; filter.Page &gt; 0 &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                offset := (filter.Page - 1) * filter.PageSize
                query += fmt.Sprintf(" LIMIT $%d OFFSET $%d", argIndex, argIndex+1)
                args = append(args, filter.PageSize, offset)
        }</span>

        <span class="cov0" title="0">rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询数据源列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var dataSources []*models.DataSource
        for rows.Next() </span><span class="cov0" title="0">{
                var ds models.DataSource
                var configJSON, tagsJSON string

                err := rows.Scan(
                        &amp;ds.ID, &amp;ds.Name, &amp;ds.Description, &amp;ds.Type, &amp;configJSON, &amp;tagsJSON,
                        &amp;ds.Status, &amp;ds.HealthCheckURL, &amp;ds.LastHealthCheck, &amp;ds.HealthStatus, 
                        &amp;ds.CreatedBy, &amp;ds.CreatedAt, &amp;ds.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描数据源数据失败: %w", err)
                }</span>

                // 反序列化配置
                <span class="cov0" title="0">if configJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(configJSON), &amp;ds.Config)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化配置失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(tagsJSON), &amp;ds.Tags)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">dataSources = append(dataSources, &amp;ds)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历数据源数据失败: %w", err)
        }</span>

        // 计算分页信息
        <span class="cov0" title="0">var totalPages int64 = 1
        if filter != nil &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                totalPages = (total + int64(filter.PageSize) - 1) / int64(filter.PageSize)
        }</span>

        <span class="cov0" title="0">page := 1
        pageSize := len(dataSources)
        if filter != nil </span><span class="cov0" title="0">{
                if filter.Page &gt; 0 </span><span class="cov0" title="0">{
                        page = filter.Page
                }</span>
                <span class="cov0" title="0">if filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                        pageSize = filter.PageSize
                }</span>
        }

        <span class="cov0" title="0">return &amp;models.DataSourceList{
                DataSources: dataSources,
                Total:       total,
                Page:        page,
                PageSize:    pageSize,
                TotalPages:  int(totalPages),
        }, nil</span>
}

// Count 获取数据源总数
func (r *dataSourceRepository) Count(ctx context.Context, filter *models.DataSourceFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Type != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("type = $%d", argIndex))
                        args = append(args, *filter.Type)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                // Enabled字段已移除，跳过此过滤条件
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM data_sources %s", whereClause)
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取数据源总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查数据源是否存在
func (r *dataSourceRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM data_sources WHERE id = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查数据源是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// ExistsByName 检查数据源名称是否存在
func (r *dataSourceRepository) ExistsByName(ctx context.Context, name string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM data_sources WHERE name = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, name)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查数据源名称是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// TestConnection 测试数据源连接
func (r *dataSourceRepository) TestConnection(ctx context.Context, ds *models.DataSource) (*models.DataSourceTestResult, error) <span class="cov0" title="0">{
        start := time.Now()
        
        // 这里应该根据不同的数据源类型进行实际的连接测试
        // 模拟连接测试逻辑
        time.Sleep(50 * time.Millisecond)
        
        version := "1.0.0"
        // 目前返回一个模拟结果
        result := &amp;models.DataSourceTestResult{
                Success:      true,
                Message:      "连接成功",
                ResponseTime: time.Since(start),
                Version:      &amp;version,
                Metadata:     make(map[string]interface{}),
        }

        // 注意：这个方法只是测试连接，不更新数据库记录
        // 如果需要更新健康状态，应该使用 UpdateHealthStatus 方法

        return result, nil
}</span>

// UpdateHealthStatus 更新数据源健康状态
func (r *dataSourceRepository) UpdateHealthStatus(ctx context.Context, id string, isHealthy bool, errorMsg string) error <span class="cov0" title="0">{
        var healthStatus models.DataSourceHealthStatus
        if isHealthy </span><span class="cov0" title="0">{
                healthStatus = models.DataSourceHealthStatusHealthy
        }</span> else<span class="cov0" title="0"> {
                healthStatus = models.DataSourceHealthStatusUnhealthy
        }</span>
        
        <span class="cov0" title="0">query := `
                UPDATE data_sources 
                SET health_status = $1, last_error = $2, updated_at = CURRENT_TIMESTAMP
                WHERE id = $3 AND deleted_at IS NULL
        `
        
        _, err := r.db.ExecContext(ctx, query, healthStatus, errorMsg, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新数据源健康状态失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// UpdateLastHealthCheck 更新最后健康检查时间
func (r *dataSourceRepository) UpdateLastHealthCheck(ctx context.Context, id string, checkTime time.Time) error <span class="cov0" title="0">{
        query := `
                UPDATE data_sources 
                SET last_health_check = $1, updated_at = CURRENT_TIMESTAMP
                WHERE id = $2 AND deleted_at IS NULL
        `
        
        _, err := r.db.ExecContext(ctx, query, checkTime, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新最后健康检查时间失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// UpdateMetrics 更新数据源指标
func (r *dataSourceRepository) UpdateMetrics(ctx context.Context, id string, metrics *models.DataSourceMetrics) error <span class="cov0" title="0">{
        metricsJSON, err := json.Marshal(metrics)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化指标数据失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">query := `
                UPDATE data_sources 
                SET metrics = $1, updated_at = CURRENT_TIMESTAMP
                WHERE id = $2 AND deleted_at IS NULL
        `
        
        _, err = r.db.ExecContext(ctx, query, string(metricsJSON), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新数据源指标失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// Enable 启用数据源
func (r *dataSourceRepository) Enable(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE data_sources SET 
                        enabled = true,
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, models.DataSourceStatusActive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("启用数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// Disable 禁用数据源
func (r *dataSourceRepository) Disable(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE data_sources SET 
                        enabled = false,
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, models.DataSourceStatusInactive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("禁用数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// GetByType 根据类型获取数据源列表
func (r *dataSourceRepository) GetByType(ctx context.Context, dsType models.DataSourceType) ([]*models.DataSource, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, status, config, tags, version,
                       health_check_url, health_status, last_health_check, error_message,
                       metrics, created_by, updated_by, created_at, updated_at
                FROM data_sources 
                WHERE type = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, dsType)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("根据类型获取数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var dataSources []*models.DataSource
        for rows.Next() </span><span class="cov0" title="0">{
                var ds models.DataSource
                var configJSON, tagsJSON, metricsJSON string

                err := rows.Scan(
                        &amp;ds.ID, &amp;ds.Name, &amp;ds.Description, &amp;ds.Type, &amp;ds.Status, &amp;configJSON, &amp;tagsJSON,
                        &amp;ds.Version, &amp;ds.HealthCheckURL, &amp;ds.HealthStatus, &amp;ds.LastHealthCheck,
                        &amp;ds.ErrorMessage, &amp;metricsJSON, &amp;ds.CreatedBy, &amp;ds.UpdatedBy, &amp;ds.CreatedAt, &amp;ds.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描数据源数据失败: %w", err)
                }</span>

                // 反序列化配置
                <span class="cov0" title="0">if configJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(configJSON), &amp;ds.Config)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化配置失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(tagsJSON), &amp;ds.Tags)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化指标
                <span class="cov0" title="0">if metricsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(metricsJSON), &amp;ds.Metrics)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化指标失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">dataSources = append(dataSources, &amp;ds)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历数据源数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return dataSources, nil</span>
}

// GetActiveDataSources 获取活跃数据源列表
func (r *dataSourceRepository) GetActiveDataSources(ctx context.Context) ([]*models.DataSource, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, status, config, tags, version,
                       health_check_url, health_status, last_health_check, error_message,
                       metrics, created_by, updated_by, created_at, updated_at
                FROM data_sources 
                WHERE status = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, models.DataSourceStatusActive)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取活跃数据源失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var dataSources []*models.DataSource
        for rows.Next() </span><span class="cov0" title="0">{
                var ds models.DataSource
                var configJSON, tagsJSON, metricsJSON string

                err := rows.Scan(
                        &amp;ds.ID, &amp;ds.Name, &amp;ds.Description, &amp;ds.Type, &amp;ds.Status, &amp;configJSON, &amp;tagsJSON,
                        &amp;ds.Version, &amp;ds.HealthCheckURL, &amp;ds.HealthStatus, &amp;ds.LastHealthCheck,
                        &amp;ds.ErrorMessage, &amp;metricsJSON, &amp;ds.CreatedBy, &amp;ds.UpdatedBy, &amp;ds.CreatedAt, &amp;ds.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描数据源数据失败: %w", err)
                }</span>

                // 反序列化配置
                <span class="cov0" title="0">if configJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(configJSON), &amp;ds.Config)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化配置失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(tagsJSON), &amp;ds.Tags)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化指标
                <span class="cov0" title="0">if metricsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(metricsJSON), &amp;ds.Metrics)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化指标失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">dataSources = append(dataSources, &amp;ds)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历数据源数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return dataSources, nil</span>
}

// BatchCreate 批量创建数据源
func (r *dataSourceRepository) BatchCreate(ctx context.Context, dataSources []*models.DataSource) error <span class="cov0" title="0">{
        if len(dataSources) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, ds := range dataSources </span><span class="cov0" title="0">{
                if ds.ID == "" </span><span class="cov0" title="0">{
                        ds.ID = uuid.New().String()
                }</span>

                <span class="cov0" title="0">now := time.Now()
                ds.CreatedAt = now
                ds.UpdatedAt = now

                if ds.Status == "" </span><span class="cov0" title="0">{
                        ds.Status = models.DataSourceStatusActive
                }</span>

                // 序列化配置、标签和指标
                <span class="cov0" title="0">configJSON, err := json.Marshal(ds.Config)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化配置失败: %w", err)
                }</span>

                <span class="cov0" title="0">tagsJSON, err := json.Marshal(ds.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">var metricsJSON []byte
                if ds.Metrics != nil </span><span class="cov0" title="0">{
                        metricsJSON, err = json.Marshal(ds.Metrics)
                        if err != nil </span><span class="cov0" title="0">{
                                return fmt.Errorf("序列化指标失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">query := `
                        INSERT INTO data_sources (
                                id, name, description, type, status, config, tags, version,
                                health_check_url, health_status, last_health_check, error_message,
                                metrics, created_by, updated_by, created_at, updated_at
                        ) VALUES (
                                $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17
                        )`

                _, err = tx.ExecContext(ctx, query,
                        ds.ID, ds.Name, ds.Description, ds.Type, ds.Status, string(configJSON), string(tagsJSON),
                        ds.Version, ds.HealthCheckURL, ds.HealthStatus, ds.LastHealthCheck,
                        ds.ErrorMessage, string(metricsJSON), ds.CreatedBy, ds.UpdatedBy, ds.CreatedAt, ds.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建数据源失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchUpdate 批量更新数据源
func (r *dataSourceRepository) BatchUpdate(ctx context.Context, dataSources []*models.DataSource) error <span class="cov0" title="0">{
        if len(dataSources) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, ds := range dataSources </span><span class="cov0" title="0">{
                ds.UpdatedAt = time.Now()

                // 序列化配置、标签和指标
                configJSON, err := json.Marshal(ds.Config)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化配置失败: %w", err)
                }</span>

                <span class="cov0" title="0">tagsJSON, err := json.Marshal(ds.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">var metricsJSON []byte
                if ds.Metrics != nil </span><span class="cov0" title="0">{
                        metricsJSON, err = json.Marshal(ds.Metrics)
                        if err != nil </span><span class="cov0" title="0">{
                                return fmt.Errorf("序列化指标失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">query := `
                        UPDATE data_sources SET 
                                name = $1,
                                description = $2,
                                type = $3,
                                config = $4,
                                tags = $5,
                                status = $6,
                                version = $7,
                                health_check_url = $8,
                                health_status = $9,
                                error_message = $10,
                                metrics = $11,
                                updated_by = $12,
                                updated_at = $13
                        WHERE id = $14 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query,
                        ds.Name, ds.Description, ds.Type, string(configJSON), string(tagsJSON),
                        ds.Status, ds.Version, ds.HealthCheckURL, ds.HealthStatus,
                        ds.ErrorMessage, string(metricsJSON), ds.UpdatedBy, ds.UpdatedAt, ds.ID,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新数据源失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除数据源
func (r *dataSourceRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE data_sources SET 
                                deleted_at = $1,
                                updated_at = $1
                        WHERE id = $2 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量删除数据源失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}</pre>
		
		<pre class="file" id="file3" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"

        "Pulse/internal/models"
)

type knowledgeRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewKnowledgeRepository 创建知识库仓储实例
func NewKnowledgeRepository(db *sqlx.DB) KnowledgeRepository <span class="cov0" title="0">{
        return &amp;knowledgeRepository{
                db: db,
        }
}</span>

// NewKnowledgeRepositoryWithTx 创建带事务的知识库仓储实例
func NewKnowledgeRepositoryWithTx(tx *sqlx.Tx) KnowledgeRepository <span class="cov0" title="0">{
        return &amp;knowledgeRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *knowledgeRepository) getExecutor() sqlx.ExtContext <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov0" title="0">return r.db</span>
}

// Create 创建知识库文章
func (r *knowledgeRepository) Create(ctx context.Context, article *models.KnowledgeArticle) error <span class="cov0" title="0">{
        if article.ID == "" </span><span class="cov0" title="0">{
                article.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        article.CreatedAt = now
        article.UpdatedAt = now
        article.Version = "1"

        if article.Status == "" </span><span class="cov0" title="0">{
                article.Status = models.KnowledgeStatusDraft
        }</span>

        // 序列化标签和元数据
        <span class="cov0" title="0">tagsJSON, err := json.Marshal(article.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">metadataJSON, err := json.Marshal(article.Metadata)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化元数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO knowledge_articles (
                        id, title, content, summary, category_id, status, type, language,
                        author_id, reviewer_id, tags, metadata, version, view_count, like_count,
                        is_featured, visibility, created_at, updated_at
                ) VALUES (
                        :id, :title, :content, :summary, :category_id, :status, :type, :language,
                        :author_id, :reviewer_id, :tags, :metadata, :version, :view_count, :like_count,
                        :is_featured, :visibility, :created_at, :updated_at
                )`

        _, err = sqlx.NamedExecContext(ctx, r.db, query, map[string]interface{}{
                "id":          article.ID,
                "title":       article.Title,
                "content":     article.Content,
                "summary":     article.Summary,
                "category_id": article.CategoryID,
                "status":      article.Status,
                "type":        article.Type,
                "language":    article.Language,
                "author_id":   article.AuthorID,
                "reviewer_id": article.ReviewerID,
                "tags":        string(tagsJSON),
                "metadata":    string(metadataJSON),
                "version":     article.Version,
                "view_count":  article.ViewCount,
                "like_count":  article.LikeCount,
                "is_featured": article.IsFeatured,
                "visibility":  article.Visibility,
                "created_at":  article.CreatedAt,
                "updated_at":  article.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建知识库文章失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Unarchive 取消归档知识库
func (r *knowledgeRepository) Unarchive(ctx context.Context, id string) error <span class="cov0" title="0">{
        // 检查知识库是否存在且为归档状态
        var currentStatus models.KnowledgeStatus
        query := `SELECT status FROM knowledge WHERE id = $1 AND deleted_at IS NULL`
        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(&amp;currentStatus)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return fmt.Errorf("知识库不存在")
                }</span>
                <span class="cov0" title="0">return fmt.Errorf("获取知识库状态失败: %w", err)</span>
        }
        
        // 只有归档状态的知识库才能取消归档
        <span class="cov0" title="0">if currentStatus != models.KnowledgeStatusArchived </span><span class="cov0" title="0">{
                return fmt.Errorf("只有归档状态的知识库才能取消归档")
        }</span>
        
        // 更新状态为已发布
        <span class="cov0" title="0">updateQuery := `
                UPDATE knowledge 
                SET status = $1, archived_at = NULL, updated_at = CURRENT_TIMESTAMP
                WHERE id = $2 AND deleted_at IS NULL`
        
        _, err = r.db.ExecContext(ctx, updateQuery, models.KnowledgeStatusPublished, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("取消归档失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetByID 根据ID获取知识库文章
func (r *knowledgeRepository) GetByID(ctx context.Context, id string) (*models.KnowledgeArticle, error) <span class="cov0" title="0">{
        var article models.KnowledgeArticle
        var tagsJSON, metadataJSON string

        query := `
                SELECT id, title, content, summary, category_id, status, type, language,
                       author_id, reviewer_id, tags, metadata, version, view_count, like_count,
                       is_featured, visibility, created_at, updated_at, published_at, reviewed_at
                FROM knowledge_articles
                WHERE slug = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;article.ID, &amp;article.Title, &amp;article.Content, &amp;article.Summary, &amp;article.CategoryID,
                &amp;article.Status, &amp;article.Type, &amp;article.Language, &amp;article.AuthorID, &amp;article.ReviewerID,
                &amp;tagsJSON, &amp;metadataJSON, &amp;article.Version, &amp;article.ViewCount, &amp;article.LikeCount,
                &amp;article.IsFeatured, &amp;article.Visibility, &amp;article.PublishedAt, &amp;article.CreatedAt, &amp;article.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("知识库文章不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取知识库文章失败: %w", err)</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(tagsJSON), &amp;article.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        // 反序列化元数据
        <span class="cov0" title="0">if metadataJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(metadataJSON), &amp;article.Metadata)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化元数据失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;article, nil</span>
}

// GetBySlug 根据Slug获取知识库文章
func (r *knowledgeRepository) GetBySlug(ctx context.Context, slug string) (*models.KnowledgeArticle, error) <span class="cov0" title="0">{
        var article models.KnowledgeArticle
        var tagsJSON, metadataJSON string

        query := `
                SELECT id, title, content, summary, category_id, status, type, language,
                       author_id, reviewer_id, tags, metadata, version, view_count, like_count,
                       is_featured, visibility, published_at, created_at, updated_at
                FROM knowledge_articles 
                WHERE slug = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, slug).Scan(
                &amp;article.ID, &amp;article.Title, &amp;article.Content, &amp;article.Summary, &amp;article.CategoryID,
                &amp;article.Status, &amp;article.Type, &amp;article.Language, &amp;article.AuthorID, &amp;article.ReviewerID,
                &amp;tagsJSON, &amp;metadataJSON, &amp;article.Version, &amp;article.ViewCount, &amp;article.LikeCount,
                &amp;article.IsFeatured, &amp;article.Visibility, &amp;article.PublishedAt, &amp;article.CreatedAt, &amp;article.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("知识库文章不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取知识库文章失败: %w", err)</span>
        }

        // 反序列化标签和元数据
        <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(tagsJSON), &amp;article.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">if metadataJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(metadataJSON), &amp;article.Metadata)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化元数据失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;article, nil</span>
}

// Update 更新知识库文章
func (r *knowledgeRepository) Update(ctx context.Context, article *models.KnowledgeArticle) error <span class="cov0" title="0">{
        article.UpdatedAt = time.Now()
        // 版本号递增（字符串类型）
        if article.Version == "" </span><span class="cov0" title="0">{
                article.Version = "1"
        }</span> else<span class="cov0" title="0"> {
                // 简单的版本号递增，假设版本号是数字字符串
                version := "1"
                if article.Version != "" </span><span class="cov0" title="0">{
                        version = fmt.Sprintf("%s.1", article.Version)
                }</span>
                <span class="cov0" title="0">article.Version = version</span>
        }

        // 序列化标签和元数据
        <span class="cov0" title="0">tagsJSON, err := json.Marshal(article.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">metadataJSON, err := json.Marshal(article.Metadata)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化元数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE knowledge_articles SET 
                        title = :title,
                        content = :content,
                        summary = :summary,
                        category_id = :category_id,
                        status = :status,
                        type = :type,
                        language = :language,
                        reviewer_id = :reviewer_id,
                        tags = :tags,
                        metadata = :metadata,
                        version = :version,
                        is_featured = :is_featured,
                        visibility = :visibility,
                        published_at = :published_at,
                        updated_at = :updated_at
                WHERE id = :id AND deleted_at IS NULL`

        _, err = sqlx.NamedExecContext(ctx, r.getExecutor(), query, map[string]interface{}{
                "id":           article.ID,
                "title":        article.Title,
                "content":      article.Content,
                "summary":      article.Summary,
                "category_id":  article.CategoryID,
                "status":       article.Status,
                "type":         article.Type,
                "language":     article.Language,
                "reviewer_id":  article.ReviewerID,
                "tags":         string(tagsJSON),
                "metadata":     string(metadataJSON),
                "version":      article.Version,
                "is_featured":  article.IsFeatured,
                "visibility":   article.Visibility,
                "published_at": article.PublishedAt,
                "updated_at":   article.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新知识库文章失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Delete 硬删除知识库文章
func (r *knowledgeRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `DELETE FROM knowledge_articles WHERE id = $1`
        _, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除知识库文章失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// SoftDelete 软删除知识库文章
func (r *knowledgeRepository) SoftDelete(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE knowledge_articles SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除知识库文章失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// List 获取知识库文章列表
func (r *knowledgeRepository) List(ctx context.Context, filter *models.KnowledgeFilter) (*models.KnowledgeList, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.CategoryID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("category_id = $%d", argIndex))
                        args = append(args, *filter.CategoryID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Type != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("type = $%d", argIndex))
                        args = append(args, *filter.Type)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Language != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("language = $%d", argIndex))
                        args = append(args, *filter.Language)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.AuthorID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("author_id = $%d", argIndex))
                        args = append(args, *filter.AuthorID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.IsFeatured != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("is_featured = $%d", argIndex))
                        args = append(args, *filter.IsFeatured)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Visibility != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("visibility = $%d", argIndex))
                        args = append(args, *filter.Visibility)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("(title ILIKE $%d OR content ILIKE $%d OR summary ILIKE $%d)", argIndex, argIndex, argIndex))
                        args = append(args, "%"+*filter.Keyword+"%")
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Tags != nil &amp;&amp; len(filter.Tags) &gt; 0 </span><span class="cov0" title="0">{
                        tagConditions := make([]string, len(filter.Tags))
                        for i, tag := range filter.Tags </span><span class="cov0" title="0">{
                                tagConditions[i] = fmt.Sprintf("tags::jsonb ? $%d", argIndex)
                                args = append(args, tag)
                                argIndex++
                        }</span>
                        <span class="cov0" title="0">conditions = append(conditions, "("+strings.Join(tagConditions, " OR ")+")")</span>
                }
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM knowledge_articles %s", whereClause)
        var total int64
        err := sqlx.GetContext(ctx, r.db, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取知识库文章总数失败: %w", err)
        }</span>

        // 构建查询
        <span class="cov0" title="0">orderBy := "ORDER BY created_at DESC"
        if filter != nil &amp;&amp; filter.SortBy != nil </span><span class="cov0" title="0">{
                switch *filter.SortBy </span>{
                case "title":<span class="cov0" title="0">
                        orderBy = "ORDER BY title ASC"</span>
                case "view_count":<span class="cov0" title="0">
                        orderBy = "ORDER BY view_count DESC"</span>
                case "like_count":<span class="cov0" title="0">
                        orderBy = "ORDER BY like_count DESC"</span>
                case "updated_at":<span class="cov0" title="0">
                        orderBy = "ORDER BY updated_at DESC"</span>
                }
        }

        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT id, title, content, summary, category_id, status, type, language,
                       author_id, reviewer_id, tags, metadata, version, view_count, like_count,
                       is_featured, is_public, published_at, created_at, updated_at
                FROM knowledge_articles %s %s`, whereClause, orderBy)

        // 添加分页
        if filter != nil &amp;&amp; filter.Page &gt; 0 &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                offset := (filter.Page - 1) * filter.PageSize
                query += fmt.Sprintf(" LIMIT $%d OFFSET $%d", argIndex, argIndex+1)
                args = append(args, filter.PageSize, offset)
        }</span>

        <span class="cov0" title="0">rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询知识库文章列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var articles []*models.KnowledgeArticle
        for rows.Next() </span><span class="cov0" title="0">{
                var article models.KnowledgeArticle
                var tagsJSON, metadataJSON string

                err := rows.Scan(
                        &amp;article.ID, &amp;article.Title, &amp;article.Content, &amp;article.Summary, &amp;article.CategoryID,
                        &amp;article.Status, &amp;article.Type, &amp;article.Language, &amp;article.AuthorID, &amp;article.ReviewerID,
                        &amp;tagsJSON, &amp;metadataJSON, &amp;article.Version, &amp;article.ViewCount, &amp;article.LikeCount,
                        &amp;article.IsFeatured, &amp;article.Visibility, &amp;article.PublishedAt, &amp;article.CreatedAt, &amp;article.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识库文章数据失败: %w", err)
                }</span>

                // 反序列化标签和元数据
                <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(tagsJSON), &amp;article.Tags)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">if metadataJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(metadataJSON), &amp;article.Metadata)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化元数据失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">articles = append(articles, &amp;article)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历知识库文章数据失败: %w", err)
        }</span>

        // 计算分页信息
        <span class="cov0" title="0">var totalPages int64 = 1
        if filter != nil &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                totalPages = (total + int64(filter.PageSize) - 1) / int64(filter.PageSize)
        }</span>

        <span class="cov0" title="0">return &amp;models.KnowledgeList{
                Knowledge:  articles,
                Total:      total,
                TotalPages: int(totalPages),
        }, nil</span>
}

// Count 获取知识库文章总数
func (r *knowledgeRepository) Count(ctx context.Context, filter *models.KnowledgeFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.CategoryID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("category_id = $%d", argIndex))
                        args = append(args, *filter.CategoryID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Visibility != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("visibility = $%d", argIndex))
                        args = append(args, *filter.Visibility)
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM knowledge_articles %s", whereClause)
        var count int64
        err := sqlx.GetContext(ctx, r.db, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取知识库文章总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查知识库文章是否存在
func (r *knowledgeRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM knowledge_articles WHERE id = $1 AND deleted_at IS NULL`
        err := sqlx.GetContext(ctx, r.db, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查知识库文章是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// ExistsBySlug 检查Slug是否存在
func (r *knowledgeRepository) ExistsBySlug(ctx context.Context, slug string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM knowledge_articles WHERE slug = $1 AND deleted_at IS NULL`
        err := sqlx.GetContext(ctx, r.db, &amp;count, query, slug)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查Slug是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// UpdateStatus 更新文章状态
func (r *knowledgeRepository) UpdateStatus(ctx context.Context, id string, status models.KnowledgeStatus) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE knowledge_articles SET 
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        if status == models.KnowledgeStatusPublished </span><span class="cov0" title="0">{
                query = `
                        UPDATE knowledge_articles SET 
                                status = $1,
                                published_at = $2,
                                updated_at = $2
                        WHERE id = $3 AND deleted_at IS NULL`

                _, err := r.db.ExecContext(ctx, query, status, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("更新文章状态失败: %w", err)
                }</span>
        } else<span class="cov0" title="0"> {
                _, err := r.db.ExecContext(ctx, query, status, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("更新文章状态失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return nil</span>
}

// Approve 审批知识库文章
func (r *knowledgeRepository) Approve(ctx context.Context, id, reviewerID string, comment *string) error <span class="cov0" title="0">{
        now := time.Now()
        
        // 更新文章状态为已审批
        query := `
                UPDATE knowledge_articles SET 
                        status = $1,
                        reviewer_id = $2,
                        review_comment = $3,
                        published_at = $4,
                        updated_at = $4
                WHERE id = $5 AND deleted_at IS NULL AND status = $6`
        
        result, err := r.db.ExecContext(ctx, query, 
                models.KnowledgeStatusPublished, reviewerID, comment, now, id, models.KnowledgeStatusReview)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("审批知识库文章失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取影响行数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("文章不存在或状态不正确")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// Reject 拒绝知识库文章
func (r *knowledgeRepository) Reject(ctx context.Context, id, reviewerID string, comment *string) error <span class="cov0" title="0">{
        now := time.Now()
        
        // 更新文章状态为已拒绝
        query := `
                UPDATE knowledge_articles SET 
                        status = $1,
                        reviewer_id = $2,
                        review_comment = $3,
                        updated_at = $4
                WHERE id = $5 AND deleted_at IS NULL AND status = $6`
        
        result, err := r.db.ExecContext(ctx, query, 
                models.KnowledgeStatusDraft, reviewerID, comment, now, id, models.KnowledgeStatusReview)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("拒绝知识库文章失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取影响行数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("文章不存在或状态不正确")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// Publish 发布文章
func (r *knowledgeRepository) Publish(ctx context.Context, id, publisherID string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE knowledge_articles SET 
                        status = $1,
                        published_at = $2,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`
        
        _, err := r.db.ExecContext(ctx, query, models.KnowledgeStatusPublished, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("发布文章失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// Unpublish 取消发布文章
func (r *knowledgeRepository) Unpublish(ctx context.Context, id string) error <span class="cov0" title="0">{
        return r.UpdateStatus(ctx, id, models.KnowledgeStatusDraft)
}</span>

// Archive 归档文章
func (r *knowledgeRepository) Archive(ctx context.Context, id string) error <span class="cov0" title="0">{
        return r.UpdateStatus(ctx, id, models.KnowledgeStatusArchived)
}</span>

// IncrementViewCount 增加浏览次数
func (r *knowledgeRepository) IncrementViewCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        view_count = view_count + 1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("增加浏览次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// IncrementLikeCount 增加点赞次数
func (r *knowledgeRepository) IncrementLikeCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        like_count = like_count + 1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("增加点赞次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// DecrementLikeCount 减少点赞次数
func (r *knowledgeRepository) DecrementLikeCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        like_count = GREATEST(like_count - 1, 0),
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("减少点赞次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// IncrementDislikeCount 增加踩次数
func (r *knowledgeRepository) IncrementDislikeCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        dislike_count = dislike_count + 1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("增加踩次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// IncrementShareCount 增加分享次数
func (r *knowledgeRepository) IncrementShareCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        share_count = share_count + 1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("增加分享次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// IncrementDownloadCount 增加下载次数
func (r *knowledgeRepository) IncrementDownloadCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        download_count = download_count + 1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("增加下载次数失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// UpdateRating 更新评分
func (r *knowledgeRepository) UpdateRating(ctx context.Context, id string, rating float64) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_articles SET 
                        rating = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, rating, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新评分失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// CreateVersion 创建文章版本
func (r *knowledgeRepository) CreateVersion(ctx context.Context, version *models.KnowledgeVersion) error <span class="cov0" title="0">{
        if version.ID == "" </span><span class="cov0" title="0">{
                version.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">version.CreatedAt = time.Now()

        query := `
                INSERT INTO knowledge_versions (
                        id, knowledge_id, version, title, content, change_log, created_by, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8
                )`

        _, err := r.db.ExecContext(ctx, query,
                        version.ID, version.KnowledgeID, version.Version, version.Title,
                        version.Content, version.ChangeLog, version.CreatedBy, version.CreatedAt,
                )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建文章版本失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetVersions 获取文章版本列表
func (r *knowledgeRepository) GetVersions(ctx context.Context, articleID string) ([]*models.KnowledgeVersion, error) <span class="cov0" title="0">{
        query := `
                SELECT id, knowledge_id, version, title, content, change_log, created_by, created_at
                FROM knowledge_versions 
                WHERE knowledge_id = $1
                ORDER BY version DESC`

        rows, err := r.db.QueryContext(ctx, query, articleID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取文章版本列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var versions []*models.KnowledgeVersion
        for rows.Next() </span><span class="cov0" title="0">{
                var version models.KnowledgeVersion
                err := rows.Scan(
                        &amp;version.ID, &amp;version.KnowledgeID, &amp;version.Version, &amp;version.Title,
                        &amp;version.Content, &amp;version.ChangeLog, &amp;version.CreatedBy, &amp;version.CreatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描版本数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">versions = append(versions, &amp;version)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历版本数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return versions, nil</span>
}

// GetVersion 获取指定版本
func (r *knowledgeRepository) GetVersion(ctx context.Context, knowledgeID, versionStr string) (*models.KnowledgeVersion, error) <span class="cov0" title="0">{
        var version models.KnowledgeVersion

        query := `
                SELECT id, knowledge_id, version, title, content, change_log, created_by, created_at
                FROM knowledge_versions 
                WHERE knowledge_id = $1 AND version = $2`

        err := r.getExecutor().QueryRowxContext(ctx, query, knowledgeID, versionStr).Scan(
                &amp;version.ID, &amp;version.KnowledgeID, &amp;version.Version, &amp;version.Title,
                &amp;version.Content, &amp;version.ChangeLog, &amp;version.CreatedBy, &amp;version.CreatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("文章版本不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取文章版本失败: %w", err)</span>
        }

        <span class="cov0" title="0">return &amp;version, nil</span>
}

// RestoreVersion 恢复到指定版本
func (r *knowledgeRepository) RestoreVersion(ctx context.Context, knowledgeID, version string) error <span class="cov0" title="0">{
        // 获取指定版本的内容
        versionData, err := r.GetVersion(ctx, knowledgeID, version)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取版本数据失败: %w", err)
        }</span>

        // 更新主文章内容为指定版本的内容
        <span class="cov0" title="0">query := `
                UPDATE knowledge_articles SET 
                        title = $1,
                        content = $2,
                        version = $3,
                        updated_at = $4
                WHERE id = $5 AND deleted_at IS NULL`

        _, err = r.db.ExecContext(ctx, query,
                versionData.Title, versionData.Content, versionData.Version,
                time.Now(), knowledgeID,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("恢复版本失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// CreateCategory 创建分类
func (r *knowledgeRepository) CreateCategory(ctx context.Context, category *models.KnowledgeCategory) error <span class="cov0" title="0">{
        if category.ID == "" </span><span class="cov0" title="0">{
                category.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        category.CreatedAt = now
        category.UpdatedAt = now

        query := `
                INSERT INTO knowledge_categories (
                        id, name, description, parent_id, sort_order, is_active, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8
                )`

        _, err := r.db.ExecContext(ctx, query,
                category.ID, category.Name, category.Description,
                category.ParentID, category.SortOrder, category.IsActive, category.CreatedAt, category.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建分类失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetCategories 获取分类列表
func (r *knowledgeRepository) GetCategories(ctx context.Context) ([]*models.KnowledgeCategory, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, parent_id, sort_order, is_active, created_at, updated_at
                FROM knowledge_categories 
                WHERE deleted_at IS NULL
                ORDER BY sort_order ASC, name ASC`

        rows, err := r.db.QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取分类列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var categories []*models.KnowledgeCategory
        for rows.Next() </span><span class="cov0" title="0">{
                var category models.KnowledgeCategory
                err := rows.Scan(
                        &amp;category.ID, &amp;category.Name, &amp;category.Description,
                        &amp;category.ParentID, &amp;category.SortOrder, &amp;category.IsActive, &amp;category.CreatedAt, &amp;category.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描分类数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">categories = append(categories, &amp;category)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历分类数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return categories, nil</span>
}

// UpdateCategory 更新分类
func (r *knowledgeRepository) UpdateCategory(ctx context.Context, category *models.KnowledgeCategory) error <span class="cov0" title="0">{
        category.UpdatedAt = time.Now()

        query := `
                UPDATE knowledge_categories SET 
                        name = $1,
                        description = $2,
                        parent_id = $3,
                        sort_order = $4,
                        is_active = $5,
                        updated_at = $6
                WHERE id = $7 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query,
                category.Name, category.Description, category.ParentID,
                category.SortOrder, category.IsActive, category.UpdatedAt, category.ID,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新分类失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// DeleteCategory 删除分类
func (r *knowledgeRepository) DeleteCategory(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE knowledge_categories SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除分类失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}



// GetTagStats 获取标签统计
func (r *knowledgeRepository) GetTagStats(ctx context.Context) (map[string]int64, error) <span class="cov0" title="0">{
        query := `
                SELECT jsonb_array_elements_text(tags) as tag, COUNT(*) as count
                FROM knowledge_articles 
                WHERE deleted_at IS NULL AND tags IS NOT NULL
                GROUP BY tag
                ORDER BY count DESC, tag`

        rows, err := r.db.QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取标签统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        stats := make(map[string]int64)
        for rows.Next() </span><span class="cov0" title="0">{
                var tag string
                var count int64
                err := rows.Scan(&amp;tag, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描标签统计数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">stats[tag] = count</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历标签统计数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return stats, nil</span>
}

// GetPopular 获取热门知识
func (r *knowledgeRepository) GetPopular(ctx context.Context, limit int) ([]*models.Knowledge, error) <span class="cov0" title="0">{
        query := `
                SELECT id, title, content, summary, type, status, visibility, format, 
                       category_id, author_id, team_id, language, tags, keywords, 
                       view_count, like_count, dislike_count, share_count, comment_count, 
                       download_count, rating, rating_count, is_featured, is_template, 
                       template_data, metadata, related_ids, expires_at, 
                       created_at, updated_at, published_at, last_viewed_at
                FROM knowledge 
                WHERE deleted_at IS NULL AND status = $1
                ORDER BY view_count DESC, like_count DESC, created_at DESC
                LIMIT $2`

        rows, err := r.db.QueryContext(ctx, query, models.KnowledgeStatusPublished, limit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取热门知识失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var knowledge []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var k models.Knowledge
                var tagsJSON, keywordsJSON, templateDataJSON, metadataJSON, relatedIDsJSON sql.NullString

                var dislikeCount, shareCount, commentCount, downloadCount, ratingCount int64
                var rating sql.NullFloat64
                var lastViewedAt sql.NullTime

                err := rows.Scan(
                        &amp;k.ID, &amp;k.Title, &amp;k.Content, &amp;k.Summary, &amp;k.Type, &amp;k.Status, &amp;k.Visibility, &amp;k.Format,
                        &amp;k.CategoryID, &amp;k.AuthorID, &amp;k.TeamID, &amp;k.Language, &amp;tagsJSON, &amp;keywordsJSON,
                        &amp;k.ViewCount, &amp;k.LikeCount, &amp;dislikeCount, &amp;shareCount, &amp;commentCount,
                        &amp;downloadCount, &amp;rating, &amp;ratingCount, &amp;k.IsFeatured, &amp;k.IsTemplate,
                        &amp;templateDataJSON, &amp;metadataJSON, &amp;relatedIDsJSON, &amp;k.ExpiresAt,
                        &amp;k.CreatedAt, &amp;k.UpdatedAt, &amp;k.PublishedAt, &amp;lastViewedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识数据失败: %w", err)
                }</span>

                // 设置指标数据
                <span class="cov0" title="0">k.Metrics = &amp;models.KnowledgeMetrics{
                        ViewCount:     k.ViewCount,
                        LikeCount:     k.LikeCount,
                        DislikeCount:  dislikeCount,
                        ShareCount:    shareCount,
                        CommentCount:  commentCount,
                        DownloadCount: downloadCount,
                        RatingCount:   ratingCount,
                }
                if rating.Valid </span><span class="cov0" title="0">{
                        k.Metrics.Rating = &amp;rating.Float64
                }</span>
                <span class="cov0" title="0">if lastViewedAt.Valid </span><span class="cov0" title="0">{
                        k.Metrics.LastViewedAt = &amp;lastViewedAt.Time
                }</span>
                <span class="cov0" title="0">if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识数据失败: %w", err)
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if tagsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(tagsJSON.String), &amp;k.Tags)
                }</span>
                <span class="cov0" title="0">if keywordsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(keywordsJSON.String), &amp;k.Keywords)
                }</span>
                <span class="cov0" title="0">if templateDataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(templateDataJSON.String), &amp;k.TemplateData)
                }</span>
                <span class="cov0" title="0">if metadataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(metadataJSON.String), &amp;k.Metadata)
                }</span>
                <span class="cov0" title="0">if relatedIDsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(relatedIDsJSON.String), &amp;k.RelatedIDs)
                }</span>

                <span class="cov0" title="0">knowledge = append(knowledge, &amp;k)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历知识数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return knowledge, nil</span>
}

// GetRecent 获取最近知识
func (r *knowledgeRepository) GetRecent(ctx context.Context, limit int) ([]*models.Knowledge, error) <span class="cov0" title="0">{
        query := `
                SELECT id, title, content, summary, type, status, visibility, format, 
                       category_id, author_id, team_id, language, tags, keywords, 
                       view_count, like_count, dislike_count, share_count, comment_count, 
                       download_count, rating, rating_count, is_featured, is_template, 
                       template_data, metadata, related_ids, expires_at, 
                       created_at, updated_at, published_at, last_viewed_at
                FROM knowledge 
                WHERE deleted_at IS NULL AND status = $1
                ORDER BY created_at DESC, updated_at DESC
                LIMIT $2`

        rows, err := r.db.QueryContext(ctx, query, models.KnowledgeStatusPublished, limit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取最近知识失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var knowledge []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var k models.Knowledge
                var tagsJSON, keywordsJSON, templateDataJSON, metadataJSON, relatedIDsJSON sql.NullString
                var dislikeCount, shareCount, commentCount, downloadCount, ratingCount int64
                var rating sql.NullFloat64
                var lastViewedAt sql.NullTime

                err := rows.Scan(
                        &amp;k.ID, &amp;k.Title, &amp;k.Content, &amp;k.Summary, &amp;k.Type, &amp;k.Status, &amp;k.Visibility, &amp;k.Format,
                        &amp;k.CategoryID, &amp;k.AuthorID, &amp;k.TeamID, &amp;k.Language, &amp;tagsJSON, &amp;keywordsJSON,
                        &amp;k.ViewCount, &amp;k.LikeCount, &amp;dislikeCount, &amp;shareCount, &amp;commentCount,
                        &amp;downloadCount, &amp;rating, &amp;ratingCount, &amp;k.IsFeatured, &amp;k.IsTemplate,
                        &amp;templateDataJSON, &amp;metadataJSON, &amp;relatedIDsJSON, &amp;k.ExpiresAt,
                        &amp;k.CreatedAt, &amp;k.UpdatedAt, &amp;k.PublishedAt, &amp;lastViewedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识数据失败: %w", err)
                }</span>

                // 设置指标数据
                <span class="cov0" title="0">k.Metrics = &amp;models.KnowledgeMetrics{
                        ViewCount:     k.ViewCount,
                        LikeCount:     k.LikeCount,
                        DislikeCount:  dislikeCount,
                        ShareCount:    shareCount,
                        CommentCount:  commentCount,
                        DownloadCount: downloadCount,
                        RatingCount:   ratingCount,
                }
                if rating.Valid </span><span class="cov0" title="0">{
                        k.Metrics.Rating = &amp;rating.Float64
                }</span>
                <span class="cov0" title="0">if lastViewedAt.Valid </span><span class="cov0" title="0">{
                        k.Metrics.LastViewedAt = &amp;lastViewedAt.Time
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if tagsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(tagsJSON.String), &amp;k.Tags)
                }</span>
                <span class="cov0" title="0">if keywordsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(keywordsJSON.String), &amp;k.Keywords)
                }</span>
                <span class="cov0" title="0">if templateDataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(templateDataJSON.String), &amp;k.TemplateData)
                }</span>
                <span class="cov0" title="0">if metadataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(metadataJSON.String), &amp;k.Metadata)
                }</span>
                <span class="cov0" title="0">if relatedIDsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(relatedIDsJSON.String), &amp;k.RelatedIDs)
                }</span>

                <span class="cov0" title="0">knowledge = append(knowledge, &amp;k)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历知识数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return knowledge, nil</span>
}

// GetRelated 获取相关知识
func (r *knowledgeRepository) GetRelated(ctx context.Context, knowledgeID string, limit int) ([]*models.Knowledge, error) <span class="cov0" title="0">{
        query := `
                SELECT DISTINCT k.id, k.title, k.content, k.summary, k.type, k.status, k.visibility, k.format, 
                       k.category_id, k.author_id, k.team_id, k.language, k.tags, k.keywords, 
                       k.view_count, k.like_count, 0 as dislike_count, 0 as share_count, 0 as comment_count, 
                       0 as download_count, NULL as rating, 0 as rating_count, k.is_featured, k.is_template, 
                       k.template_data, k.metadata, k.related_ids, k.expires_at, 
                       k.created_at, k.updated_at, k.published_at, NULL as last_viewed_at
                FROM knowledge k
                WHERE k.deleted_at IS NULL 
                  AND k.status = $1 
                  AND k.id != $2
                  AND (
                          k.category_id = (SELECT category_id FROM knowledge WHERE id = $2)
                          OR k.tags &amp;&amp; (SELECT tags FROM knowledge WHERE id = $2)
                          OR k.keywords &amp;&amp; (SELECT keywords FROM knowledge WHERE id = $2)
                  )
                ORDER BY k.view_count DESC, k.like_count DESC, k.created_at DESC
                LIMIT $3`

        rows, err := r.db.QueryContext(ctx, query, models.KnowledgeStatusPublished, knowledgeID, limit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取相关知识失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var knowledge []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var k models.Knowledge
                var tagsJSON, keywordsJSON, templateDataJSON, metadataJSON, relatedIDsJSON sql.NullString
                var dislikeCount, shareCount, commentCount, downloadCount, ratingCount int64
                var rating sql.NullFloat64
                var lastViewedAt sql.NullTime

                err := rows.Scan(
                        &amp;k.ID, &amp;k.Title, &amp;k.Content, &amp;k.Summary, &amp;k.Type, &amp;k.Status, &amp;k.Visibility, &amp;k.Format,
                        &amp;k.CategoryID, &amp;k.AuthorID, &amp;k.TeamID, &amp;k.Language, &amp;tagsJSON, &amp;keywordsJSON,
                        &amp;k.ViewCount, &amp;k.LikeCount, &amp;dislikeCount, &amp;shareCount, &amp;commentCount,
                        &amp;downloadCount, &amp;rating, &amp;ratingCount, &amp;k.IsFeatured, &amp;k.IsTemplate,
                        &amp;templateDataJSON, &amp;metadataJSON, &amp;relatedIDsJSON, &amp;k.ExpiresAt,
                        &amp;k.CreatedAt, &amp;k.UpdatedAt, &amp;k.PublishedAt, &amp;lastViewedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识数据失败: %w", err)
                }</span>

                // 设置指标数据
                <span class="cov0" title="0">k.Metrics = &amp;models.KnowledgeMetrics{
                        ViewCount:     k.ViewCount,
                        LikeCount:     k.LikeCount,
                        DislikeCount:  dislikeCount,
                        ShareCount:    shareCount,
                        CommentCount:  commentCount,
                        DownloadCount: downloadCount,
                        RatingCount:   ratingCount,
                }
                if rating.Valid </span><span class="cov0" title="0">{
                        k.Metrics.Rating = &amp;rating.Float64
                }</span>
                <span class="cov0" title="0">if lastViewedAt.Valid </span><span class="cov0" title="0">{
                        k.Metrics.LastViewedAt = &amp;lastViewedAt.Time
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if tagsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(tagsJSON.String), &amp;k.Tags)
                }</span>
                <span class="cov0" title="0">if keywordsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(keywordsJSON.String), &amp;k.Keywords)
                }</span>
                <span class="cov0" title="0">if templateDataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(templateDataJSON.String), &amp;k.TemplateData)
                }</span>
                <span class="cov0" title="0">if metadataJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(metadataJSON.String), &amp;k.Metadata)
                }</span>
                <span class="cov0" title="0">if relatedIDsJSON.Valid </span><span class="cov0" title="0">{
                        json.Unmarshal([]byte(relatedIDsJSON.String), &amp;k.RelatedIDs)
                }</span>

                <span class="cov0" title="0">knowledge = append(knowledge, &amp;k)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历知识数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return knowledge, nil</span>
}

// AddAttachment 添加附件
func (r *knowledgeRepository) AddAttachment(ctx context.Context, attachment *models.KnowledgeAttachment) error <span class="cov0" title="0">{
        if attachment.ID == "" </span><span class="cov0" title="0">{
                attachment.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">attachment.CreatedAt = time.Now()

        query := `
                INSERT INTO knowledge_attachments (
                        id, article_id, filename, original_filename, file_path, file_size, mime_type, uploaded_by, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                        attachment.ID, attachment.KnowledgeID, attachment.FileName,
                        attachment.FilePath, attachment.FileSize, attachment.MimeType, attachment.UploadBy, attachment.CreatedAt,
                )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("添加附件失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetAttachments 获取文章附件
func (r *knowledgeRepository) GetAttachments(ctx context.Context, articleID string) ([]*models.KnowledgeAttachment, error) <span class="cov0" title="0">{
        query := `
                SELECT id, article_id, filename, original_filename, file_path, file_size, mime_type, uploaded_by, created_at
                FROM knowledge_attachments 
                WHERE article_id = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, articleID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取文章附件失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var attachments []*models.KnowledgeAttachment
        for rows.Next() </span><span class="cov0" title="0">{
                var attachment models.KnowledgeAttachment
                err := rows.Scan(
                        &amp;attachment.ID, &amp;attachment.KnowledgeID, &amp;attachment.FileName,
                        &amp;attachment.FilePath, &amp;attachment.FileSize, &amp;attachment.MimeType, &amp;attachment.UploadBy, &amp;attachment.CreatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描附件数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">attachments = append(attachments, &amp;attachment)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历附件数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return attachments, nil</span>
}

// RemoveAttachment 删除附件
func (r *knowledgeRepository) RemoveAttachment(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE knowledge_attachments SET 
                        deleted_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除附件失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// GetMetrics 获取知识库指标
func (r *knowledgeRepository) GetMetrics(ctx context.Context, period string) (*models.KnowledgeMetrics, error) <span class="cov0" title="0">{
        metrics := &amp;models.KnowledgeMetrics{}

        // 获取总浏览数
        err := sqlx.GetContext(ctx, r.db, &amp;metrics.ViewCount, "SELECT COALESCE(SUM(view_count), 0) FROM knowledge WHERE deleted_at IS NULL")
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取总浏览数失败: %w", err)
        }</span>

        // 获取总点赞数
        <span class="cov0" title="0">err = sqlx.GetContext(ctx, r.db, &amp;metrics.LikeCount, "SELECT COALESCE(SUM(like_count), 0) FROM knowledge WHERE deleted_at IS NULL")
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取总点赞数失败: %w", err)
        }</span>

        // 获取总评分
        <span class="cov0" title="0">err = sqlx.GetContext(ctx, r.db, &amp;metrics.Rating, "SELECT COALESCE(AVG(rating), 0) FROM knowledge WHERE deleted_at IS NULL AND rating &gt; 0")
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取平均评分失败: %w", err)
        }</span>

        // 获取评分数量
        <span class="cov0" title="0">err = sqlx.GetContext(ctx, r.db, &amp;metrics.RatingCount, "SELECT COUNT(*) FROM knowledge WHERE deleted_at IS NULL AND rating &gt; 0")
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取评分数量失败: %w", err)
        }</span>

        <span class="cov0" title="0">return metrics, nil</span>
}

// GetStats 获取知识库统计
func (r *knowledgeRepository) GetStats(ctx context.Context, filter *models.KnowledgeFilter) (*models.KnowledgeStats, error) <span class="cov0" title="0">{
        stats := &amp;models.KnowledgeStats{
                ByStatus:     make(map[models.KnowledgeStatus]int64),
                ByType:       make(map[models.KnowledgeType]int64),
                ByVisibility: make(map[models.KnowledgeVisibility]int64),
                ByFormat:     make(map[models.KnowledgeFormat]int64),
        }

        // 按状态统计
        statusQuery := `
                SELECT status, COUNT(*) 
                FROM knowledge 
                WHERE deleted_at IS NULL 
                GROUP BY status`

        rows, err := r.db.QueryContext(ctx, statusQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按状态统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        for rows.Next() </span><span class="cov0" title="0">{
                var status string
                var count int64
                err := rows.Scan(&amp;status, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描状态统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">stats.ByStatus[models.KnowledgeStatus(status)] = count
                stats.Total += count
                if status == string(models.KnowledgeStatusPublished) </span><span class="cov0" title="0">{
                        stats.PublishedCount = count
                }</span> else<span class="cov0" title="0"> if status == string(models.KnowledgeStatusDraft) </span><span class="cov0" title="0">{
                        stats.DraftCount = count
                }</span>
        }

        // 按类型统计
        <span class="cov0" title="0">typeQuery := `
                SELECT type, COUNT(*) 
                FROM knowledge 
                WHERE deleted_at IS NULL 
                GROUP BY type`

        typeRows, err := r.db.QueryContext(ctx, typeQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按类型统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer typeRows.Close()

        for typeRows.Next() </span><span class="cov0" title="0">{
                var kType string
                var count int64
                err := typeRows.Scan(&amp;kType, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描类型统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">stats.ByType[models.KnowledgeType(kType)] = count</span>
        }

        // 获取其他统计信息
        <span class="cov0" title="0">err = r.getExecutor().QueryRowxContext(ctx, "SELECT COALESCE(SUM(view_count), 0) FROM knowledge WHERE deleted_at IS NULL").Scan(&amp;stats.TotalViews)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取总浏览数失败: %w", err)
        }</span>

        <span class="cov0" title="0">err = r.getExecutor().QueryRowxContext(ctx, "SELECT COALESCE(SUM(like_count), 0) FROM knowledge WHERE deleted_at IS NULL").Scan(&amp;stats.TotalLikes)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取总点赞数失败: %w", err)
        }</span>

        <span class="cov0" title="0">err = r.getExecutor().QueryRowxContext(ctx, "SELECT COUNT(*) FROM knowledge WHERE deleted_at IS NULL AND is_featured = true").Scan(&amp;stats.FeaturedCount)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取推荐数失败: %w", err)
        }</span>

        <span class="cov0" title="0">err = r.getExecutor().QueryRowxContext(ctx, "SELECT COALESCE(AVG(CASE WHEN rating IS NOT NULL THEN rating ELSE 0 END), 0) FROM knowledge WHERE deleted_at IS NULL").Scan(&amp;stats.AvgRating)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取平均评分失败: %w", err)
        }</span>

        <span class="cov0" title="0">return stats, nil</span>
}

// BatchCreate 批量创建文章
func (r *knowledgeRepository) BatchCreate(ctx context.Context, articles []*models.KnowledgeArticle) error <span class="cov0" title="0">{
        if len(articles) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, article := range articles </span><span class="cov0" title="0">{
                if article.ID == "" </span><span class="cov0" title="0">{
                        article.ID = uuid.New().String()
                }</span>

                <span class="cov0" title="0">now := time.Now()
                article.CreatedAt = now
                article.UpdatedAt = now
                article.Version = "1"

                if article.Status == "" </span><span class="cov0" title="0">{
                        article.Status = models.KnowledgeStatusDraft
                }</span>

                // 序列化标签和元数据
                <span class="cov0" title="0">tagsJSON, err := json.Marshal(article.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">metadataJSON, err := json.Marshal(article.Metadata)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化元数据失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        INSERT INTO knowledge_articles (
                                id, title, content, summary, category_id, status, type, language,
                                author_id, reviewer_id, tags, metadata, version, view_count, like_count,
                                is_featured, is_public, created_at, updated_at
                        ) VALUES (
                                $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19
                        )`

                _, err = tx.ExecContext(ctx, query,
                        article.ID, article.Title, article.Content, article.Summary, article.CategoryID,
                        article.Status, article.Type, article.Language, article.AuthorID, article.ReviewerID,
                        string(tagsJSON), string(metadataJSON), article.Version, article.ViewCount, article.LikeCount,
                        article.IsFeatured, article.IsPublic, article.CreatedAt, article.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建文章失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchUpdate 批量更新文章
func (r *knowledgeRepository) BatchUpdate(ctx context.Context, articles []*models.KnowledgeArticle) error <span class="cov0" title="0">{
        if len(articles) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, article := range articles </span><span class="cov0" title="0">{
                article.UpdatedAt = time.Now()
                // 版本号递增（字符串类型）
                if article.Version == "" </span><span class="cov0" title="0">{
                        article.Version = "1"
                }</span> else<span class="cov0" title="0"> {
                        // 简单的版本号递增，假设版本号是数字字符串
                        version := "1"
                        if article.Version != "" </span><span class="cov0" title="0">{
                                version = fmt.Sprintf("%s.1", article.Version)
                        }</span>
                        <span class="cov0" title="0">article.Version = version</span>
                }

                // 序列化标签和元数据
                <span class="cov0" title="0">tagsJSON, err := json.Marshal(article.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">metadataJSON, err := json.Marshal(article.Metadata)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化元数据失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        UPDATE knowledge_articles SET 
                                title = $1,
                                content = $2,
                                summary = $3,
                                category_id = $4,
                                status = $5,
                                type = $6,
                                language = $7,
                                reviewer_id = $8,
                                tags = $9,
                                metadata = $10,
                                version = $11,
                                is_featured = $12,
                                is_public = $13,
                                updated_at = $14
                        WHERE id = $15 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query,
                        article.Title, article.Content, article.Summary, article.CategoryID,
                        article.Status, article.Type, article.Language, article.ReviewerID,
                        string(tagsJSON), string(metadataJSON), article.Version,
                        article.IsFeatured, article.IsPublic, article.UpdatedAt, article.ID,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新文章失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除文章
func (r *knowledgeRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE knowledge_articles SET 
                                deleted_at = $1,
                                updated_at = $1
                        WHERE id = $2 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量删除文章失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchArchive 批量归档文章
func (r *knowledgeRepository) BatchArchive(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE knowledge_articles SET 
                                status = $1,
                                updated_at = $2
                        WHERE id = $3 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query, models.KnowledgeStatusArchived, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量归档文章失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchPublish 批量发布文章
func (r *knowledgeRepository) BatchPublish(ctx context.Context, ids []string, publisherID string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE knowledge_articles SET 
                                status = $1,
                                published_at = $2,
                                published_by = $3,
                                updated_at = $2
                        WHERE id = $4 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query, models.KnowledgeStatusPublished, now, publisherID, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量发布文章失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// CleanupDrafts 清理指定时间之前的草稿
func (r *knowledgeRepository) CleanupDrafts(ctx context.Context, before time.Time) (int64, error) <span class="cov0" title="0">{
        query := `
                DELETE FROM knowledge 
                WHERE status = $1 AND created_at &lt; $2
        `
        
        result, err := r.db.ExecContext(ctx, query, models.KnowledgeStatusDraft, before)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理草稿失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取影响行数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return rowsAffected, nil</span>
}

// CleanupExpired 清理过期的知识库文章
func (r *knowledgeRepository) CleanupExpired(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        query := `
                UPDATE knowledge 
                SET status = $1, updated_at = CURRENT_TIMESTAMP
                WHERE status = $2 AND expires_at IS NOT NULL AND expires_at &lt; CURRENT_TIMESTAMP
        `
        
        result, err := r.db.ExecContext(ctx, query, models.KnowledgeStatusExpired, models.KnowledgeStatusPublished)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理过期文章失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取影响行数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return rowsAffected, nil</span>
}

// CreateTag 创建知识标签
func (r *knowledgeRepository) CreateTag(ctx context.Context, tag *models.KnowledgeTag) error <span class="cov0" title="0">{
        query := `
                INSERT INTO knowledge_tags (id, name, description, color, usage_count, created_at, updated_at)
                VALUES ($1, $2, $3, $4, $5, $6, $7)
        `
        
        now := time.Now()
        _, err := r.db.ExecContext(ctx, query,
                tag.ID, tag.Name, tag.Description, tag.Color, tag.UsageCount, now, now)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建知识标签失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetTags 获取所有知识标签
func (r *knowledgeRepository) GetTags(ctx context.Context) ([]*models.KnowledgeTag, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, color, usage_count, created_at, updated_at
                FROM knowledge_tags
                ORDER BY usage_count DESC, name ASC
        `
        
        rows, err := r.db.QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取知识标签失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()
        
        var tags []*models.KnowledgeTag
        for rows.Next() </span><span class="cov0" title="0">{
                var tag models.KnowledgeTag
                err := rows.Scan(
                        &amp;tag.ID, &amp;tag.Name, &amp;tag.Description, &amp;tag.Color,
                        &amp;tag.UsageCount, &amp;tag.CreatedAt, &amp;tag.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识标签失败: %w", err)
                }</span>
                <span class="cov0" title="0">tags = append(tags, &amp;tag)</span>
        }
        
        <span class="cov0" title="0">return tags, nil</span>
}

// GetTag 根据ID获取知识标签
func (r *knowledgeRepository) GetTag(ctx context.Context, id string) (*models.KnowledgeTag, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, color, usage_count, created_at, updated_at
                FROM knowledge_tags
                WHERE id = $1
        `
        
        var tag models.KnowledgeTag
        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;tag.ID, &amp;tag.Name, &amp;tag.Description, &amp;tag.Color,
                &amp;tag.UsageCount, &amp;tag.CreatedAt, &amp;tag.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取知识标签失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return &amp;tag, nil</span>
}

// UpdateTag 更新知识标签
func (r *knowledgeRepository) UpdateTag(ctx context.Context, tag *models.KnowledgeTag) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_tags
                SET name = $1, description = $2, color = $3, updated_at = $4
                WHERE id = $5
        `
        
        now := time.Now()
        _, err := r.db.ExecContext(ctx, query,
                tag.Name, tag.Description, tag.Color, now, tag.ID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新知识标签失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// DeleteTag 删除知识标签
func (r *knowledgeRepository) DeleteTag(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `DELETE FROM knowledge_tags WHERE id = $1`
        
        _, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除知识标签失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetKnowledgeByTag 根据标签获取知识
func (r *knowledgeRepository) GetKnowledgeByTag(ctx context.Context, tagName string, filter *models.KnowledgeFilter) (*models.KnowledgeList, error) <span class="cov0" title="0">{
        // 这里简化实现，实际应该根据标签关联查询
        filter.Tags = []string{tagName}
        return r.List(ctx, filter)
}</span>

// UpdateTagUsage 更新标签使用次数
func (r *knowledgeRepository) UpdateTagUsage(ctx context.Context, tagName string, delta int64) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_tags
                SET usage_count = usage_count + $1, updated_at = CURRENT_TIMESTAMP
                WHERE name = $2
        `
        
        _, err := r.db.ExecContext(ctx, query, delta, tagName)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新标签使用次数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// DeleteAttachment 删除知识库附件
func (r *knowledgeRepository) DeleteAttachment(ctx context.Context, attachmentID string) error <span class="cov0" title="0">{
        query := `
                UPDATE knowledge_attachments 
                SET deleted_at = CURRENT_TIMESTAMP
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        _, err := r.db.ExecContext(ctx, query, attachmentID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除知识库附件失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetCategory 根据ID获取知识分类
func (r *knowledgeRepository) GetCategory(ctx context.Context, id string) (*models.KnowledgeCategory, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, parent_id, path, level, sort_order, icon, color, is_active, created_at, updated_at
                FROM knowledge_categories
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        var category models.KnowledgeCategory
        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;category.ID, &amp;category.Name, &amp;category.Description, &amp;category.ParentID,
                &amp;category.Path, &amp;category.Level, &amp;category.SortOrder, &amp;category.Icon,
                &amp;category.Color, &amp;category.IsActive, &amp;category.CreatedAt, &amp;category.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取知识分类失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return &amp;category, nil</span>
}

// GetFeatured 获取推荐知识列表
func (r *knowledgeRepository) GetFeatured(ctx context.Context, limit int) ([]*models.Knowledge, error) <span class="cov0" title="0">{
        query := `
                SELECT id, title, slug, summary, content, type, status, visibility, format, 
                       category_id, tags, keywords, language, version, author_id, author_name,
                       reviewer_id, reviewer_name, team_id, team_name, priority, sort_order,
                       is_featured, is_template, template_data, metadata, view_count, like_count,
                       related_ids, expires_at, published_at, archived_at, reviewed_at,
                       last_edited_at, created_at, updated_at
                FROM knowledge
                WHERE is_featured = true AND status = $1 AND deleted_at IS NULL
                ORDER BY sort_order ASC, created_at DESC
                LIMIT $2
        `
        
        rows, err := r.db.QueryContext(ctx, query, models.KnowledgeStatusPublished, limit)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取推荐知识列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()
        
        var knowledgeList []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var knowledge models.Knowledge
                err := rows.Scan(
                        &amp;knowledge.ID, &amp;knowledge.Title, &amp;knowledge.Slug, &amp;knowledge.Summary,
                        &amp;knowledge.Content, &amp;knowledge.Type, &amp;knowledge.Status, &amp;knowledge.Visibility,
                        &amp;knowledge.Format, &amp;knowledge.CategoryID, &amp;knowledge.Tags, &amp;knowledge.Keywords,
                        &amp;knowledge.Language, &amp;knowledge.Version, &amp;knowledge.AuthorID, &amp;knowledge.AuthorName,
                        &amp;knowledge.ReviewerID, &amp;knowledge.ReviewerName, &amp;knowledge.TeamID, &amp;knowledge.TeamName,
                        &amp;knowledge.Priority, &amp;knowledge.SortOrder, &amp;knowledge.IsFeatured, &amp;knowledge.IsTemplate,
                        &amp;knowledge.TemplateData, &amp;knowledge.Metadata, &amp;knowledge.ViewCount, &amp;knowledge.LikeCount,
                        &amp;knowledge.RelatedIDs, &amp;knowledge.ExpiresAt, &amp;knowledge.PublishedAt, &amp;knowledge.ArchivedAt,
                        &amp;knowledge.ReviewedAt, &amp;knowledge.LastEditedAt, &amp;knowledge.CreatedAt, &amp;knowledge.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描推荐知识数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">knowledgeList = append(knowledgeList, &amp;knowledge)</span>
        }
        
        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历推荐知识数据失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return knowledgeList, nil</span>
}

// GetKnowledgeByCategory 根据分类获取知识列表
func (r *knowledgeRepository) GetKnowledgeByCategory(ctx context.Context, categoryID string, filter *models.KnowledgeFilter) (*models.KnowledgeList, error) <span class="cov0" title="0">{
        // 设置默认值
        if filter.Page &lt;= 0 </span><span class="cov0" title="0">{
                filter.Page = 1
        }</span>
        <span class="cov0" title="0">if filter.PageSize &lt;= 0 </span><span class="cov0" title="0">{
                filter.PageSize = 20
        }</span>
        
        <span class="cov0" title="0">offset := (filter.Page - 1) * filter.PageSize
        
        // 获取总数
        countQuery := `
                SELECT COUNT(*)
                FROM knowledge
                WHERE category_id = $1 AND status = $2 AND deleted_at IS NULL
        `
        
        var total int64
        err := r.getExecutor().QueryRowxContext(ctx, countQuery, categoryID, models.KnowledgeStatusPublished).Scan(&amp;total)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取分类知识总数失败: %w", err)
        }</span>
        
        // 获取知识列表
        <span class="cov0" title="0">query := `
                SELECT id, title, slug, summary, content, type, status, visibility, format, 
                       category_id, tags, keywords, language, version, author_id, author_name,
                       reviewer_id, reviewer_name, team_id, team_name, priority, sort_order,
                       is_featured, is_template, template_data, metadata, view_count, like_count,
                       related_ids, expires_at, published_at, archived_at, reviewed_at,
                       last_edited_at, created_at, updated_at
                FROM knowledge
                WHERE category_id = $1 AND status = $2 AND deleted_at IS NULL
                ORDER BY sort_order ASC, created_at DESC
                LIMIT $3 OFFSET $4
        `
        
        rows, err := r.db.QueryContext(ctx, query, categoryID, models.KnowledgeStatusPublished, filter.PageSize, offset)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取分类知识列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()
        
        var knowledgeList []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var knowledge models.Knowledge
                err := rows.Scan(
                        &amp;knowledge.ID, &amp;knowledge.Title, &amp;knowledge.Slug, &amp;knowledge.Summary,
                        &amp;knowledge.Content, &amp;knowledge.Type, &amp;knowledge.Status, &amp;knowledge.Visibility,
                        &amp;knowledge.Format, &amp;knowledge.CategoryID, &amp;knowledge.Tags, &amp;knowledge.Keywords,
                        &amp;knowledge.Language, &amp;knowledge.Version, &amp;knowledge.AuthorID, &amp;knowledge.AuthorName,
                        &amp;knowledge.ReviewerID, &amp;knowledge.ReviewerName, &amp;knowledge.TeamID, &amp;knowledge.TeamName,
                        &amp;knowledge.Priority, &amp;knowledge.SortOrder, &amp;knowledge.IsFeatured, &amp;knowledge.IsTemplate,
                        &amp;knowledge.TemplateData, &amp;knowledge.Metadata, &amp;knowledge.ViewCount, &amp;knowledge.LikeCount,
                        &amp;knowledge.RelatedIDs, &amp;knowledge.ExpiresAt, &amp;knowledge.PublishedAt, &amp;knowledge.ArchivedAt,
                        &amp;knowledge.ReviewedAt, &amp;knowledge.LastEditedAt, &amp;knowledge.CreatedAt, &amp;knowledge.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描分类知识数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">knowledgeList = append(knowledgeList, &amp;knowledge)</span>
        }
        
        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历分类知识数据失败: %w", err)
        }</span>
        
        // 计算总页数
        <span class="cov0" title="0">totalPages := int((total + int64(filter.PageSize) - 1) / int64(filter.PageSize))
        
        return &amp;models.KnowledgeList{
                Knowledge:  knowledgeList,
                Total:      total,
                Page:       filter.Page,
                PageSize:   filter.PageSize,
                TotalPages: totalPages,
        }, nil</span>
}

// Search 搜索知识库
func (r *knowledgeRepository) Search(ctx context.Context, query string, filter *models.KnowledgeFilter) (*models.KnowledgeSearchResult, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1
        
        // 基础搜索条件
        conditions = append(conditions, "deleted_at IS NULL")
        
        // 全文搜索
        if query != "" </span><span class="cov0" title="0">{
                conditions = append(conditions, "(title ILIKE $"+fmt.Sprintf("%d", argIndex)+" OR content ILIKE $"+fmt.Sprintf("%d", argIndex)+")")
                args = append(args, "%"+query+"%")
                argIndex++
        }</span>
        
        // 应用过滤器
        <span class="cov0" title="0">if filter != nil </span><span class="cov0" title="0">{
                if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, "status = $"+fmt.Sprintf("%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>
                
                <span class="cov0" title="0">if filter.CategoryID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, "category_id = $"+fmt.Sprintf("%d", argIndex))
                        args = append(args, *filter.CategoryID)
                        argIndex++
                }</span>
                
                <span class="cov0" title="0">if filter.AuthorID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, "author_id = $"+fmt.Sprintf("%d", argIndex))
                        args = append(args, *filter.AuthorID)
                        argIndex++
                }</span>
        }
        
        // 构建查询
        <span class="cov0" title="0">baseQuery := `
                SELECT id, title, slug, summary, content, status, category_id, author_id,
                       view_count, like_count, dislike_count, share_count, download_count,
                       rating, rating_count, featured, created_at, updated_at, published_at
                FROM knowledge
                WHERE ` + strings.Join(conditions, " AND ")
        
        // 排序
        orderBy := "ORDER BY created_at DESC"
        if filter != nil &amp;&amp; filter.SortBy != nil </span><span class="cov0" title="0">{
                switch *filter.SortBy </span>{
                case "title":<span class="cov0" title="0">
                        orderBy = "ORDER BY title"</span>
                case "view_count":<span class="cov0" title="0">
                        orderBy = "ORDER BY view_count DESC"</span>
                case "rating":<span class="cov0" title="0">
                        orderBy = "ORDER BY rating DESC"</span>
                case "updated_at":<span class="cov0" title="0">
                        orderBy = "ORDER BY updated_at DESC"</span>
                }
                
                <span class="cov0" title="0">if filter.SortOrder != nil &amp;&amp; *filter.SortOrder == "asc" </span><span class="cov0" title="0">{
                        orderBy = strings.Replace(orderBy, "DESC", "ASC", 1)
                }</span>
        }
        
        // 分页
        <span class="cov0" title="0">limit := 20
        offset := 0
        if filter != nil </span><span class="cov0" title="0">{
                if filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                        limit = filter.PageSize
                }</span>
                <span class="cov0" title="0">if filter.Page &gt; 0 </span><span class="cov0" title="0">{
                        offset = (filter.Page - 1) * limit
                }</span>
        }
        
        <span class="cov0" title="0">finalQuery := baseQuery + " " + orderBy + " LIMIT $" + fmt.Sprintf("%d", argIndex) + " OFFSET $" + fmt.Sprintf("%d", argIndex+1)
        args = append(args, limit, offset)
        
        // 执行查询
        rows, err := r.db.QueryContext(ctx, finalQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("搜索知识库失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()
        
        var knowledgeList []*models.Knowledge
        for rows.Next() </span><span class="cov0" title="0">{
                var knowledge models.Knowledge
                err := rows.Scan(
                        &amp;knowledge.ID, &amp;knowledge.Title, &amp;knowledge.Slug, &amp;knowledge.Summary,
                        &amp;knowledge.Content, &amp;knowledge.Status, &amp;knowledge.CategoryID, &amp;knowledge.AuthorID,
                        &amp;knowledge.ViewCount, &amp;knowledge.LikeCount, &amp;knowledge.DislikeCount,
                        &amp;knowledge.ShareCount, &amp;knowledge.DownloadCount, &amp;knowledge.Rating,
                        &amp;knowledge.RatingCount, &amp;knowledge.Featured, &amp;knowledge.CreatedAt,
                        &amp;knowledge.UpdatedAt, &amp;knowledge.PublishedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描知识库记录失败: %w", err)
                }</span>
                <span class="cov0" title="0">knowledgeList = append(knowledgeList, &amp;knowledge)</span>
        }
        
        // 获取总数
        <span class="cov0" title="0">countQuery := "SELECT COUNT(*) FROM knowledge WHERE " + strings.Join(conditions, " AND ")
        var total int64
        err = r.getExecutor().QueryRowxContext(ctx, countQuery, args[:len(args)-2]...).Scan(&amp;total)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取搜索结果总数失败: %w", err)
        }</span>
        
        // 计算分页信息
        <span class="cov0" title="0">totalPages := (total + int64(limit) - 1) / int64(limit)
        page := 1
        if filter != nil &amp;&amp; filter.Page &gt; 0 </span><span class="cov0" title="0">{
                page = filter.Page
        }</span>
        
        <span class="cov0" title="0">return &amp;models.KnowledgeSearchResult{
                Knowledge:  knowledgeList,
                Total:      total,
                Page:       page,
                PageSize:   limit,
                TotalPages: int(totalPages),
                Query:      query,
        }, nil</span>
}

// SubmitForReview 提交知识库进行审核
func (r *knowledgeRepository) SubmitForReview(ctx context.Context, id string) error <span class="cov0" title="0">{
        // 检查知识库是否存在且为草稿状态
        var currentStatus models.KnowledgeStatus
        query := `SELECT status FROM knowledge WHERE id = $1 AND deleted_at IS NULL`
        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(&amp;currentStatus)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return fmt.Errorf("知识库不存在")
                }</span>
                <span class="cov0" title="0">return fmt.Errorf("获取知识库状态失败: %w", err)</span>
        }
        
        // 只有草稿状态的知识库才能提交审核
        <span class="cov0" title="0">if currentStatus != models.KnowledgeStatusDraft </span><span class="cov0" title="0">{
                return fmt.Errorf("只有草稿状态的知识库才能提交审核")
        }</span>
        
        // 更新状态为审核中
        <span class="cov0" title="0">updateQuery := `
                UPDATE knowledge 
                SET status = $1, updated_at = CURRENT_TIMESTAMP
                WHERE id = $2 AND deleted_at IS NULL`
        
        _, err = r.db.ExecContext(ctx, updateQuery, models.KnowledgeStatusReview, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("提交审核失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}</pre>
		
		<pre class="file" id="file4" style="display: none">package repository

import (
        "context"

        "github.com/jmoiron/sqlx"
)

// repositoryManager 仓储管理器实现
type repositoryManager struct {
        db *sqlx.DB
        tx *sqlx.Tx

        // 仓储实例
        userRepo       UserRepository
        alertRepo      AlertRepository
        ruleRepo       RuleRepository
        dataSourceRepo DataSourceRepository
        ticketRepo     TicketRepository
        knowledgeRepo  KnowledgeRepository
        permissionRepo PermissionRepository
        authRepo       AuthRepository
}

// NewRepositoryManager 创建新的仓储管理器
func NewRepositoryManager(db *sqlx.DB) RepositoryManager <span class="cov0" title="0">{
        return &amp;repositoryManager{
                db: db,
                userRepo:       NewUserRepository(db),
                alertRepo:      NewAlertRepository(db),
                ruleRepo:       NewRuleRepository(db),
                dataSourceRepo: NewDataSourceRepository(db),
                ticketRepo:     NewTicketRepository(db),
                knowledgeRepo:  NewKnowledgeRepository(db),
                permissionRepo: NewPermissionRepository(db),
                authRepo:       NewAuthRepository(db),
        }
}</span>

// User 获取用户仓储
func (r *repositoryManager) User() UserRepository <span class="cov0" title="0">{
        return r.userRepo
}</span>

// Alert 获取告警仓储
func (r *repositoryManager) Alert() AlertRepository <span class="cov0" title="0">{
        return r.alertRepo
}</span>

// Rule 获取规则仓储
func (r *repositoryManager) Rule() RuleRepository <span class="cov0" title="0">{
        return r.ruleRepo
}</span>

// DataSource 获取数据源仓储
func (r *repositoryManager) DataSource() DataSourceRepository <span class="cov0" title="0">{
        return r.dataSourceRepo
}</span>

// Ticket 获取工单仓储
func (r *repositoryManager) Ticket() TicketRepository <span class="cov0" title="0">{
        return r.ticketRepo
}</span>

// Knowledge 获取知识库仓储
func (r *repositoryManager) Knowledge() KnowledgeRepository <span class="cov0" title="0">{
        return r.knowledgeRepo
}</span>

// Permission 获取权限仓储
func (r *repositoryManager) Permission() PermissionRepository <span class="cov0" title="0">{
        return r.permissionRepo
}</span>

// Auth 获取认证仓储
func (r *repositoryManager) Auth() AuthRepository <span class="cov0" title="0">{
        return r.authRepo
}</span>

// BeginTx 开始事务
func (r *repositoryManager) BeginTx(ctx context.Context) (RepositoryManager, error) <span class="cov0" title="0">{
        tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        <span class="cov0" title="0">return &amp;repositoryManager{
                db: r.db,
                tx: tx,
                userRepo:       NewUserRepositoryWithTx(tx),
                alertRepo:      NewAlertRepositoryWithTx(tx),
                ruleRepo:       NewRuleRepositoryWithTx(tx),
                dataSourceRepo: NewDataSourceRepositoryWithTx(tx),
                ticketRepo:     NewTicketRepositoryWithTx(tx),
                knowledgeRepo:  NewKnowledgeRepositoryWithTx(tx),
                permissionRepo: NewPermissionRepositoryWithTx(tx),
                authRepo:       NewAuthRepositoryWithTx(tx),
        }, nil</span>
}

// Commit 提交事务
func (r *repositoryManager) Commit() error <span class="cov0" title="0">{
        if r.tx == nil </span><span class="cov0" title="0">{
                return nil
        }</span>
        <span class="cov0" title="0">return r.tx.Commit()</span>
}

// Rollback 回滚事务
func (r *repositoryManager) Rollback() error <span class="cov0" title="0">{
        if r.tx == nil </span><span class="cov0" title="0">{
                return nil
        }</span>
        <span class="cov0" title="0">return r.tx.Rollback()</span>
}

// Close 关闭连接
func (r *repositoryManager) Close() error <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                _ = r.tx.Rollback()
        }</span>
        <span class="cov0" title="0">return r.db.Close()</span>
}</pre>
		
		<pre class="file" id="file5" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "fmt"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"
        "github.com/lib/pq"

        "Pulse/internal/models"
)

// permissionRepository 权限仓储实现
type permissionRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewPermissionRepository 创建权限仓储实例
func NewPermissionRepository(db *sqlx.DB) PermissionRepository <span class="cov8" title="1">{
        return &amp;permissionRepository{
                db: db,
        }
}</span>

// NewPermissionRepositoryWithTx 创建带事务的权限仓储实例
func NewPermissionRepositoryWithTx(tx *sqlx.Tx) PermissionRepository <span class="cov0" title="0">{
        return &amp;permissionRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *permissionRepository) getExecutor() sqlx.ExtContext <span class="cov8" title="1">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov8" title="1">return r.db</span>
}

// CheckPermission 检查用户是否有指定权限
func (r *permissionRepository) CheckPermission(ctx context.Context, userID string, permission models.Permission) (bool, error) <span class="cov8" title="1">{
        // 获取用户信息
        var user models.User
        query := `SELECT id, role, status FROM users WHERE id = $1 AND deleted_at IS NULL`
        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;user, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return false, fmt.Errorf("用户不存在")
                }</span>
                <span class="cov0" title="0">return false, fmt.Errorf("获取用户信息失败: %w", err)</span>
        }

        // 检查用户状态
        <span class="cov8" title="1">if !user.IsActive() </span><span class="cov0" title="0">{
                return false, nil
        }</span>

        // 检查角色权限
        <span class="cov8" title="1">if models.HasRolePermission(user.Role, permission) </span><span class="cov8" title="1">{
                // 检查是否有权限覆盖撤销了该权限
                override, err := r.getActivePermissionOverride(ctx, userID, permission)
                if err != nil </span><span class="cov0" title="0">{
                        return false, err
                }</span>
                <span class="cov8" title="1">if override != nil &amp;&amp; !override.Granted </span><span class="cov0" title="0">{
                        return false, nil // 权限被撤销
                }</span>
                <span class="cov8" title="1">return true, nil</span>
        }

        // 检查是否有权限覆盖授予了该权限
        <span class="cov0" title="0">override, err := r.getActivePermissionOverride(ctx, userID, permission)
        if err != nil </span><span class="cov0" title="0">{
                return false, err
        }</span>
        <span class="cov0" title="0">if override != nil &amp;&amp; override.Granted </span><span class="cov0" title="0">{
                return true, nil // 权限被授予
        }</span>

        <span class="cov0" title="0">return false, nil</span>
}

// CheckPermissions 批量检查用户权限
func (r *permissionRepository) CheckPermissions(ctx context.Context, userID string, permissions []models.Permission) (map[models.Permission]bool, error) <span class="cov8" title="1">{
        result := make(map[models.Permission]bool)

        for _, permission := range permissions </span><span class="cov8" title="1">{
                allowed, err := r.CheckPermission(ctx, userID, permission)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, err
                }</span>
                <span class="cov8" title="1">result[permission] = allowed</span>
        }

        <span class="cov8" title="1">return result, nil</span>
}

// GetUserPermissions 获取用户的所有权限
func (r *permissionRepository) GetUserPermissions(ctx context.Context, userID string) ([]models.Permission, error) <span class="cov8" title="1">{
        // 获取用户信息
        var user models.User
        query := `SELECT id, role, status FROM users WHERE id = $1 AND deleted_at IS NULL`
        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;user, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("用户不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户信息失败: %w", err)</span>
        }

        // 检查用户状态
        <span class="cov8" title="1">if !user.IsActive() </span><span class="cov0" title="0">{
                return []models.Permission{}, nil
        }</span>

        // 获取角色权限
        <span class="cov8" title="1">rolePermissions := models.GetRolePermissions(user.Role)
        permissionMap := make(map[models.Permission]bool)

        // 添加角色权限
        for _, perm := range rolePermissions </span><span class="cov8" title="1">{
                permissionMap[perm] = true
        }</span>

        // 获取权限覆盖
        <span class="cov8" title="1">overrides, err := r.GetUserPermissionOverrides(ctx, userID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // 应用权限覆盖
        <span class="cov8" title="1">for _, override := range overrides </span><span class="cov0" title="0">{
                if override.IsActive() </span><span class="cov0" title="0">{
                        if override.Granted </span><span class="cov0" title="0">{
                                permissionMap[override.Permission] = true
                        }</span> else<span class="cov0" title="0"> {
                                delete(permissionMap, override.Permission)
                        }</span>
                }
        }

        // 转换为切片
        <span class="cov8" title="1">var permissions []models.Permission
        for perm := range permissionMap </span><span class="cov8" title="1">{
                permissions = append(permissions, perm)
        }</span>

        <span class="cov8" title="1">return permissions, nil</span>
}

// CreatePermissionGroup 创建权限组
func (r *permissionRepository) CreatePermissionGroup(ctx context.Context, group *models.PermissionGroup) error <span class="cov8" title="1">{
        // 生成ID
        if group.ID == "" </span><span class="cov0" title="0">{
                group.ID = uuid.New().String()
        }</span>

        // 设置时间
        <span class="cov8" title="1">now := time.Now()
        group.CreatedAt = now
        group.UpdatedAt = now

        // 验证权限组
        if err := group.Validate(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        // 转换权限为字符串数组
        <span class="cov8" title="1">permissions := make([]string, len(group.Permissions))
        for i, perm := range group.Permissions </span><span class="cov8" title="1">{
                permissions[i] = string(perm)
        }</span>

        <span class="cov8" title="1">query := `
                INSERT INTO permission_groups (
                        id, name, description, permissions, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6
                )`

        _, err := r.getExecutor().ExecContext(ctx, query, group.ID, group.Name, group.Description, pq.Array(permissions), group.CreatedAt, group.UpdatedAt)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建权限组失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetPermissionGroup 获取权限组
func (r *permissionRepository) GetPermissionGroup(ctx context.Context, id string) (*models.PermissionGroup, error) <span class="cov8" title="1">{
        var group models.PermissionGroup
        var permissionsJSON string

        query := `
                SELECT id, name, description, permissions, created_at, updated_at
                FROM permission_groups 
                WHERE id = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;group.ID, &amp;group.Name, &amp;group.Description, &amp;permissionsJSON,
                &amp;group.CreatedAt, &amp;group.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("权限组不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取权限组失败: %w", err)</span>
        }

        // 解析JSON格式的权限
        <span class="cov8" title="1">var permissionStrings []string
        if err := json.Unmarshal([]byte(permissionsJSON), &amp;permissionStrings); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("解析权限数据失败: %w", err)
        }</span>

        // 转换权限
        <span class="cov8" title="1">group.Permissions = make([]models.Permission, len(permissionStrings))
        for i, perm := range permissionStrings </span><span class="cov8" title="1">{
                group.Permissions[i] = models.Permission(perm)
        }</span>

        <span class="cov8" title="1">return &amp;group, nil</span>
}

// UpdatePermissionGroup 更新权限组
func (r *permissionRepository) UpdatePermissionGroup(ctx context.Context, group *models.PermissionGroup) error <span class="cov8" title="1">{
        group.UpdatedAt = time.Now()

        // 验证权限组
        if err := group.Validate(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        // 转换权限为字符串数组
        <span class="cov8" title="1">permissions := make([]string, len(group.Permissions))
        for i, perm := range group.Permissions </span><span class="cov8" title="1">{
                permissions[i] = string(perm)
        }</span>

        <span class="cov8" title="1">query := `
                UPDATE permission_groups SET 
                        name = $1,
                        description = $2,
                        permissions = $3,
                        updated_at = $4
                WHERE id = $5 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, group.Name, group.Description, pq.Array(permissions), group.UpdatedAt, group.ID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新权限组失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("权限组不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// DeletePermissionGroup 删除权限组
func (r *permissionRepository) DeletePermissionGroup(ctx context.Context, id string) error <span class="cov8" title="1">{
        now := time.Now()
        query := `
                UPDATE permission_groups SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除权限组失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("权限组不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// ListPermissionGroups 获取权限组列表
func (r *permissionRepository) ListPermissionGroups(ctx context.Context) ([]*models.PermissionGroup, error) <span class="cov8" title="1">{
        query := `
                SELECT id, name, description, permissions, created_at, updated_at
                FROM permission_groups 
                WHERE deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取权限组列表失败: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var groups []*models.PermissionGroup
        for rows.Next() </span><span class="cov8" title="1">{
                var group models.PermissionGroup
                var permissionsJSON string

                err := rows.Scan(
                        &amp;group.ID, &amp;group.Name, &amp;group.Description, &amp;permissionsJSON,
                        &amp;group.CreatedAt, &amp;group.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描权限组数据失败: %w", err)
                }</span>

                // 解析JSON权限
                <span class="cov8" title="1">var permissionStrings []string
                if err := json.Unmarshal([]byte(permissionsJSON), &amp;permissionStrings); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("解析权限JSON失败: %w", err)
                }</span>

                // 转换权限
                <span class="cov8" title="1">group.Permissions = make([]models.Permission, len(permissionStrings))
                for i, perm := range permissionStrings </span><span class="cov8" title="1">{
                        group.Permissions[i] = models.Permission(perm)
                }</span>

                <span class="cov8" title="1">groups = append(groups, &amp;group)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历权限组数据失败: %w", err)
        }</span>

        <span class="cov8" title="1">return groups, nil</span>
}

// CreatePermissionOverride 创建用户权限覆盖
func (r *permissionRepository) CreatePermissionOverride(ctx context.Context, override *models.UserPermissionOverride) error <span class="cov8" title="1">{
        // 生成ID
        if override.ID == "" </span><span class="cov8" title="1">{
                override.ID = uuid.New().String()
        }</span>

        // 设置时间
        <span class="cov8" title="1">now := time.Now()
        override.CreatedAt = now
        override.UpdatedAt = now

        // 验证权限覆盖
        if err := override.Validate(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">query := `
                INSERT INTO user_permission_overrides (
                        id, user_id, permission, granted, granted_by, reason, expires_at, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9
                )`

        _, err := r.db.ExecContext(ctx, query,
                override.ID, override.UserID, string(override.Permission), override.Granted,
                override.GrantedBy, override.Reason, override.ExpiresAt,
                override.CreatedAt, override.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建权限覆盖失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetPermissionOverride 获取权限覆盖
func (r *permissionRepository) GetPermissionOverride(ctx context.Context, id string) (*models.UserPermissionOverride, error) <span class="cov8" title="1">{
        var override models.UserPermissionOverride
        var permission string

        query := `
                SELECT id, user_id, permission, granted, granted_by, reason, expires_at, created_at, updated_at
                FROM user_permission_overrides 
                WHERE id = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;override.ID, &amp;override.UserID, &amp;permission, &amp;override.Granted,
                &amp;override.GrantedBy, &amp;override.Reason, &amp;override.ExpiresAt,
                &amp;override.CreatedAt, &amp;override.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("权限覆盖不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取权限覆盖失败: %w", err)</span>
        }

        <span class="cov8" title="1">override.Permission = models.Permission(permission)
        return &amp;override, nil</span>
}

// UpdatePermissionOverride 更新权限覆盖
func (r *permissionRepository) UpdatePermissionOverride(ctx context.Context, override *models.UserPermissionOverride) error <span class="cov0" title="0">{
        override.UpdatedAt = time.Now()

        // 验证权限覆盖
        if err := override.Validate(); err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE user_permission_overrides SET 
                        permission = $1,
                        granted = $2,
                        granted_by = $3,
                        reason = $4,
                        expires_at = $5,
                        updated_at = $6
                WHERE id = $7 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query,
                string(override.Permission), override.Granted, override.GrantedBy,
                override.Reason, override.ExpiresAt, override.UpdatedAt, override.ID,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新权限覆盖失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("权限覆盖不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// DeletePermissionOverride 删除权限覆盖
func (r *permissionRepository) DeletePermissionOverride(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE user_permission_overrides SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除权限覆盖失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("权限覆盖不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetUserPermissionOverrides 获取用户的权限覆盖列表
func (r *permissionRepository) GetUserPermissionOverrides(ctx context.Context, userID string) ([]*models.UserPermissionOverride, error) <span class="cov8" title="1">{
        query := `
                SELECT id, user_id, permission, granted, granted_by, reason, expires_at, created_at, updated_at
                FROM user_permission_overrides 
                WHERE user_id = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, userID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取用户权限覆盖失败: %w", err)
        }</span>
        <span class="cov8" title="1">defer rows.Close()

        var overrides []*models.UserPermissionOverride
        for rows.Next() </span><span class="cov0" title="0">{
                var override models.UserPermissionOverride
                var permission string

                err := rows.Scan(
                        &amp;override.ID, &amp;override.UserID, &amp;permission, &amp;override.Granted,
                        &amp;override.GrantedBy, &amp;override.Reason, &amp;override.ExpiresAt,
                        &amp;override.CreatedAt, &amp;override.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描权限覆盖数据失败: %w", err)
                }</span>

                <span class="cov0" title="0">override.Permission = models.Permission(permission)
                overrides = append(overrides, &amp;override)</span>
        }

        <span class="cov8" title="1">if err := rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历权限覆盖数据失败: %w", err)
        }</span>

        <span class="cov8" title="1">return overrides, nil</span>
}

// GrantPermission 授予用户权限
func (r *permissionRepository) GrantPermission(ctx context.Context, userID string, permission models.Permission, grantedBy, reason string, expiresAt *time.Time) error <span class="cov8" title="1">{
        // 检查是否已存在相同的权限覆盖
        existingOverride, err := r.getActivePermissionOverride(ctx, userID, permission)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">if existingOverride != nil </span><span class="cov0" title="0">{
                // 更新现有的权限覆盖
                existingOverride.Granted = true
                existingOverride.GrantedBy = grantedBy
                existingOverride.Reason = reason
                existingOverride.ExpiresAt = expiresAt
                return r.UpdatePermissionOverride(ctx, existingOverride)
        }</span>

        // 创建新的权限覆盖
        <span class="cov8" title="1">override := &amp;models.UserPermissionOverride{
                UserID:     userID,
                Permission: permission,
                Granted:    true,
                GrantedBy:  grantedBy,
                Reason:     reason,
                ExpiresAt:  expiresAt,
        }

        return r.CreatePermissionOverride(ctx, override)</span>
}

// RevokePermission 撤销用户权限
func (r *permissionRepository) RevokePermission(ctx context.Context, userID string, permission models.Permission, revokedBy, reason string) error <span class="cov8" title="1">{
        // 检查是否已存在相同的权限覆盖
        existingOverride, err := r.getActivePermissionOverride(ctx, userID, permission)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>

        <span class="cov8" title="1">if existingOverride != nil </span><span class="cov0" title="0">{
                // 更新现有的权限覆盖
                existingOverride.Granted = false
                existingOverride.GrantedBy = revokedBy
                existingOverride.Reason = reason
                existingOverride.ExpiresAt = nil // 撤销权限不设置过期时间
                return r.UpdatePermissionOverride(ctx, existingOverride)
        }</span>

        // 创建新的权限覆盖（撤销）
        <span class="cov8" title="1">override := &amp;models.UserPermissionOverride{
                UserID:     userID,
                Permission: permission,
                Granted:    false,
                GrantedBy:  revokedBy,
                Reason:     reason,
        }

        return r.CreatePermissionOverride(ctx, override)</span>
}

// CleanupExpiredOverrides 清理过期的权限覆盖
func (r *permissionRepository) CleanupExpiredOverrides(ctx context.Context) (int64, error) <span class="cov8" title="1">{
        now := time.Now()
        query := `DELETE FROM user_permission_overrides WHERE expires_at IS NOT NULL AND expires_at &lt; $1`

        result, err := r.getExecutor().ExecContext(ctx, query, now)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("清理过期权限覆盖失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取清理结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">return rowsAffected, nil</span>
}

// getActivePermissionOverride 获取用户的活跃权限覆盖
func (r *permissionRepository) getActivePermissionOverride(ctx context.Context, userID string, permission models.Permission) (*models.UserPermissionOverride, error) <span class="cov8" title="1">{
        var override models.UserPermissionOverride
        var permissionStr string

        now := time.Now()
        query := `
                SELECT id, user_id, permission, granted, granted_by, reason, expires_at, created_at, updated_at
                FROM user_permission_overrides 
                WHERE user_id = $1 AND permission = $2 AND deleted_at IS NULL AND (expires_at IS NULL OR expires_at &gt; $3)`

        err := r.getExecutor().QueryRowxContext(ctx, query, userID, string(permission), now).Scan(
                &amp;override.ID, &amp;override.UserID, &amp;permissionStr, &amp;override.Granted,
                &amp;override.GrantedBy, &amp;override.Reason, &amp;override.ExpiresAt,
                &amp;override.CreatedAt, &amp;override.UpdatedAt,
        )
        if err != nil </span><span class="cov8" title="1">{
                if err == sql.ErrNoRows </span><span class="cov8" title="1">{
                        return nil, nil // 没有找到活跃的权限覆盖
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取权限覆盖失败: %w", err)</span>
        }

        <span class="cov0" title="0">override.Permission = models.Permission(permissionStr)
        return &amp;override, nil</span>
}</pre>
		
		<pre class="file" id="file6" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "errors"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"

        "Pulse/internal/models"
)

type ruleRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewRuleRepository 创建规则仓储实例
func NewRuleRepository(db *sqlx.DB) RuleRepository <span class="cov0" title="0">{
        return &amp;ruleRepository{
                db: db,
        }
}</span>

// NewRuleRepositoryWithTx 创建带事务的规则仓储实例
func NewRuleRepositoryWithTx(tx *sqlx.Tx) RuleRepository <span class="cov0" title="0">{
        return &amp;ruleRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *ruleRepository) getExecutor() sqlx.ExtContext <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov0" title="0">return r.db</span>
}

// Create 创建规则
func (r *ruleRepository) Create(ctx context.Context, rule *models.Rule) error <span class="cov0" title="0">{
        // 生成ID
        rule.ID = uuid.New().String()
        rule.CreatedAt = time.Now()
        rule.UpdatedAt = rule.CreatedAt
        
        // 序列化标签和注解
        labelsJSON, err := json.Marshal(rule.Labels)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">annotationsJSON, err := json.Marshal(rule.Annotations)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化注解失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">conditionsJSON, err := json.Marshal(rule.Conditions)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化条件失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">actionsJSON, err := json.Marshal(rule.Actions)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化动作失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">query := `
                INSERT INTO rules (
                        id, name, description, type, severity, status, enabled, expression,
                        conditions, actions, labels, annotations, data_source_id,
                        evaluation_interval, for_duration, keep_firing_for, threshold,
                        recovery_threshold, no_data_state, exec_err_state,
                        created_by, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23
                )
        `
        
        _, err = r.getExecutor().ExecContext(ctx, query,
                rule.ID, rule.Name, rule.Description, rule.Type, rule.Severity,
                rule.Status, rule.Enabled, rule.Expression, string(conditionsJSON),
                string(actionsJSON), string(labelsJSON), string(annotationsJSON),
                rule.DataSourceID, rule.EvaluationInterval, rule.ForDuration,
                rule.KeepFiringFor, rule.Threshold, rule.RecoveryThreshold,
                rule.NoDataState, rule.ExecErrState, rule.CreatedBy,
                rule.CreatedAt, rule.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建规则失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetByID 根据ID获取规则
func (r *ruleRepository) GetByID(ctx context.Context, id string) (*models.Rule, error) <span class="cov0" title="0">{
        var rule models.Rule
        var labelsJSON, annotationsJSON, conditionsJSON, actionsJSON string

        query := `
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules 
                WHERE id = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON,
                &amp;actionsJSON, &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID,
                &amp;rule.EvaluationInterval, &amp;rule.ForDuration, &amp;rule.KeepFiringFor,
                &amp;rule.Threshold, &amp;rule.RecoveryThreshold, &amp;rule.NoDataState,
                &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("规则不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取规则失败: %w", err)</span>
        }

        // 反序列化条件
        <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化条件失败: %w", err)
                }</span>
        }

        // 反序列化动作
        <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化动作失败: %w", err)
                }</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        // 反序列化注解
        <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化注解失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;rule, nil</span>
}

// Update 更新规则
func (r *ruleRepository) Update(ctx context.Context, rule *models.Rule) error <span class="cov0" title="0">{
        rule.UpdatedAt = time.Now()

        // 序列化条件
        conditionsJSON, err := json.Marshal(rule.Conditions)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化条件失败: %w", err)
        }</span>

        // 序列化动作
        <span class="cov0" title="0">actionsJSON, err := json.Marshal(rule.Actions)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化动作失败: %w", err)
        }</span>

        // 序列化标签
        <span class="cov0" title="0">labelsJSON, err := json.Marshal(rule.Labels)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        // 序列化注解
        <span class="cov0" title="0">annotationsJSON, err := json.Marshal(rule.Annotations)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化注解失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE rules SET
                        name = $2,
                        description = $3,
                        type = $4,
                        severity = $5,
                        status = $6,
                        enabled = $7,
                        expression = $8,
                        conditions = $9,
                        actions = $10,
                        labels = $11,
                        annotations = $12,
                        data_source_id = $13,
                        evaluation_interval = $14,
                        for_duration = $15,
                        keep_firing_for = $16,
                        threshold = $17,
                        recovery_threshold = $18,
                        no_data_state = $19,
                        exec_err_state = $20,
                        updated_by = $21,
                        updated_at = $22
                WHERE id = $1 AND deleted_at IS NULL`

        _, err = r.getExecutor().ExecContext(ctx, query,
                rule.ID, rule.Name, rule.Description, rule.Type, rule.Severity,
                rule.Status, rule.Enabled, rule.Expression, string(conditionsJSON),
                string(actionsJSON), string(labelsJSON), string(annotationsJSON),
                rule.DataSourceID, rule.EvaluationInterval, rule.ForDuration,
                rule.KeepFiringFor, rule.Threshold, rule.RecoveryThreshold,
                rule.NoDataState, rule.ExecErrState, rule.UpdatedBy, rule.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新规则失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Delete 删除规则
func (r *ruleRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE rules 
                SET deleted_at = NOW() 
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除规则失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return models.ErrRuleNotFound
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// SoftDelete 软删除规则
func (r *ruleRepository) SoftDelete(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除规则失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// List 获取规则列表
func (r *ruleRepository) List(ctx context.Context, filter *models.RuleFilter) (*models.RuleList, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.DataSourceID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("data_source_id = $%d", argIndex))
                        args = append(args, *filter.DataSourceID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Severity != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("severity = $%d", argIndex))
                        args = append(args, *filter.Severity)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("(name ILIKE $%d OR description ILIKE $%d)", argIndex, argIndex))
                        args = append(args, "%"+*filter.Keyword+"%")
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM rules %s", whereClause)
        var total int64
        err := sqlx.GetContext(ctx, r.db, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取规则总数失败: %w", err)
        }</span>

        // 构建查询
        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules %s
                ORDER BY created_at DESC`, whereClause)

        // 添加分页
        if filter != nil &amp;&amp; filter.Page &gt; 0 &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                offset := (filter.Page - 1) * filter.PageSize
                query += fmt.Sprintf(" LIMIT $%d OFFSET $%d", argIndex, argIndex+1)
                args = append(args, filter.PageSize, offset)
        }</span>

        <span class="cov0" title="0">rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询规则列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var rules []*models.Rule
        for rows.Next() </span><span class="cov0" title="0">{
                var rule models.Rule
                var labelsJSON, annotationsJSON, conditionsJSON, actionsJSON string

                err := rows.Scan(
                        &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                        &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON,
                        &amp;actionsJSON, &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID,
                        &amp;rule.EvaluationInterval, &amp;rule.ForDuration, &amp;rule.KeepFiringFor,
                        &amp;rule.Threshold, &amp;rule.RecoveryThreshold, &amp;rule.NoDataState,
                        &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                        &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                        &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描规则数据失败: %w", err)
                }</span>

                // 反序列化条件
                <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化条件失败: %w", err)
                        }</span>
                }

                // 反序列化动作
                <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化动作失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化注解
                <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化注解失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">rules = append(rules, &amp;rule)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历规则数据失败: %w", err)
        }</span>

        // 计算分页信息
        <span class="cov0" title="0">var totalPages int64 = 1
        if filter != nil &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                totalPages = (total + int64(filter.PageSize) - 1) / int64(filter.PageSize)
        }</span>

        <span class="cov0" title="0">return &amp;models.RuleList{
                Rules:      rules,
                Total:      total,
                TotalPages: totalPages,
        }, nil</span>
}

// Count 获取规则总数
func (r *ruleRepository) Count(ctx context.Context, filter *models.RuleFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.DataSourceID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("data_source_id = $%d", argIndex))
                        args = append(args, *filter.DataSourceID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Enabled != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("enabled = $%d", argIndex))
                        args = append(args, *filter.Enabled)
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM rules %s", whereClause)
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取规则总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查规则是否存在
func (r *ruleRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM rules WHERE id = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查规则是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// Enable 启用规则
func (r *ruleRepository) Enable(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        enabled = true,
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, models.RuleStatusActive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("启用规则失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// Disable 禁用规则
func (r *ruleRepository) Disable(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        enabled = false,
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, models.RuleStatusInactive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("禁用规则失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// UpdateEvaluation 更新规则评估信息
func (r *ruleRepository) UpdateEvaluation(ctx context.Context, id string, lastEval, nextEval time.Time, count int64) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        last_eval_at = $1,
                        last_eval_result = $2,
                        eval_count = $3,
                        updated_at = $4
                WHERE id = $5 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, lastEval, "success", count, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新规则评估信息失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// GetByName 根据名称获取规则
func (r *ruleRepository) GetByName(ctx context.Context, name string) (*models.Rule, error) <span class="cov0" title="0">{
        var rule models.Rule
        var conditionsJSON, actionsJSON, labelsJSON, annotationsJSON string

        query := `
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules 
                WHERE name = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, name).Scan(
                &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON, &amp;actionsJSON,
                &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID, &amp;rule.EvaluationInterval,
                &amp;rule.ForDuration, &amp;rule.KeepFiringFor, &amp;rule.Threshold, &amp;rule.RecoveryThreshold,
                &amp;rule.NoDataState, &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, models.ErrRuleNotFound
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("根据名称获取规则失败: %w", err)</span>
        }

        // 反序列化条件
        <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化条件失败: %w", err)
                }</span>
        }

        // 反序列化动作
        <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化动作失败: %w", err)
                }</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        // 反序列化注解
        <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化注解失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;rule, nil</span>
}

// GetStats 获取规则统计信息
func (r *ruleRepository) GetStats(ctx context.Context, filter *models.RuleFilter) (*models.RuleStats, error) <span class="cov0" title="0">{
        query := `
                SELECT 
                        COUNT(*) as total,
                        COUNT(CASE WHEN status = 'active' THEN 1 END) as active,
                        COUNT(CASE WHEN status = 'inactive' THEN 1 END) as inactive,
                        COUNT(CASE WHEN status = 'disabled' THEN 1 END) as disabled
                FROM rules 
                WHERE deleted_at IS NULL
        `
        
        stats := &amp;models.RuleStats{
                ByType:     make(map[models.RuleType]int64),
                ByStatus:   make(map[models.RuleStatus]int64),
                BySeverity: make(map[models.AlertSeverity]int64),
        }
        
        var total, active, inactive, disabled int64
        err := r.getExecutor().QueryRowxContext(ctx, query).Scan(&amp;total, &amp;active, &amp;inactive, &amp;disabled)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>
        
        <span class="cov0" title="0">stats.Total = total
        stats.ActiveRules = active
        stats.Disabled = disabled
        
        return stats, nil</span>
}

// IncrementAlertCount 增加规则的告警计数
func (r *ruleRepository) IncrementAlertCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE rules 
                SET alert_count = alert_count + 1,
                        last_alert_at = NOW(),
                        updated_at = NOW()
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("规则不存在")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// IncrementEvaluationCount 增加规则的评估计数
func (r *ruleRepository) IncrementEvaluationCount(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE rules 
                SET evaluation_count = evaluation_count + 1,
                        last_eval_at = NOW(),
                        updated_at = NOW()
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("规则不存在")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// SetTesting 设置规则为测试状态
func (r *ruleRepository) SetTesting(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE rules 
                SET status = 'testing',
                        updated_at = NOW()
                WHERE id = $1 AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("规则不存在")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// TestRule 测试规则
func (r *ruleRepository) TestRule(ctx context.Context, rule *models.Rule) (*models.RuleTestResult, error) <span class="cov0" title="0">{
        start := time.Now()
        
        // 验证规则
        if err := rule.Validate(); err != nil </span><span class="cov0" title="0">{
                errorMsg := err.Error()
                return &amp;models.RuleTestResult{
                        Success:  false,
                        Error:    &amp;errorMsg,
                        EvalTime: time.Since(start),
                }, nil
        }</span>
        
        // 这里应该实际执行规则测试逻辑
        // 目前返回一个模拟的成功结果
        <span class="cov0" title="0">return &amp;models.RuleTestResult{
                Success:  true,
                Result:   "规则测试通过",
                EvalTime: time.Since(start),
                DataPoints: []map[string]interface{}{
                        {"timestamp": time.Now(), "value": 100},
                },
        }, nil</span>
}

// UpdateLastEvaluation 更新最后评估信息
func (r *ruleRepository) UpdateLastEvaluation(ctx context.Context, id string, evalTime time.Time, result bool, error string) error <span class="cov0" title="0">{
        query := `
                UPDATE rules 
                SET last_eval_at = $1,
                        last_eval_result = $2,
                        eval_count = eval_count + 1,
                        updated_at = NOW()
                WHERE id = $3 AND deleted_at IS NULL
        `
        
        // 将结果转换为字符串存储
        var resultStr string
        if result </span><span class="cov0" title="0">{
                if error == "" </span><span class="cov0" title="0">{
                        resultStr = "success"
                }</span> else<span class="cov0" title="0"> {
                        resultStr = "success_with_warning"
                }</span>
        } else<span class="cov0" title="0"> {
                if error == "" </span><span class="cov0" title="0">{
                        resultStr = "failed"
                }</span> else<span class="cov0" title="0"> {
                        resultStr = error
                }</span>
        }
        
        <span class="cov0" title="0">result_exec, err := r.getExecutor().ExecContext(ctx, query, evalTime, resultStr, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新规则评估信息失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result_exec.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取影响行数失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("规则不存在或已删除: %s", id)
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// GetActiveCount 获取活跃规则数量
func (r *ruleRepository) GetActiveCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        query := `SELECT COUNT(*) FROM rules WHERE enabled = true AND deleted_at IS NULL`
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取活跃规则数量失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count, nil</span>
}

// GetByDataSourceID 根据数据源ID获取规则列表
func (r *ruleRepository) GetByDataSourceID(ctx context.Context, dataSourceID string) ([]*models.Rule, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules 
                WHERE data_source_id = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC
        `
        
        rows, err := r.getExecutor().QueryContext(ctx, query, dataSourceID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询数据源规则失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()
        
        var rules []*models.Rule
        for rows.Next() </span><span class="cov0" title="0">{
                var rule models.Rule
                var labelsJSON, annotationsJSON, conditionsJSON, actionsJSON string
                
                err := rows.Scan(
                        &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                        &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON,
                        &amp;actionsJSON, &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID,
                        &amp;rule.EvaluationInterval, &amp;rule.ForDuration, &amp;rule.KeepFiringFor,
                        &amp;rule.Threshold, &amp;rule.RecoveryThreshold, &amp;rule.NoDataState,
                        &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                        &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                        &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描规则数据失败: %w", err)
                }</span>
                
                // 反序列化条件
                <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化条件失败: %w", err)
                        }</span>
                }
                
                // 反序列化动作
                <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化动作失败: %w", err)
                        }</span>
                }
                
                // 反序列化标签
                <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }
                
                // 反序列化注解
                <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化注解失败: %w", err)
                        }</span>
                }
                
                <span class="cov0" title="0">rules = append(rules, &amp;rule)</span>
        }
        
        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历规则数据失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">return rules, nil</span>
}

// GetErrorCount 获取错误规则数量
func (r *ruleRepository) GetErrorCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        query := `
                SELECT COUNT(*) 
                FROM rules 
                WHERE last_eval_result = false AND deleted_at IS NULL
        `
        
        var count int64
        err := r.getExecutor().QueryRowxContext(ctx, query).Scan(&amp;count)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("failed to get error count: %w", err)
        }</span>
        
        <span class="cov0" title="0">return count, nil</span>
}

// GetActiveRules 获取活跃规则列表
func (r *ruleRepository) GetActiveRules(ctx context.Context) ([]*models.Rule, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules 
                WHERE enabled = true AND status = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.getExecutor().QueryContext(ctx, query, models.RuleStatusActive)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取活跃规则失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var rules []*models.Rule
        for rows.Next() </span><span class="cov0" title="0">{
                var rule models.Rule
                var labelsJSON, annotationsJSON, conditionsJSON, actionsJSON string

                err := rows.Scan(
                        &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                        &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON,
                        &amp;actionsJSON, &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID,
                        &amp;rule.EvaluationInterval, &amp;rule.ForDuration, &amp;rule.KeepFiringFor,
                        &amp;rule.Threshold, &amp;rule.RecoveryThreshold, &amp;rule.NoDataState,
                        &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                        &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                        &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描规则数据失败: %w", err)
                }</span>

                // 反序列化条件
                <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化条件失败: %w", err)
                        }</span>
                }

                // 反序列化动作
                <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化动作失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化注解
                <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化注解失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">rules = append(rules, &amp;rule)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历规则数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return rules, nil</span>
}

// GetRulesForEvaluation 获取需要评估的规则列表
func (r *ruleRepository) GetRulesForEvaluation(ctx context.Context) ([]*models.Rule, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, severity, status, enabled, expression,
                       conditions, actions, labels, annotations, data_source_id,
                       evaluation_interval, for_duration, keep_firing_for, threshold,
                       recovery_threshold, no_data_state, exec_err_state,
                       last_eval_at, last_eval_result, eval_count, alert_count,
                       created_by, updated_by, created_at, updated_at
                FROM rules 
                WHERE enabled = true AND status = $1 AND deleted_at IS NULL
                  AND (last_eval_at IS NULL OR 
                       last_eval_at + evaluation_interval &lt;= CURRENT_TIMESTAMP)
                ORDER BY last_eval_at ASC NULLS FIRST`

        rows, err := r.db.QueryContext(ctx, query, models.RuleStatusActive)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取待评估规则列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var rules []*models.Rule
        for rows.Next() </span><span class="cov0" title="0">{
                var rule models.Rule
                var labelsJSON, annotationsJSON, conditionsJSON, actionsJSON string

                err := rows.Scan(
                        &amp;rule.ID, &amp;rule.Name, &amp;rule.Description, &amp;rule.Type, &amp;rule.Severity,
                        &amp;rule.Status, &amp;rule.Enabled, &amp;rule.Expression, &amp;conditionsJSON,
                        &amp;actionsJSON, &amp;labelsJSON, &amp;annotationsJSON, &amp;rule.DataSourceID,
                        &amp;rule.EvaluationInterval, &amp;rule.ForDuration, &amp;rule.KeepFiringFor,
                        &amp;rule.Threshold, &amp;rule.RecoveryThreshold, &amp;rule.NoDataState,
                        &amp;rule.ExecErrState, &amp;rule.LastEvalAt, &amp;rule.LastEvalResult,
                        &amp;rule.EvalCount, &amp;rule.AlertCount, &amp;rule.CreatedBy, &amp;rule.UpdatedBy,
                        &amp;rule.CreatedAt, &amp;rule.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描待评估规则失败: %w", err)
                }</span>

                // 反序列化条件
                <span class="cov0" title="0">if conditionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(conditionsJSON), &amp;rule.Conditions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化条件失败: %w", err)
                        }</span>
                }

                // 反序列化动作
                <span class="cov0" title="0">if actionsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(actionsJSON), &amp;rule.Actions)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化动作失败: %w", err)
                        }</span>
                }

                // 反序列化标签
                <span class="cov0" title="0">if labelsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(labelsJSON), &amp;rule.Labels)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化注解
                <span class="cov0" title="0">if annotationsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(annotationsJSON), &amp;rule.Annotations)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化注解失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">rules = append(rules, &amp;rule)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历待评估规则失败: %w", err)
        }</span>

        <span class="cov0" title="0">return rules, nil</span>
}

// BatchCreate 批量创建规则
func (r *ruleRepository) BatchCreate(ctx context.Context, rules []*models.Rule) error <span class="cov0" title="0">{
        if len(rules) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, rule := range rules </span><span class="cov0" title="0">{
                if rule.ID == "" </span><span class="cov0" title="0">{
                        rule.ID = uuid.New().String()
                }</span>

                <span class="cov0" title="0">now := time.Now()
                rule.CreatedAt = now
                rule.UpdatedAt = now

                if rule.Status == "" </span><span class="cov0" title="0">{
                        rule.Status = models.RuleStatusActive
                }</span>

                // 序列化条件、动作、标签和注解
                <span class="cov0" title="0">conditionsJSON, err := json.Marshal(rule.Conditions)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化条件失败: %w", err)
                }</span>

                <span class="cov0" title="0">actionsJSON, err := json.Marshal(rule.Actions)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化动作失败: %w", err)
                }</span>

                <span class="cov0" title="0">labelsJSON, err := json.Marshal(rule.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">annotationsJSON, err := json.Marshal(rule.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化注解失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        INSERT INTO rules (
                                id, name, description, type, severity, status, enabled, expression,
                                conditions, actions, labels, annotations, data_source_id,
                                evaluation_interval, for_duration, keep_firing_for, threshold,
                                recovery_threshold, no_data_state, exec_err_state,
                                created_by, created_at, updated_at
                        ) VALUES (
                                $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, $17, $18, $19, $20, $21, $22, $23
                        )`

                _, err = tx.ExecContext(ctx, query,
                        rule.ID, rule.Name, rule.Description, rule.Type, rule.Severity,
                        rule.Status, rule.Enabled, rule.Expression, string(conditionsJSON),
                        string(actionsJSON), string(labelsJSON), string(annotationsJSON), rule.DataSourceID,
                        rule.EvaluationInterval, rule.ForDuration, rule.KeepFiringFor,
                        rule.Threshold, rule.RecoveryThreshold, rule.NoDataState, rule.ExecErrState,
                        rule.CreatedBy, rule.CreatedAt, rule.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建规则失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// Activate 激活规则
func (r *ruleRepository) Activate(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        status = $1,
                        enabled = true,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.RuleStatusActive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("激活规则失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取激活结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("规则不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Deactivate 停用规则
func (r *ruleRepository) Deactivate(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE rules SET 
                        status = $1,
                        enabled = false,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, models.RuleStatusInactive, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("停用规则失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取停用结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("规则不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// BatchUpdate 批量更新规则
func (r *ruleRepository) BatchUpdate(ctx context.Context, rules []*models.Rule) error <span class="cov0" title="0">{
        if len(rules) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, rule := range rules </span><span class="cov0" title="0">{
                rule.UpdatedAt = time.Now()

                // 序列化条件、动作、标签和注解
                conditionsJSON, err := json.Marshal(rule.Conditions)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化条件失败: %w", err)
                }</span>

                <span class="cov0" title="0">actionsJSON, err := json.Marshal(rule.Actions)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化动作失败: %w", err)
                }</span>

                <span class="cov0" title="0">labelsJSON, err := json.Marshal(rule.Labels)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">annotationsJSON, err := json.Marshal(rule.Annotations)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化注解失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        UPDATE rules SET 
                                name = $1,
                                description = $2,
                                type = $3,
                                severity = $4,
                                status = $5,
                                enabled = $6,
                                expression = $7,
                                conditions = $8,
                                actions = $9,
                                labels = $10,
                                annotations = $11,
                                data_source_id = $12,
                                evaluation_interval = $13,
                                for_duration = $14,
                                keep_firing_for = $15,
                                threshold = $16,
                                recovery_threshold = $17,
                                no_data_state = $18,
                                exec_err_state = $19,
                                updated_by = $20,
                                updated_at = $21
                        WHERE id = $22 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query,
                        rule.Name, rule.Description, rule.Type, rule.Severity,
                        rule.Status, rule.Enabled, rule.Expression, string(conditionsJSON),
                        string(actionsJSON), string(labelsJSON), string(annotationsJSON), rule.DataSourceID,
                        rule.EvaluationInterval, rule.ForDuration, rule.KeepFiringFor,
                        rule.Threshold, rule.RecoveryThreshold, rule.NoDataState, rule.ExecErrState,
                        rule.UpdatedBy, rule.UpdatedAt, rule.ID,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新规则失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除规则
func (r *ruleRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE rules SET 
                                deleted_at = $1,
                                updated_at = $1
                        WHERE id = $2 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("删除规则 %s 失败: %w", id, err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchActivate 批量激活规则
func (r *ruleRepository) BatchActivate(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE rules SET 
                                status = $1,
                                enabled = true,
                                updated_at = $2
                        WHERE id = $3 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, models.RuleStatusActive, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("激活规则 %s 失败: %w", id, err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDeactivate 批量停用规则
func (r *ruleRepository) BatchDeactivate(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE rules SET 
                                status = $1,
                                enabled = false,
                                updated_at = $2
                        WHERE id = $3 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, models.RuleStatusInactive, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("停用规则 %s 失败: %w", id, err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}</pre>
		
		<pre class="file" id="file7" style="display: none">package repository

import (
        "context"
        "database/sql"
        "encoding/json"
        "errors"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"
        "github.com/lib/pq"

        "Pulse/internal/models"
)

type ticketRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewTicketRepository 创建工单仓储实例
func NewTicketRepository(db *sqlx.DB) TicketRepository <span class="cov0" title="0">{
        return &amp;ticketRepository{
                db: db,
        }
}</span>

// NewTicketRepositoryWithTx 创建带事务的工单仓储实例
func NewTicketRepositoryWithTx(tx *sqlx.Tx) TicketRepository <span class="cov0" title="0">{
        return &amp;ticketRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *ticketRepository) getExecutor() sqlx.ExtContext <span class="cov0" title="0">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov0" title="0">return r.db</span>
}

// Create 创建工单
func (r *ticketRepository) Create(ctx context.Context, ticket *models.Ticket) error <span class="cov0" title="0">{
        if ticket.ID == "" </span><span class="cov0" title="0">{
                ticket.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        ticket.CreatedAt = now
        ticket.UpdatedAt = now

        if ticket.Status == "" </span><span class="cov0" title="0">{
                ticket.Status = models.TicketStatusOpen
        }</span>

        <span class="cov0" title="0">if ticket.Priority == "" </span><span class="cov0" title="0">{
                ticket.Priority = models.TicketPriorityMedium
        }</span>

        // 序列化标签和自定义字段
        <span class="cov0" title="0">tagsJSON, err := json.Marshal(ticket.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">customFieldsJSON, err := json.Marshal(ticket.CustomFields)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化自定义字段失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO tickets (
                        id, title, description, status, priority, category, type, source,
                        reporter_id, assignee_id, tags, custom_fields, due_date, sla_deadline,
                        created_at, updated_at
                ) VALUES (
                        :id, :title, :description, :status, :priority, :category, :type, :source,
                        :reporter_id, :assignee_id, :tags, :custom_fields, :due_date, :sla_deadline,
                        :created_at, :updated_at
                )`

        _, err = sqlx.NamedExecContext(ctx, r.getExecutor(), query, map[string]interface{}{
                "id":            ticket.ID,
                "title":         ticket.Title,
                "description":   ticket.Description,
                "status":        ticket.Status,
                "priority":      ticket.Priority,
                "category":      ticket.Category,
                "type":          ticket.Type,
                "source":        ticket.Source,
                "reporter_id":   ticket.ReporterID,
                "assignee_id":   ticket.AssigneeID,
                "tags":          string(tagsJSON),
                "custom_fields": string(customFieldsJSON),
                "due_date":      ticket.DueDate,
                "sla_deadline":  ticket.SLADeadline,
                "created_at":    ticket.CreatedAt,
                "updated_at":    ticket.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建工单失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetByID 根据ID获取工单
func (r *ticketRepository) GetByID(ctx context.Context, id string) (*models.Ticket, error) <span class="cov0" title="0">{
        var ticket models.Ticket
        var tagsJSON, customFieldsJSON string

        query := `
                SELECT id, title, description, status, priority, category, type, source,
                       reporter_id, assignee_id, tags, custom_fields, due_date, sla_deadline,
                       resolved_at, closed_at, created_at, updated_at
                FROM tickets 
                WHERE id = $1 AND deleted_at IS NULL`

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;ticket.ID, &amp;ticket.Title, &amp;ticket.Description, &amp;ticket.Status, &amp;ticket.Priority,
                &amp;ticket.Category, &amp;ticket.Type, &amp;ticket.Source, &amp;ticket.ReporterID, &amp;ticket.AssigneeID,
                &amp;tagsJSON, &amp;customFieldsJSON, &amp;ticket.DueDate, &amp;ticket.SLADeadline,
                &amp;ticket.ResolvedAt, &amp;ticket.ClosedAt, &amp;ticket.CreatedAt, &amp;ticket.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("工单不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取工单失败: %w", err)</span>
        }

        // 反序列化标签
        <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(tagsJSON), &amp;ticket.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>
        }

        // 反序列化自定义字段
        <span class="cov0" title="0">if customFieldsJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(customFieldsJSON), &amp;ticket.CustomFields)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化自定义字段失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;ticket, nil</span>
}

// Update 更新工单
func (r *ticketRepository) Update(ctx context.Context, ticket *models.Ticket) error <span class="cov0" title="0">{
        ticket.UpdatedAt = time.Now()

        // 序列化标签和自定义字段
        tagsJSON, err := json.Marshal(ticket.Tags)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化标签失败: %w", err)
        }</span>

        <span class="cov0" title="0">customFieldsJSON, err := json.Marshal(ticket.CustomFields)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化自定义字段失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                UPDATE tickets SET 
                        title = :title,
                        description = :description,
                        status = :status,
                        priority = :priority,
                        category = :category,
                        type = :type,
                        source = :source,
                        assignee_id = :assignee_id,
                        tags = :tags,
                        custom_fields = :custom_fields,
                        due_date = :due_date,
                        sla_deadline = :sla_deadline,
                        resolved_at = :resolved_at,
                        closed_at = :closed_at,
                        updated_at = :updated_at
                WHERE id = :id AND deleted_at IS NULL`

        _, err = r.db.NamedExecContext(ctx, query, map[string]interface{}{
                "id":            ticket.ID,
                "title":         ticket.Title,
                "description":   ticket.Description,
                "status":        ticket.Status,
                "priority":      ticket.Priority,
                "category":      ticket.Category,
                "type":          ticket.Type,
                "source":        ticket.Source,
                "assignee_id":   ticket.AssigneeID,
                "tags":          string(tagsJSON),
                "custom_fields": string(customFieldsJSON),
                "due_date":      ticket.DueDate,
                "sla_deadline":  ticket.SLADeadline,
                "resolved_at":   ticket.ResolvedAt,
                "closed_at":     ticket.ClosedAt,
                "updated_at":    ticket.UpdatedAt,
        })

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新工单失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Delete 硬删除工单
func (r *ticketRepository) Delete(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `DELETE FROM tickets WHERE id = $1`
        _, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// SoftDelete 软删除工单
func (r *ticketRepository) SoftDelete(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        deleted_at = $1,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// List 获取工单列表
func (r *ticketRepository) List(ctx context.Context, filter *models.TicketFilter) (*models.TicketList, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Priority != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("priority = $%d", argIndex))
                        args = append(args, *filter.Priority)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Category != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("category = $%d", argIndex))
                        args = append(args, *filter.Category)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Type != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("type = $%d", argIndex))
                        args = append(args, *filter.Type)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Source != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("source = $%d", argIndex))
                        args = append(args, *filter.Source)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.ReporterID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("reporter_id = $%d", argIndex))
                        args = append(args, *filter.ReporterID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.AssigneeID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("assignee_id = $%d", argIndex))
                        args = append(args, *filter.AssigneeID)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("(title ILIKE $%d OR description ILIKE $%d)", argIndex, argIndex))
                        args = append(args, "%"+*filter.Keyword+"%")
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.CreatedStart != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("created_at &gt;= $%d", argIndex))
                        args = append(args, *filter.CreatedStart)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.CreatedEnd != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("created_at &lt;= $%d", argIndex))
                        args = append(args, *filter.CreatedEnd)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.DueDateStart != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("due_date &gt;= $%d", argIndex))
                        args = append(args, *filter.DueDateStart)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.DueDateEnd != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("due_date &lt;= $%d", argIndex))
                        args = append(args, *filter.DueDateEnd)
                        argIndex++
                }</span>



                <span class="cov0" title="0">if filter.Overdue != nil &amp;&amp; *filter.Overdue </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("due_date &lt; $%d AND status NOT IN ('resolved', 'closed')", argIndex))
                        args = append(args, time.Now())
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov0" title="0">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM tickets %s", whereClause)
        var total int64
        err := r.db.GetContext(ctx, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单总数失败: %w", err)
        }</span>

        // 构建查询
        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT id, title, description, status, priority, category, type, source,
                       reporter_id, assignee_id, tags, custom_fields, due_date, sla_deadline,
                       resolved_at, closed_at, created_at, updated_at
                FROM tickets %s
                ORDER BY created_at DESC`, whereClause)

        // 添加分页
        if filter != nil &amp;&amp; filter.Page &gt; 0 &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                offset := (filter.Page - 1) * filter.PageSize
                query += fmt.Sprintf(" LIMIT $%d OFFSET $%d", argIndex, argIndex+1)
                args = append(args, filter.PageSize, offset)
        }</span>

        <span class="cov0" title="0">rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询工单列表失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var tickets []*models.Ticket
        for rows.Next() </span><span class="cov0" title="0">{
                var ticket models.Ticket
                var tagsJSON, customFieldsJSON string

                err := rows.Scan(
                        &amp;ticket.ID, &amp;ticket.Title, &amp;ticket.Description, &amp;ticket.Status, &amp;ticket.Priority,
                        &amp;ticket.Category, &amp;ticket.Type, &amp;ticket.Source, &amp;ticket.ReporterID, &amp;ticket.AssigneeID,
                        &amp;tagsJSON, &amp;customFieldsJSON, &amp;ticket.DueDate, &amp;ticket.SLADeadline,
                        &amp;ticket.ResolvedAt, &amp;ticket.ClosedAt, &amp;ticket.CreatedAt, &amp;ticket.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描工单数据失败: %w", err)
                }</span>

                // 反序列化标签
                <span class="cov0" title="0">if tagsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(tagsJSON), &amp;ticket.Tags)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化标签失败: %w", err)
                        }</span>
                }

                // 反序列化自定义字段
                <span class="cov0" title="0">if customFieldsJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(customFieldsJSON), &amp;ticket.CustomFields)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化自定义字段失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">tickets = append(tickets, &amp;ticket)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历工单数据失败: %w", err)
        }</span>

        // 计算分页信息
        <span class="cov0" title="0">var totalPages int64 = 1
        if filter != nil &amp;&amp; filter.PageSize &gt; 0 </span><span class="cov0" title="0">{
                totalPages = (total + int64(filter.PageSize) - 1) / int64(filter.PageSize)
        }</span>

        <span class="cov0" title="0">return &amp;models.TicketList{
                Tickets:    tickets,
                Total:      total,
                TotalPages: int(totalPages),
        }, nil</span>
}

// Count 获取工单总数
func (r *ticketRepository) Count(ctx context.Context, filter *models.TicketFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Priority != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("priority = $%d", argIndex))
                        args = append(args, *filter.Priority)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.AssigneeID != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("assignee_id = $%d", argIndex))
                        args = append(args, *filter.AssigneeID)
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM tickets %s", whereClause)
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取工单总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查工单是否存在
func (r *ticketRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM tickets WHERE id = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查工单是否存在失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// UpdateStatus 更新工单状态
func (r *ticketRepository) UpdateStatus(ctx context.Context, id string, status models.TicketStatus) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, status, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新工单状态失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// UpdatePriority 更新工单优先级
func (r *ticketRepository) UpdatePriority(ctx context.Context, id string, priority models.TicketPriority) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        priority = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, priority, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新工单优先级失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// Assign 分配工单
func (r *ticketRepository) Assign(ctx context.Context, id string, assigneeID string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        assignee_id = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, assigneeID, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("分配工单失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Unassign 取消分配工单
func (r *ticketRepository) Unassign(ctx context.Context, id string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        assignee_id = NULL,
                        updated_at = $1
                WHERE id = $2 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("取消分配工单失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// Resolve 解决工单
func (r *ticketRepository) Resolve(ctx context.Context, id, resolverID string, solution *string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        status = $1,
                        resolved_at = $2,
                        resolution = $3,
                        updated_at = $2
                WHERE id = $4 AND deleted_at IS NULL`

        var resolutionText *string
        if solution != nil </span><span class="cov0" title="0">{
                resolutionText = solution
        }</span>

        <span class="cov0" title="0">_, err := r.getExecutor().ExecContext(ctx, query, models.TicketStatusResolved, now, resolutionText, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("解决工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// Close 关闭工单
func (r *ticketRepository) Close(ctx context.Context, id string, closerID string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        status = $1,
                        closed_at = $2,
                        closed_by = $3,
                        updated_at = $2
                WHERE id = $4 AND deleted_at IS NULL`

        _, err := r.db.ExecContext(ctx, query, models.TicketStatusClosed, now, closerID, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("关闭工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// Reopen 重新打开工单
func (r *ticketRepository) Reopen(ctx context.Context, id, reopenerID string) error <span class="cov0" title="0">{
        now := time.Now()
        query := `
                UPDATE tickets SET 
                        status = $1,
                        reopened_at = $2,
                        reopen_count = reopen_count + 1,
                        resolved_at = NULL,
                        closed_at = NULL,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        _, err := r.getExecutor().ExecContext(ctx, query, models.TicketStatusOpen, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("重新打开工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">return nil</span>
}

// AddComment 添加评论
func (r *ticketRepository) AddComment(ctx context.Context, comment *models.TicketComment) error <span class="cov0" title="0">{
        if comment.ID == "" </span><span class="cov0" title="0">{
                comment.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        comment.CreatedAt = now
        comment.UpdatedAt = now

        query := `
                INSERT INTO ticket_comments (
                        id, ticket_id, author_id, content, is_internal, created_at, updated_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                comment.ID, comment.TicketID, comment.AuthorID, comment.Content,
                comment.IsInternal, comment.CreatedAt, comment.UpdatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("添加评论失败: %w", err)
        }</span>

        // 更新工单的更新时间
        <span class="cov0" title="0">updateTicketQuery := `UPDATE tickets SET updated_at = $1 WHERE id = $2`
        _, err = r.db.ExecContext(ctx, updateTicketQuery, now, comment.TicketID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新工单时间失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetComments 获取工单评论
func (r *ticketRepository) GetComments(ctx context.Context, ticketID string) ([]*models.TicketComment, error) <span class="cov0" title="0">{
        query := `
                SELECT id, ticket_id, author_id, content, is_internal, created_at, updated_at
                FROM ticket_comments 
                WHERE ticket_id = $1 AND deleted_at IS NULL
                ORDER BY created_at ASC`

        rows, err := r.db.QueryContext(ctx, query, ticketID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单评论失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var comments []*models.TicketComment
        for rows.Next() </span><span class="cov0" title="0">{
                var comment models.TicketComment
                err := rows.Scan(
                        &amp;comment.ID, &amp;comment.TicketID, &amp;comment.AuthorID, &amp;comment.Content,
                        &amp;comment.IsInternal, &amp;comment.CreatedAt, &amp;comment.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描评论数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">comments = append(comments, &amp;comment)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历评论数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return comments, nil</span>
}

// UpdateComment 更新工单评论
func (r *ticketRepository) UpdateComment(ctx context.Context, comment *models.TicketComment) error <span class="cov0" title="0">{
        comment.UpdatedAt = time.Now()

        query := `
                UPDATE ticket_comments SET 
                        content = $1,
                        is_internal = $2,
                        updated_at = $3
                WHERE id = $4 AND deleted_at IS NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, 
                comment.Content, comment.IsInternal, comment.UpdatedAt, comment.ID)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新评论失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("评论不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// DeleteComment 删除工单评论
func (r *ticketRepository) DeleteComment(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE ticket_comments 
                SET deleted_at = NOW() 
                WHERE id = $1 AND deleted_at IS NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除评论失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("评论不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// AddAttachment 添加附件
func (r *ticketRepository) AddAttachment(ctx context.Context, attachment *models.TicketAttachment) error <span class="cov0" title="0">{
        if attachment.ID == "" </span><span class="cov0" title="0">{
                attachment.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        attachment.CreatedAt = now

        query := `
                INSERT INTO ticket_attachments (
                        id, ticket_id, filename, original_filename, file_path, file_size, mime_type, upload_by, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9
                )`

        _, err := r.getExecutor().ExecContext(ctx, query,
                attachment.ID, attachment.TicketID, attachment.Filename, attachment.OriginalFilename,
                attachment.FilePath, attachment.FileSize, attachment.MimeType, attachment.UploadBy, attachment.CreatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("添加附件失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetAttachments 获取工单附件
func (r *ticketRepository) GetAttachments(ctx context.Context, ticketID string) ([]*models.TicketAttachment, error) <span class="cov0" title="0">{
        query := `
                SELECT id, ticket_id, filename, original_filename, file_path, file_size, mime_type, upload_by, created_at
                FROM ticket_attachments 
                WHERE ticket_id = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, ticketID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单附件失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var attachments []*models.TicketAttachment
        for rows.Next() </span><span class="cov0" title="0">{
                var attachment models.TicketAttachment
                err := rows.Scan(
                        &amp;attachment.ID, &amp;attachment.TicketID, &amp;attachment.Filename, &amp;attachment.OriginalFilename,
                        &amp;attachment.FilePath, &amp;attachment.FileSize, &amp;attachment.MimeType, &amp;attachment.UploadBy, &amp;attachment.CreatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描附件数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">attachments = append(attachments, &amp;attachment)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历附件数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return attachments, nil</span>
}

// DeleteAttachment 删除工单附件
func (r *ticketRepository) DeleteAttachment(ctx context.Context, id string) error <span class="cov0" title="0">{
        query := `
                UPDATE ticket_attachments 
                SET deleted_at = NOW() 
                WHERE id = $1 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除附件失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("附件不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetHistory 获取工单历史
func (r *ticketRepository) GetHistory(ctx context.Context, ticketID string) ([]*models.TicketHistory, error) <span class="cov0" title="0">{
        query := `
                SELECT id, ticket_id, action, field, old_value, new_value, 
                       changes, user_id, user_name, comment, created_at
                FROM ticket_history 
                WHERE ticket_id = $1
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, ticketID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单历史失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var history []*models.TicketHistory
        for rows.Next() </span><span class="cov0" title="0">{
                var h models.TicketHistory
                var changesJSON string
                err := rows.Scan(
                        &amp;h.ID, &amp;h.TicketID, &amp;h.Action, &amp;h.Field,
                        &amp;h.OldValue, &amp;h.NewValue, &amp;changesJSON,
                        &amp;h.UserID, &amp;h.UserName, &amp;h.Comment, &amp;h.CreatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描历史数据失败: %w", err)
                }</span>

                // 反序列化变更详情
                <span class="cov0" title="0">if changesJSON != "" </span><span class="cov0" title="0">{
                        err = json.Unmarshal([]byte(changesJSON), &amp;h.Changes)
                        if err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化变更详情失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">history = append(history, &amp;h)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历历史数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return history, nil</span>
}

// BatchAssign 批量分配工单
func (r *ticketRepository) BatchAssign(ctx context.Context, ids []string, assigneeID string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return errors.New("工单ID列表不能为空")
        }</span>
        
        <span class="cov0" title="0">if strings.TrimSpace(assigneeID) == "" </span><span class="cov0" title="0">{
                return errors.New("分配人ID不能为空")
        }</span>
        
        <span class="cov0" title="0">query := `
                UPDATE tickets 
                SET assignee_id = $1,
                        status = CASE 
                                WHEN status = 'open' THEN 'assigned'
                                ELSE status
                        END,
                        updated_at = NOW()
                WHERE id = ANY($2) AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, assigneeID, pq.Array(ids))
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量分配工单失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("没有工单被分配")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// BatchUpdateStatus 批量更新工单状态
func (r *ticketRepository) BatchUpdateStatus(ctx context.Context, ids []string, status models.TicketStatus) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return errors.New("工单ID列表不能为空")
        }</span>
        
        <span class="cov0" title="0">if !status.IsValid() </span><span class="cov0" title="0">{
                return errors.New("无效的工单状态")
        }</span>
        
        <span class="cov0" title="0">query := `
                UPDATE tickets 
                SET status = $1,
                        updated_at = NOW()
                WHERE id = ANY($2) AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, string(status), pq.Array(ids))
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("批量更新工单状态失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return err
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("没有工单被更新")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// CleanupClosed 清理已关闭的工单
func (r *ticketRepository) CleanupClosed(ctx context.Context, before time.Time) (int64, error) <span class="cov0" title="0">{
        query := `
                DELETE FROM tickets 
                WHERE status = 'closed' 
                        AND updated_at &lt; $1
                        AND deleted_at IS NULL
        `
        
        result, err := r.db.ExecContext(ctx, query, before)
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return 0, err
        }</span>
        
        <span class="cov0" title="0">return rowsAffected, nil</span>
}

// GetStats 获取工单统计信息
func (r *ticketRepository) GetStats(ctx context.Context, filter *models.TicketFilter) (*models.TicketStats, error) <span class="cov0" title="0">{
        stats := &amp;models.TicketStats{
                ByStatus:   make(map[string]int64),
                ByPriority: make(map[string]int64),
                ByCategory: make(map[string]int64),
                ByType:     make(map[string]int64),
        }

        // 按状态统计
        statusQuery := `
                SELECT status, COUNT(*) 
                FROM tickets 
                WHERE deleted_at IS NULL 
                GROUP BY status`

        rows, err := r.db.QueryContext(ctx, statusQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按状态统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        for rows.Next() </span><span class="cov0" title="0">{
                var status string
                var count int64
                err := rows.Scan(&amp;status, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描状态统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">stats.ByStatus[status] = count
                stats.Total += count</span>
        }

        // 按优先级统计
        <span class="cov0" title="0">priorityQuery := `
                SELECT priority, COUNT(*) 
                FROM tickets 
                WHERE deleted_at IS NULL 
                GROUP BY priority`

        rows, err = r.db.QueryContext(ctx, priorityQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("按优先级统计失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        for rows.Next() </span><span class="cov0" title="0">{
                var priority string
                var count int64
                err := rows.Scan(&amp;priority, &amp;count)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描优先级统计失败: %w", err)
                }</span>
                <span class="cov0" title="0">stats.ByPriority[priority] = count</span>
        }

        // 计算其他统计指标
        // 获取未分配工单数
        <span class="cov0" title="0">unassignedQuery := `SELECT COUNT(*) FROM tickets WHERE assignee_id IS NULL AND deleted_at IS NULL`
        err = r.db.GetContext(ctx, &amp;stats.Unassigned, unassignedQuery)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取未分配工单数失败: %w", err)
        }</span>

        // 获取逾期工单数
        <span class="cov0" title="0">overdueQuery := `SELECT COUNT(*) FROM tickets WHERE due_date &lt; $1 AND status NOT IN ('resolved', 'closed') AND deleted_at IS NULL`
        err = r.db.GetContext(ctx, &amp;stats.Overdue, overdueQuery, time.Now())
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取逾期工单数失败: %w", err)
        }</span>

        // 获取即将到期工单数
        <span class="cov0" title="0">dueSoonQuery := `SELECT COUNT(*) FROM tickets WHERE due_date BETWEEN $1 AND $2 AND status NOT IN ('resolved', 'closed') AND deleted_at IS NULL`
        err = r.db.GetContext(ctx, &amp;stats.DueSoon, dueSoonQuery, time.Now(), time.Now().Add(24*time.Hour))
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取即将到期工单数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return stats, nil</span>
}

// GetSLAStatus 获取SLA状态
func (r *ticketRepository) GetSLAStatus(ctx context.Context, id string) (*models.TicketSLAStatusInfo, error) <span class="cov0" title="0">{
        ticket, err := r.GetByID(ctx, id)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单失败: %w", err)
        }</span>

        <span class="cov0" title="0">status := &amp;models.TicketSLAStatusInfo{
                TicketID: id,
        }

        if ticket.SLADeadline != nil </span><span class="cov0" title="0">{
                status.Deadline = *ticket.SLADeadline
                now := time.Now()

                if now.After(status.Deadline) </span><span class="cov0" title="0">{
                        status.Status = "breached"
                        status.TimeRemaining = 0
                        status.IsBreached = true
                }</span> else<span class="cov0" title="0"> {
                        status.TimeRemaining = status.Deadline.Sub(now)
                        if status.TimeRemaining &lt;= 2*time.Hour </span><span class="cov0" title="0">{
                                status.Status = "at_risk"
                        }</span> else<span class="cov0" title="0"> {
                                status.Status = "on_track"
                        }</span>
                }
        } else<span class="cov0" title="0"> {
                status.Status = "no_sla"
        }</span>

        <span class="cov0" title="0">return status, nil</span>
}

// UpdateSLA 更新工单SLA配置
func (r *ticketRepository) UpdateSLA(ctx context.Context, id string, sla *models.TicketSLA) error <span class="cov0" title="0">{
        now := time.Now()
        
        // 序列化SLA配置
        slaJSON, err := json.Marshal(sla)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化SLA配置失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">query := `
                UPDATE tickets SET 
                        sla = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, slaJSON, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新SLA配置失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>
        
        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return errors.New("工单不存在或已被删除")
        }</span>
        
        <span class="cov0" title="0">return nil</span>
}

// BatchCreate 批量创建工单
func (r *ticketRepository) BatchCreate(ctx context.Context, tickets []*models.Ticket) error <span class="cov0" title="0">{
        if len(tickets) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, ticket := range tickets </span><span class="cov0" title="0">{
                if ticket.ID == "" </span><span class="cov0" title="0">{
                        ticket.ID = uuid.New().String()
                }</span>

                <span class="cov0" title="0">now := time.Now()
                ticket.CreatedAt = now
                ticket.UpdatedAt = now

                if ticket.Status == "" </span><span class="cov0" title="0">{
                        ticket.Status = models.TicketStatusOpen
                }</span>

                <span class="cov0" title="0">if ticket.Priority == "" </span><span class="cov0" title="0">{
                        ticket.Priority = models.TicketPriorityMedium
                }</span>

                // 序列化标签和自定义字段
                <span class="cov0" title="0">tagsJSON, err := json.Marshal(ticket.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">customFieldsJSON, err := json.Marshal(ticket.CustomFields)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化自定义字段失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        INSERT INTO tickets (
                                id, title, description, status, priority, category, type, source,
                                reporter_id, assignee_id, tags, custom_fields, due_date, sla_deadline,
                                created_at, updated_at
                        ) VALUES (
                                $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16
                        )`

                _, err = tx.ExecContext(ctx, query,
                        ticket.ID, ticket.Title, ticket.Description, ticket.Status, ticket.Priority,
                        ticket.Category, ticket.Type, ticket.Source, ticket.ReporterID, ticket.AssigneeID,
                        string(tagsJSON), string(customFieldsJSON), ticket.DueDate, ticket.SLADeadline,
                        ticket.CreatedAt, ticket.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建工单失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchUpdate 批量更新工单
func (r *ticketRepository) BatchUpdate(ctx context.Context, tickets []*models.Ticket) error <span class="cov0" title="0">{
        if len(tickets) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, ticket := range tickets </span><span class="cov0" title="0">{
                ticket.UpdatedAt = time.Now()

                // 序列化标签和自定义字段
                tagsJSON, err := json.Marshal(ticket.Tags)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">customFieldsJSON, err := json.Marshal(ticket.CustomFields)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("序列化自定义字段失败: %w", err)
                }</span>

                <span class="cov0" title="0">query := `
                        UPDATE tickets SET 
                                title = $1,
                                description = $2,
                                status = $3,
                                priority = $4,
                                category = $5,
                                type = $6,
                                source = $7,
                                assignee_id = $8,
                                tags = $9,
                                custom_fields = $10,
                                due_date = $11,
                                sla_deadline = $12,
                                updated_at = $13
                        WHERE id = $14 AND deleted_at IS NULL`

                _, err = tx.ExecContext(ctx, query,
                        ticket.Title, ticket.Description, ticket.Status, ticket.Priority,
                        ticket.Category, ticket.Type, ticket.Source, ticket.AssigneeID,
                        string(tagsJSON), string(customFieldsJSON), ticket.DueDate, ticket.SLADeadline,
                        ticket.UpdatedAt, ticket.ID,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新工单失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除工单
func (r *ticketRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE tickets SET 
                                deleted_at = $1,
                                updated_at = $1
                        WHERE id = $2 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量删除工单失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// AddHistory 添加工单历史记录
func (r *ticketRepository) AddHistory(ctx context.Context, history *models.TicketHistory) error <span class="cov0" title="0">{
        if history.ID == "" </span><span class="cov0" title="0">{
                history.ID = uuid.New().String()
        }</span>

        <span class="cov0" title="0">now := time.Now()
        history.CreatedAt = now

        // 序列化变更详情
        changesJSON, err := json.Marshal(history.Changes)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("序列化变更详情失败: %w", err)
        }</span>

        <span class="cov0" title="0">query := `
                INSERT INTO ticket_history (
                        id, ticket_id, action, field, old_value, new_value, 
                        changes, user_id, user_name, comment, created_at
                ) VALUES (
                        $1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11
                )`

        _, err = r.getExecutor().ExecContext(ctx, query,
                history.ID, history.TicketID, history.Action, history.Field,
                history.OldValue, history.NewValue, string(changesJSON),
                history.UserID, history.UserName, history.Comment, history.CreatedAt,
        )

        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("添加工单历史记录失败: %w", err)
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// GetMyTickets 获取我的工单
func (r *ticketRepository) GetMyTickets(ctx context.Context, userID string, filter *models.TicketFilter) (*models.TicketList, error) <span class="cov0" title="0">{
        if filter == nil </span><span class="cov0" title="0">{
                filter = &amp;models.TicketFilter{}
        }</span>

        // 设置默认分页
        <span class="cov0" title="0">if filter.Page &lt;= 0 </span><span class="cov0" title="0">{
                filter.Page = 1
        }</span>
        <span class="cov0" title="0">if filter.PageSize &lt;= 0 </span><span class="cov0" title="0">{
                filter.PageSize = 20
        }</span>

        // 构建查询条件
        <span class="cov0" title="0">conditions := []string{"deleted_at IS NULL"}
        args := []interface{}{}
        argIndex := 1

        // 添加用户条件（分配给我的或我创建的）
        conditions = append(conditions, "(assignee_id = $"+fmt.Sprintf("%d", argIndex)+" OR reporter_id = $"+fmt.Sprintf("%d", argIndex)+")")
        args = append(args, userID)
        argIndex++

        // 添加其他过滤条件
        if filter.Status != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, "status = $"+fmt.Sprintf("%d", argIndex))
                args = append(args, *filter.Status)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Priority != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, "priority = $"+fmt.Sprintf("%d", argIndex))
                args = append(args, *filter.Priority)
                argIndex++
        }</span>

        <span class="cov0" title="0">if filter.Type != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, "type = $"+fmt.Sprintf("%d", argIndex))
                args = append(args, *filter.Type)
                argIndex++
        }</span>

        // 构建查询语句
        <span class="cov0" title="0">whereClause := "WHERE " + strings.Join(conditions, " AND ")

        // 计算总数
        countQuery := "SELECT COUNT(*) FROM tickets " + whereClause
        var total int64
        err := r.db.GetContext(ctx, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取工单总数失败: %w", err)
        }</span>

        // 构建排序
        <span class="cov0" title="0">orderBy := "ORDER BY created_at DESC"
        if filter.SortBy != nil </span><span class="cov0" title="0">{
                sortOrder := "DESC"
                if filter.SortOrder != nil &amp;&amp; strings.ToUpper(*filter.SortOrder) == "ASC" </span><span class="cov0" title="0">{
                        sortOrder = "ASC"
                }</span>
                <span class="cov0" title="0">orderBy = fmt.Sprintf("ORDER BY %s %s", *filter.SortBy, sortOrder)</span>
        }

        // 分页
        <span class="cov0" title="0">offset := (filter.Page - 1) * filter.PageSize
        limit := filter.PageSize

        // 查询数据
        query := `
                SELECT id, number, title, description, type, status, priority, severity, source,
                       category, subcategory, tags, labels, alert_id, rule_id, data_source_id,
                       reporter_id, reporter_name, assignee_id, assignee_name, team_id, team_name,
                       sla, sla_deadline, due_date, response_time, resolution_time,
                       first_response_at, resolved_at, closed_at, reopened_at, reopen_count,
                       comment_count, attachment_count, work_time, estimated_time, actual_time,
                       resolution, root_cause, workaround, impact, urgency, business_impact,
                       custom_fields, created_at, updated_at
                FROM tickets ` + whereClause + ` ` + orderBy + ` LIMIT $` + fmt.Sprintf("%d", argIndex) + ` OFFSET $` + fmt.Sprintf("%d", argIndex+1)

        args = append(args, limit, offset)

        rows, err := r.db.QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询我的工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var tickets []*models.Ticket
        for rows.Next() </span><span class="cov0" title="0">{
                var ticket models.Ticket
                var tagsJSON, labelsJSON, customFieldsJSON string
                var slaJSON sql.NullString

                err := rows.Scan(
                        &amp;ticket.ID, &amp;ticket.Number, &amp;ticket.Title, &amp;ticket.Description,
                        &amp;ticket.Type, &amp;ticket.Status, &amp;ticket.Priority, &amp;ticket.Severity, &amp;ticket.Source,
                        &amp;ticket.Category, &amp;ticket.Subcategory, &amp;tagsJSON, &amp;labelsJSON,
                        &amp;ticket.AlertID, &amp;ticket.RuleID, &amp;ticket.DataSourceID,
                        &amp;ticket.ReporterID, &amp;ticket.ReporterName, &amp;ticket.AssigneeID, &amp;ticket.AssigneeName,
                        &amp;ticket.TeamID, &amp;ticket.TeamName, &amp;slaJSON, &amp;ticket.SLADeadline, &amp;ticket.DueDate,
                        &amp;ticket.ResponseTime, &amp;ticket.ResolutionTime, &amp;ticket.FirstResponseAt,
                        &amp;ticket.ResolvedAt, &amp;ticket.ClosedAt, &amp;ticket.ReopenedAt, &amp;ticket.ReopenCount,
                        &amp;ticket.CommentCount, &amp;ticket.AttachmentCount, &amp;ticket.WorkTime,
                        &amp;ticket.EstimatedTime, &amp;ticket.ActualTime, &amp;ticket.Resolution, &amp;ticket.RootCause,
                        &amp;ticket.Workaround, &amp;ticket.Impact, &amp;ticket.Urgency, &amp;ticket.BusinessImpact,
                        &amp;customFieldsJSON, &amp;ticket.CreatedAt, &amp;ticket.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描工单数据失败: %w", err)
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if err := json.Unmarshal([]byte(tagsJSON), &amp;ticket.Tags); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">if err := json.Unmarshal([]byte(labelsJSON), &amp;ticket.Labels); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">if err := json.Unmarshal([]byte(customFieldsJSON), &amp;ticket.CustomFields); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化自定义字段失败: %w", err)
                }</span>

                <span class="cov0" title="0">if slaJSON.Valid </span><span class="cov0" title="0">{
                        if err := json.Unmarshal([]byte(slaJSON.String), &amp;ticket.SLA); err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化SLA失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">tickets = append(tickets, &amp;ticket)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历工单数据失败: %w", err)
        }</span>

        // 计算分页信息
        <span class="cov0" title="0">totalPages := int((total + int64(filter.PageSize) - 1) / int64(filter.PageSize))

        return &amp;models.TicketList{
                Tickets:     tickets,
                Total:       total,
                Page:        filter.Page,
                PageSize:    filter.PageSize,
                TotalPages:  totalPages,
                HasNext:     filter.Page &lt; totalPages,
                HasPrevious: filter.Page &gt; 1,
        }, nil</span>
}

// GetByAlertID 根据告警ID获取工单
func (r *ticketRepository) GetByAlertID(ctx context.Context, alertID string) ([]*models.Ticket, error) <span class="cov0" title="0">{
        query := `
                SELECT id, number, title, description, type, status, priority, severity, source,
                       category, subcategory, tags, labels, alert_id, rule_id, data_source_id,
                       reporter_id, reporter_name, assignee_id, assignee_name, team_id, team_name,
                       sla, sla_deadline, due_date, response_time, resolution_time,
                       first_response_at, resolved_at, closed_at, reopened_at, reopen_count,
                       comment_count, attachment_count, work_time, estimated_time, actual_time,
                       resolution, root_cause, workaround, impact, urgency, business_impact,
                       custom_fields, created_at, updated_at
                FROM tickets 
                WHERE alert_id = $1 AND deleted_at IS NULL
                ORDER BY created_at DESC`

        rows, err := r.db.QueryContext(ctx, query, alertID)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("根据告警ID查询工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var tickets []*models.Ticket
        for rows.Next() </span><span class="cov0" title="0">{
                var ticket models.Ticket
                var tagsJSON, labelsJSON, customFieldsJSON string
                var slaJSON sql.NullString

                err := rows.Scan(
                        &amp;ticket.ID, &amp;ticket.Number, &amp;ticket.Title, &amp;ticket.Description,
                        &amp;ticket.Type, &amp;ticket.Status, &amp;ticket.Priority, &amp;ticket.Severity, &amp;ticket.Source,
                        &amp;ticket.Category, &amp;ticket.Subcategory, &amp;tagsJSON, &amp;labelsJSON,
                        &amp;ticket.AlertID, &amp;ticket.RuleID, &amp;ticket.DataSourceID,
                        &amp;ticket.ReporterID, &amp;ticket.ReporterName, &amp;ticket.AssigneeID, &amp;ticket.AssigneeName,
                        &amp;ticket.TeamID, &amp;ticket.TeamName, &amp;slaJSON, &amp;ticket.SLADeadline, &amp;ticket.DueDate,
                        &amp;ticket.ResponseTime, &amp;ticket.ResolutionTime, &amp;ticket.FirstResponseAt,
                        &amp;ticket.ResolvedAt, &amp;ticket.ClosedAt, &amp;ticket.ReopenedAt, &amp;ticket.ReopenCount,
                        &amp;ticket.CommentCount, &amp;ticket.AttachmentCount, &amp;ticket.WorkTime,
                        &amp;ticket.EstimatedTime, &amp;ticket.ActualTime, &amp;ticket.Resolution, &amp;ticket.RootCause,
                        &amp;ticket.Workaround, &amp;ticket.Impact, &amp;ticket.Urgency, &amp;ticket.BusinessImpact,
                        &amp;customFieldsJSON, &amp;ticket.CreatedAt, &amp;ticket.UpdatedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描工单数据失败: %w", err)
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if err := json.Unmarshal([]byte(tagsJSON), &amp;ticket.Tags); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">if err := json.Unmarshal([]byte(labelsJSON), &amp;ticket.Labels); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化标签失败: %w", err)
                }</span>

                <span class="cov0" title="0">if err := json.Unmarshal([]byte(customFieldsJSON), &amp;ticket.CustomFields); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化自定义字段失败: %w", err)
                }</span>

                <span class="cov0" title="0">if slaJSON.Valid </span><span class="cov0" title="0">{
                        if err := json.Unmarshal([]byte(slaJSON.String), &amp;ticket.SLA); err != nil </span><span class="cov0" title="0">{
                                return nil, fmt.Errorf("反序列化SLA失败: %w", err)
                        }</span>
                }

                <span class="cov0" title="0">tickets = append(tickets, &amp;ticket)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历工单数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return tickets, nil</span>
}

// GetOpenCount 获取开放状态工单数量
func (r *ticketRepository) GetOpenCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        err := r.db.GetContext(ctx, &amp;count, `
                SELECT COUNT(*) 
                FROM tickets 
                WHERE status IN ('open', 'assigned', 'in_progress') 
                  AND deleted_at IS NULL
        `)
        return count, err
}</span>

// GetOverdueCount 获取逾期工单数量
func (r *ticketRepository) GetOverdueCount(ctx context.Context) (int64, error) <span class="cov0" title="0">{
        var count int64
        err := r.db.GetContext(ctx, &amp;count, `
                SELECT COUNT(*) 
                FROM tickets 
                WHERE due_date &lt; NOW() 
                  AND status NOT IN ('resolved', 'closed', 'cancelled') 
                  AND deleted_at IS NULL
        `)
        return count, err
}</span>

// GetOverdueSLA 获取SLA逾期的工单
func (r *ticketRepository) GetOverdueSLA(ctx context.Context) ([]*models.Ticket, error) <span class="cov0" title="0">{
        query := `
                SELECT id, number, title, description, type, status, priority, severity, source,
                       category, subcategory, tags, labels, alert_id, rule_id, data_source_id,
                       reporter_id, reporter_name, assignee_id, assignee_name, team_id, team_name,
                       sla, sla_deadline, due_date, response_time, resolution_time,
                       first_response_at, resolved_at, closed_at, reopened_at, reopen_count,
                       comment_count, attachment_count, work_time, estimated_time, actual_time,
                       resolution, root_cause, workaround, impact, urgency, business_impact,
                       custom_fields, created_at, updated_at, deleted_at
                FROM tickets 
                WHERE deleted_at IS NULL 
                  AND sla_deadline IS NOT NULL 
                  AND sla_deadline &lt; NOW() 
                  AND status NOT IN ('resolved', 'closed')
                ORDER BY sla_deadline ASC`

        rows, err := r.getExecutor().QueryContext(ctx, query)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取SLA逾期工单失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var tickets []*models.Ticket
        for rows.Next() </span><span class="cov0" title="0">{
                var ticket models.Ticket
                var tagsJSON, labelsJSON, customFieldsJSON string
                err := rows.Scan(
                        &amp;ticket.ID, &amp;ticket.Number, &amp;ticket.Title, &amp;ticket.Description,
                        &amp;ticket.Type, &amp;ticket.Status, &amp;ticket.Priority, &amp;ticket.Severity, &amp;ticket.Source,
                        &amp;ticket.Category, &amp;ticket.Subcategory, &amp;tagsJSON, &amp;labelsJSON,
                        &amp;ticket.AlertID, &amp;ticket.RuleID, &amp;ticket.DataSourceID,
                        &amp;ticket.ReporterID, &amp;ticket.ReporterName, &amp;ticket.AssigneeID, &amp;ticket.AssigneeName,
                        &amp;ticket.TeamID, &amp;ticket.TeamName, &amp;ticket.SLA, &amp;ticket.SLADeadline,
                        &amp;ticket.DueDate, &amp;ticket.ResponseTime, &amp;ticket.ResolutionTime,
                        &amp;ticket.FirstResponseAt, &amp;ticket.ResolvedAt, &amp;ticket.ClosedAt, &amp;ticket.ReopenedAt,
                        &amp;ticket.ReopenCount, &amp;ticket.CommentCount, &amp;ticket.AttachmentCount,
                        &amp;ticket.WorkTime, &amp;ticket.EstimatedTime, &amp;ticket.ActualTime,
                        &amp;ticket.Resolution, &amp;ticket.RootCause, &amp;ticket.Workaround,
                        &amp;ticket.Impact, &amp;ticket.Urgency, &amp;ticket.BusinessImpact,
                        &amp;customFieldsJSON, &amp;ticket.CreatedAt, &amp;ticket.UpdatedAt, &amp;ticket.DeletedAt,
                )
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描工单数据失败: %w", err)
                }</span>

                // 反序列化JSON字段
                <span class="cov0" title="0">if err := json.Unmarshal([]byte(tagsJSON), &amp;ticket.Tags); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化tags失败: %w", err)
                }</span>
                <span class="cov0" title="0">if err := json.Unmarshal([]byte(labelsJSON), &amp;ticket.Labels); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化labels失败: %w", err)
                }</span>
                <span class="cov0" title="0">if err := json.Unmarshal([]byte(customFieldsJSON), &amp;ticket.CustomFields); err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化custom_fields失败: %w", err)
                }</span>

                <span class="cov0" title="0">tickets = append(tickets, &amp;ticket)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历工单数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return tickets, nil</span>
}

// GetSLA 根据工单ID获取SLA配置
func (r *ticketRepository) GetSLA(ctx context.Context, id string) (*models.TicketSLA, error) <span class="cov0" title="0">{
        query := `
                SELECT id, name, description, type, priority, severity, response_time,
                       resolution_time, escalation_rules, business_hours, holidays,
                       enabled, created_by, updated_by, created_at, updated_at
                FROM ticket_slas 
                WHERE id = (
                        SELECT sla_id FROM tickets WHERE id = $1 AND deleted_at IS NULL
                ) AND deleted_at IS NULL`

        var sla models.TicketSLA
        var escalationRulesJSON, businessHoursJSON, holidaysJSON string

        err := r.getExecutor().QueryRowxContext(ctx, query, id).Scan(
                &amp;sla.ID, &amp;sla.Name, &amp;sla.Description, &amp;sla.Type, &amp;sla.Priority,
                &amp;sla.Severity, &amp;sla.ResponseTime, &amp;sla.ResolutionTime,
                &amp;escalationRulesJSON, &amp;businessHoursJSON, &amp;holidaysJSON,
                &amp;sla.Enabled, &amp;sla.CreatedBy, &amp;sla.UpdatedBy,
                &amp;sla.CreatedAt, &amp;sla.UpdatedAt,
        )
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("工单SLA不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("查询工单SLA失败: %w", err)</span>
        }

        // 反序列化JSON字段
        <span class="cov0" title="0">if escalationRulesJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(escalationRulesJSON), &amp;sla.EscalationRules)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化升级规则失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">if businessHoursJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(businessHoursJSON), &amp;sla.BusinessHours)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化工作时间失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">if holidaysJSON != "" </span><span class="cov0" title="0">{
                err = json.Unmarshal([]byte(holidaysJSON), &amp;sla.Holidays)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("反序列化节假日失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return &amp;sla, nil</span>
}

// GetTrend 获取工单趋势数据
func (r *ticketRepository) GetTrend(ctx context.Context, start, end time.Time, interval string) ([]*models.TicketTrendPoint, error) <span class="cov0" title="0">{
        conditions := []string{"deleted_at IS NULL", "created_at &gt;= $1", "created_at &lt;= $2"}
        args := []interface{}{start, end}

        whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 根据间隔类型构建时间分组
        <span class="cov0" title="0">var timeGroup string
        switch interval </span>{
        case "hour":<span class="cov0" title="0">
                timeGroup = "date_trunc('hour', created_at)"</span>
        case "day":<span class="cov0" title="0">
                timeGroup = "date_trunc('day', created_at)"</span>
        case "week":<span class="cov0" title="0">
                timeGroup = "date_trunc('week', created_at)"</span>
        case "month":<span class="cov0" title="0">
                timeGroup = "date_trunc('month', created_at)"</span>
        default:<span class="cov0" title="0">
                timeGroup = "date_trunc('day', created_at)"</span>
        }

        <span class="cov0" title="0">query := fmt.Sprintf(`
                SELECT 
                        %s as time_bucket,
                        COUNT(CASE WHEN status = 'open' OR status = 'in_progress' THEN 1 END) as created,
                        COUNT(CASE WHEN status = 'resolved' THEN 1 END) as resolved,
                        COUNT(CASE WHEN status = 'closed' THEN 1 END) as closed
                FROM tickets 
                %s
                GROUP BY time_bucket
                ORDER BY time_bucket ASC
        `, timeGroup, whereClause)

        rows, err := r.getExecutor().QueryContext(ctx, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("查询工单趋势失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer rows.Close()

        var points []*models.TicketTrendPoint
        for rows.Next() </span><span class="cov0" title="0">{
                var point models.TicketTrendPoint
                err := rows.Scan(&amp;point.Time, &amp;point.Created, &amp;point.Resolved, &amp;point.Closed)
                if err != nil </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("扫描趋势数据失败: %w", err)
                }</span>
                <span class="cov0" title="0">points = append(points, &amp;point)</span>
        }

        <span class="cov0" title="0">if err = rows.Err(); err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("遍历趋势数据失败: %w", err)
        }</span>

        <span class="cov0" title="0">return points, nil</span>
}</pre>
		
		<pre class="file" id="file8" style="display: none">package repository

import (
        "context"
        "database/sql"
        "fmt"
        "strings"
        "time"

        "github.com/google/uuid"
        "github.com/jmoiron/sqlx"
        "golang.org/x/crypto/bcrypt"

        "Pulse/internal/models"
)

// userRepository 用户仓储实现
type userRepository struct {
        db *sqlx.DB
        tx *sqlx.Tx
}

// NewUserRepository 创建用户仓储实例
func NewUserRepository(db *sqlx.DB) UserRepository <span class="cov8" title="1">{
        return &amp;userRepository{
                db: db,
        }
}</span>

// NewUserRepositoryWithTx 创建带事务的用户仓储实例
func NewUserRepositoryWithTx(tx *sqlx.Tx) UserRepository <span class="cov0" title="0">{
        return &amp;userRepository{
                tx: tx,
        }
}</span>

// getExecutor 获取数据库执行器（事务或普通连接）
func (r *userRepository) getExecutor() sqlx.ExtContext <span class="cov8" title="1">{
        if r.tx != nil </span><span class="cov0" title="0">{
                return r.tx
        }</span>
        <span class="cov8" title="1">return r.db</span>
}

// Create 创建用户
func (r *userRepository) Create(ctx context.Context, user *models.User) error <span class="cov8" title="1">{
        // 生成用户ID
        if user.ID == "" </span><span class="cov0" title="0">{
                user.ID = uuid.New().String()
        }</span>

        // 设置创建时间
        <span class="cov8" title="1">now := time.Now()
        user.CreatedAt = now
        user.UpdatedAt = now

        // 设置默认状态
        if user.Status == "" </span><span class="cov0" title="0">{
                user.Status = models.UserStatusInactive
        }</span>

        <span class="cov8" title="1">query := `
                INSERT INTO users (
                        id, username, email, password_hash, display_name, role, status,
                        phone, avatar, department, created_at, updated_at
                ) VALUES (
                        :id, :username, :email, :password_hash, :display_name, :role, :status,
                        :phone, :avatar, :department, :created_at, :updated_at
                )`

        _, err := sqlx.NamedExecContext(ctx, r.getExecutor(), query, user)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("创建用户失败: %w", err)
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// GetByID 根据ID获取用户
func (r *userRepository) GetByID(ctx context.Context, id string) (*models.User, error) <span class="cov8" title="1">{
        var user models.User
        query := `
                SELECT id, username, email, password_hash, display_name, role, status,
                       phone, avatar, department, last_login_at, created_at, updated_at, deleted_at
                FROM users 
                WHERE id = $1 AND deleted_at IS NULL`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;user, query, id)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("用户不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户失败: %w", err)</span>
        }

        <span class="cov8" title="1">return &amp;user, nil</span>
}

// GetByUsername 根据用户名获取用户
func (r *userRepository) GetByUsername(ctx context.Context, username string) (*models.User, error) <span class="cov8" title="1">{
        var user models.User
        query := `
                SELECT id, username, email, password_hash, display_name, role, status,
                       phone, avatar, department, last_login_at, created_at, updated_at, deleted_at
                FROM users 
                WHERE username = $1 AND deleted_at IS NULL`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;user, query, username)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("用户不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户失败: %w", err)</span>
        }

        <span class="cov8" title="1">return &amp;user, nil</span>
}

// GetByEmail 根据邮箱获取用户
func (r *userRepository) GetByEmail(ctx context.Context, email string) (*models.User, error) <span class="cov0" title="0">{
        var user models.User
        query := `
                SELECT id, username, email, password_hash, display_name, role, status,
                       phone, avatar, department, last_login_at, created_at, updated_at, deleted_at
                FROM users 
                WHERE email = $1 AND deleted_at IS NULL`

        err := sqlx.GetContext(ctx, r.getExecutor(), &amp;user, query, email)
        if err != nil </span><span class="cov0" title="0">{
                if err == sql.ErrNoRows </span><span class="cov0" title="0">{
                        return nil, fmt.Errorf("用户不存在")
                }</span>
                <span class="cov0" title="0">return nil, fmt.Errorf("获取用户失败: %w", err)</span>
        }

        <span class="cov0" title="0">return &amp;user, nil</span>
}

// Update 更新用户
func (r *userRepository) Update(ctx context.Context, user *models.User) error <span class="cov8" title="1">{
        user.UpdatedAt = time.Now()

        query := `
                UPDATE users SET 
                        username = :username,
                        email = :email,
                        password_hash = :password_hash,
                        display_name = :display_name,
                        role = :role,
                        status = :status,
                        phone = :phone,
                        avatar = :avatar,
                        department = :department,
                        last_login_at = :last_login_at,
                        updated_at = :updated_at
                WHERE id = :id AND deleted_at IS NULL`

        result, err := sqlx.NamedExecContext(ctx, r.getExecutor(), query, user)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新用户失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// Delete 硬删除用户
func (r *userRepository) Delete(ctx context.Context, id string) error <span class="cov8" title="1">{
        query := `DELETE FROM users WHERE id = $1`

        result, err := r.getExecutor().ExecContext(ctx, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("删除用户失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// SoftDelete 软删除用户
func (r *userRepository) SoftDelete(ctx context.Context, id string) error <span class="cov8" title="1">{
        now := time.Now()
        query := `
                UPDATE users SET 
                        deleted_at = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.getExecutor().ExecContext(ctx, query, now, now, id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("软删除用户失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取删除结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// List 获取用户列表
func (r *userRepository) List(ctx context.Context, filter *models.UserFilter) (*models.UserList, error) <span class="cov8" title="1">{
        if filter == nil </span><span class="cov0" title="0">{
                filter = &amp;models.UserFilter{Page: 1, PageSize: 20}
        }</span>

        // 设置默认值
        <span class="cov8" title="1">if filter.Page &lt;= 0 </span><span class="cov0" title="0">{
                filter.Page = 1
        }</span>
        <span class="cov8" title="1">if filter.PageSize &lt;= 0 </span><span class="cov0" title="0">{
                filter.PageSize = 20
        }</span>
        <span class="cov8" title="1">if filter.PageSize &gt; 100 </span><span class="cov0" title="0">{
                filter.PageSize = 100
        }</span>

        // 构建查询条件
        <span class="cov8" title="1">var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter.Role != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("role = $%d", argIndex))
                args = append(args, *filter.Role)
                argIndex++
        }</span>

        <span class="cov8" title="1">if filter.Status != nil </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                args = append(args, *filter.Status)
                argIndex++
        }</span>

        <span class="cov8" title="1">if filter.Department != nil &amp;&amp; *filter.Department != "" </span><span class="cov0" title="0">{
                conditions = append(conditions, fmt.Sprintf("department = $%d", argIndex))
                args = append(args, *filter.Department)
                argIndex++
        }</span>

        <span class="cov8" title="1">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                keyword := "%" + *filter.Keyword + "%"
                conditions = append(conditions, fmt.Sprintf("(username ILIKE $%d OR email ILIKE $%d OR display_name ILIKE $%d)", argIndex, argIndex, argIndex))
                args = append(args, keyword)
                argIndex++
        }</span>

        <span class="cov8" title="1">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov8" title="1">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        // 获取总数
        <span class="cov8" title="1">countQuery := fmt.Sprintf("SELECT COUNT(*) FROM users %s", whereClause)
        var total int64
        err := r.db.GetContext(ctx, &amp;total, countQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取用户总数失败: %w", err)
        }</span>

        // 获取用户列表
        <span class="cov8" title="1">offset := (filter.Page - 1) * filter.PageSize
        listQuery := fmt.Sprintf(`
                SELECT id, username, email, display_name, role, status,
                       phone, avatar, department, last_login_at, created_at, updated_at
                FROM users %s
                ORDER BY created_at DESC
                LIMIT $%d OFFSET $%d`, whereClause, argIndex, argIndex+1)

        args = append(args, filter.PageSize, offset)

        var users []*models.User
        err = r.db.SelectContext(ctx, &amp;users, listQuery, args...)
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("获取用户列表失败: %w", err)
        }</span>

        <span class="cov8" title="1">totalPages := int((total + int64(filter.PageSize) - 1) / int64(filter.PageSize))

        return &amp;models.UserList{
                Users:      users,
                Total:      total,
                Page:       filter.Page,
                PageSize:   filter.PageSize,
                TotalPages: totalPages,
        }, nil</span>
}

// Count 获取用户总数
func (r *userRepository) Count(ctx context.Context, filter *models.UserFilter) (int64, error) <span class="cov0" title="0">{
        var conditions []string
        var args []interface{}
        argIndex := 1

        conditions = append(conditions, "deleted_at IS NULL")

        if filter != nil </span><span class="cov0" title="0">{
                if filter.Role != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("role = $%d", argIndex))
                        args = append(args, *filter.Role)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Status != nil </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("status = $%d", argIndex))
                        args = append(args, *filter.Status)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Department != nil &amp;&amp; *filter.Department != "" </span><span class="cov0" title="0">{
                        conditions = append(conditions, fmt.Sprintf("department = $%d", argIndex))
                        args = append(args, *filter.Department)
                        argIndex++
                }</span>

                <span class="cov0" title="0">if filter.Keyword != nil &amp;&amp; *filter.Keyword != "" </span><span class="cov0" title="0">{
                        keyword := "%" + *filter.Keyword + "%"
                        conditions = append(conditions, fmt.Sprintf("(username ILIKE $%d OR email ILIKE $%d OR display_name ILIKE $%d)", argIndex, argIndex, argIndex))
                        args = append(args, keyword)
                        argIndex++
                }</span>
        }

        <span class="cov0" title="0">whereClause := ""
        if len(conditions) &gt; 0 </span><span class="cov0" title="0">{
                whereClause = "WHERE " + strings.Join(conditions, " AND ")
        }</span>

        <span class="cov0" title="0">query := fmt.Sprintf("SELECT COUNT(*) FROM users %s", whereClause)
        var count int64
        err := r.db.GetContext(ctx, &amp;count, query, args...)
        if err != nil </span><span class="cov0" title="0">{
                return 0, fmt.Errorf("获取用户总数失败: %w", err)
        }</span>

        <span class="cov0" title="0">return count, nil</span>
}

// Exists 检查用户是否存在
func (r *userRepository) Exists(ctx context.Context, id string) (bool, error) <span class="cov8" title="1">{
        var count int
        query := `SELECT COUNT(*) FROM users WHERE id = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, id)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查用户存在性失败: %w", err)
        }</span>
        <span class="cov8" title="1">return count &gt; 0, nil</span>
}

// ExistsByUsername 检查用户名是否存在
func (r *userRepository) ExistsByUsername(ctx context.Context, username string) (bool, error) <span class="cov8" title="1">{
        var count int
        query := `SELECT COUNT(*) FROM users WHERE username = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, username)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查用户名存在性失败: %w", err)
        }</span>
        <span class="cov8" title="1">return count &gt; 0, nil</span>
}

// ExistsByEmail 检查邮箱是否存在
func (r *userRepository) ExistsByEmail(ctx context.Context, email string) (bool, error) <span class="cov0" title="0">{
        var count int
        query := `SELECT COUNT(*) FROM users WHERE email = $1 AND deleted_at IS NULL`
        err := r.db.GetContext(ctx, &amp;count, query, email)
        if err != nil </span><span class="cov0" title="0">{
                return false, fmt.Errorf("检查邮箱存在性失败: %w", err)
        }</span>
        <span class="cov0" title="0">return count &gt; 0, nil</span>
}

// VerifyPassword 验证用户密码
func (r *userRepository) VerifyPassword(ctx context.Context, username, password string) (*models.User, error) <span class="cov8" title="1">{
        user, err := r.GetByUsername(ctx, username)
        if err != nil </span><span class="cov0" title="0">{
                return nil, err
        }</span>

        // 检查用户是否可以登录
        <span class="cov8" title="1">if !user.CanLogin() </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("用户账户已被禁用或锁定")
        }</span>

        // 验证密码
        <span class="cov8" title="1">err = bcrypt.CompareHashAndPassword([]byte(user.PasswordHash), []byte(password))
        if err != nil </span><span class="cov0" title="0">{
                return nil, fmt.Errorf("用户名或密码错误")
        }</span>

        <span class="cov8" title="1">return user, nil</span>
}

// UpdatePassword 更新用户密码
func (r *userRepository) UpdatePassword(ctx context.Context, id, hashedPassword string) error <span class="cov8" title="1">{
        query := `
                UPDATE users SET 
                        password_hash = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, hashedPassword, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新密码失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// UpdateLastLogin 更新最后登录时间
func (r *userRepository) UpdateLastLogin(ctx context.Context, id string, loginTime time.Time) error <span class="cov0" title="0">{
        query := `
                UPDATE users SET 
                        last_login_at = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, loginTime, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新最后登录时间失败: %w", err)
        }</span>

        <span class="cov0" title="0">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov0" title="0">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在或已被删除")
        }</span>

        <span class="cov0" title="0">return nil</span>
}

// UpdateStatus 更新用户状态
func (r *userRepository) UpdateStatus(ctx context.Context, id string, status models.UserStatus) error <span class="cov8" title="1">{
        query := `
                UPDATE users SET 
                        status = $1,
                        updated_at = $2
                WHERE id = $3 AND deleted_at IS NULL`

        result, err := r.db.ExecContext(ctx, query, status, time.Now(), id)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("更新用户状态失败: %w", err)
        }</span>

        <span class="cov8" title="1">rowsAffected, err := result.RowsAffected()
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("获取更新结果失败: %w", err)
        }</span>

        <span class="cov8" title="1">if rowsAffected == 0 </span><span class="cov0" title="0">{
                return fmt.Errorf("用户不存在或已被删除")
        }</span>

        <span class="cov8" title="1">return nil</span>
}

// Activate 激活用户
func (r *userRepository) Activate(ctx context.Context, id string) error <span class="cov8" title="1">{
        return r.UpdateStatus(ctx, id, models.UserStatusActive)
}</span>

// Deactivate 停用用户
func (r *userRepository) Deactivate(ctx context.Context, id string) error <span class="cov8" title="1">{
        return r.UpdateStatus(ctx, id, models.UserStatusInactive)
}</span>

// BatchCreate 批量创建用户
func (r *userRepository) BatchCreate(ctx context.Context, users []*models.User) error <span class="cov8" title="1">{
        if len(users) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov8" title="1">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov8" title="1">defer tx.Rollback()

        for _, user := range users </span><span class="cov8" title="1">{
                if user.ID == "" </span><span class="cov8" title="1">{
                        user.ID = uuid.New().String()
                }</span>

                <span class="cov8" title="1">now := time.Now()
                user.CreatedAt = now
                user.UpdatedAt = now

                if user.Status == "" </span><span class="cov8" title="1">{
                        user.Status = models.UserStatusInactive
                }</span>

                <span class="cov8" title="1">query := `
                        INSERT INTO users (
                                id, username, email, password_hash, display_name, role, status,
                                phone, avatar, department, created_at, updated_at
                        ) VALUES (
                                :id, :username, :email, :password_hash, :display_name, :role, :status,
                                :phone, :avatar, :department, :created_at, :updated_at
                        )`

                _, err := tx.NamedExecContext(ctx, query, user)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量创建用户失败: %w", err)
                }</span>
        }

        <span class="cov8" title="1">return tx.Commit()</span>
}

// BatchUpdate 批量更新用户
func (r *userRepository) BatchUpdate(ctx context.Context, users []*models.User) error <span class="cov0" title="0">{
        if len(users) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        for _, user := range users </span><span class="cov0" title="0">{
                user.UpdatedAt = time.Now()

                query := `
                        UPDATE users SET 
                                username = :username,
                                email = :email,
                                password_hash = :password_hash,
                                display_name = :display_name,
                                role = :role,
                                status = :status,
                                phone = :phone,
                                avatar = :avatar,
                                department = :department,
                                last_login_at = :last_login_at,
                                updated_at = :updated_at
                        WHERE id = :id AND deleted_at IS NULL`

                _, err := tx.NamedExecContext(ctx, query, user)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量更新用户失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// BatchDelete 批量删除用户
func (r *userRepository) BatchDelete(ctx context.Context, ids []string) error <span class="cov0" title="0">{
        if len(ids) == 0 </span><span class="cov0" title="0">{
                return nil
        }</span>

        <span class="cov0" title="0">tx, err := r.db.BeginTxx(ctx, nil)
        if err != nil </span><span class="cov0" title="0">{
                return fmt.Errorf("开始事务失败: %w", err)
        }</span>
        <span class="cov0" title="0">defer tx.Rollback()

        now := time.Now()
        for _, id := range ids </span><span class="cov0" title="0">{
                query := `
                        UPDATE users SET 
                                deleted_at = $1,
                                updated_at = $1
                        WHERE id = $2 AND deleted_at IS NULL`

                _, err := tx.ExecContext(ctx, query, now, id)
                if err != nil </span><span class="cov0" title="0">{
                        return fmt.Errorf("批量删除用户失败: %w", err)
                }</span>
        }

        <span class="cov0" title="0">return tx.Commit()</span>
}

// HashPassword 密码加密
func HashPassword(password string) (string, error) <span class="cov0" title="0">{
        hash, err := bcrypt.GenerateFromPassword([]byte(password), bcrypt.DefaultCost)
        if err != nil </span><span class="cov0" title="0">{
                return "", fmt.Errorf("密码加密失败: %w", err)
        }</span>
        <span class="cov0" title="0">return string(hash), nil</span>
}

// VerifyPasswordHash 验证密码哈希
func VerifyPasswordHash(password, hash string) error <span class="cov0" title="0">{
        return bcrypt.CompareHashAndPassword([]byte(hash), []byte(password))
}</pre>
		
		</div>
	</body>
	<script>
	(function() {
		var files = document.getElementById('files');
		var visible;
		files.addEventListener('change', onChange, false);
		function select(part) {
			if (visible)
				visible.style.display = 'none';
			visible = document.getElementById(part);
			if (!visible)
				return;
			files.value = part;
			visible.style.display = 'block';
			location.hash = part;
		}
		function onChange() {
			select(files.value);
			window.scrollTo(0, 0);
		}
		if (location.hash != "") {
			select(location.hash.substr(1));
		}
		if (!visible) {
			select("file0");
		}
	})();
	</script>
</html>
